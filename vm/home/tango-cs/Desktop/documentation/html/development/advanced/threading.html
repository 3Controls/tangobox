

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Threading &mdash; Tango Controls 9.2.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Tango Controls 9.2.5 documentation" href="../../index.html"/>
        <link rel="up" title="Advanced" href="index.html"/>
        <link rel="next" title="Transferring images" href="transferring-images.html"/>
        <link rel="prev" title="Advanced" href="index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../contents.html" class="icon icon-home"> Tango Controls
          

          
            
            <img src="../../_static/logo_tangocontrols_white.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                9.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to Tango Controls documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general-guidelines/index.html">General guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../corba.html">10 things you should know about CORBA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-api/index.html">Tango Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-api/index.html">Device Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging-and-testing/index.html">Debugging and Testing</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Advanced</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="transferring-images.html">Transferring images</a></li>
<li class="toctree-l3"><a class="reference internal" href="user-loop.html">Device server with user defined event loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="TangoDeviceServerModel.html">Tango Device Server Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="rest-api.html">Tango REST API</a></li>
<li class="toctree-l3"><a class="reference internal" href="IDL.html">The TANGO IDL file : Module Tango</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference.html">Reference part</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cpp-api/index.html">Tango Core C++ Classes Reference Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools-and-extensions/index.html">Tools and Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-howtos/index.html">Tutorials and How-Tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">Tango Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Advanced</a> &raquo;</li>
        
      <li>Threading</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/development/advanced/threading.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="threading">
<h1>Threading<a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h1>
<p>When used with C++, Tango used omniORB as underlying ORB. This CORBA
implementation is a threaded implementation and therefore a C++ Tango
device server or client are multi-threaded processes.</p>
<div class="section" id="device-server-process">
<h2>Device server process<a class="headerlink" href="#device-server-process" title="Permalink to this headline">¶</a></h2>
<p>A classical Tango device server without any connected clients has eight
threads. These threads are :</p>
<ul class="simple">
<li>The main thread waiting in the ORB main loop</li>
<li>Two ORB implementation threads (the POA thread)</li>
<li>The ORB scavanger thread</li>
<li>The signal thread</li>
<li>The heartbeat thread (needed by the Tango event system)</li>
<li>Two Zmq implementation threads</li>
</ul>
<p>On top of these eight threads, you have to add the thread(s) used by the
polling threads pool. This number depends on the polling thread pool
configuration and could be between 0 (no polling at all) and the maximun
number of threads in the pool.</p>
<p>A new thread is started for each connected client. Device server are
mostly used to interface hardware which most of the time does not
support multi-threaded access. Therefore, all remote calls executed from
a client are serialized within the device server code by using mutual
exclusion. See chapter [sub:Serialization-model-within] on which
serialization model are available. In order to limit thread number, the
underlying ORB (omniORB) is configured to shutdown threads dedicated to
client if the connection is inactive for more than 3 minutes. To also
limit thread number, the ORB is configured to create one thread per
connection up to 55 threads. When this level is reached, the threading
model is automatically switch to a thread pool model with up to 100
threads. If the number of threads decrease down to 50, the threading
model will return to thread per connection model.</p>
<p>If you are using event, the event system for its internal heartbeat
system periodically (every 200 seconds) sends a command to the device
server administration device. As explained above, a thread is created to
execute these command. The omniORB scavanger will terminate this thread
before the next event system heartbeat command arrives. For example, if
you have a device server with three connected clients using only event,
the process thread number will permanently change between 8 and 11
threads.</p>
<p>In summary, the number of threads in a device server process can be
evaluated with the following formula:</p>
<p><strong>8 + k + m</strong></p>
<p>k is the number of polling threads used from the polling threads pool
and m is the number of threads used for connected clients.</p>
<div class="section" id="serialization-model-within-a-device-server">
<h3>Serialization model within a device server<a class="headerlink" href="#serialization-model-within-a-device-server" title="Permalink to this headline">¶</a></h3>
<p>Four serialization models are available within a device server. These
models protect all requests coming from the network but also requests
coming from the polling thread. These models are:</p>
<ol class="arabic simple">
<li>Serialization by device. All access to the same device are
serialized. As an example, let’s take a device server implementing
one class of device with two instances (dev1 and dev2). Two clients
are connected to these devices (client1 and client2). Client2 will
not be able to access dev1 if client1 is using it. Nevertheless,
client2 is able to access dev2 while client1 access dev1 (There is
one mutual exclusion object by device)</li>
<li>Serialization by class. With non multi-threaded legacy software, the
preceding scenario could generate problem. In this mode of
serialization, client2 is not able to access dev2 while client1
access dev1 because dev2 and dev1 are instances of the same class
(There is one mutual exclusion object by class)</li>
<li>Serialization by process. This is one step further than the previous
case. In this mode, only one client can access any device embedded
within the device server at a time. There is only one mutual
exclusion object for the whole process)</li>
<li>No serialization. This is an exotic kind of serialization and
<strong>should be used with extreme care</strong> only with device which are fully
thread safe. In this model, most of the device access are not
serialized at all. Due to Tango internal structure, the
<em>get_attribute_config</em>, <em>set_attribute_config</em>,
<em>read_attributes</em> and <em>write_attributes</em> CORBA calls are still
protected. Reading the device state and status via commands or via
CORBA attribute is also protected.</li>
</ol>
<p>By default, every Tango device server is in serialization by device
mode. A method of the Tango::Util class allows to change this default
behavior.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span>  <span class="keyword type">int</span> <span class="name function">main</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">*</span><span class="name">argv</span><span class="punctuation">[])</span>
<span class="ln"> 4 </span>  <span class="punctuation">{</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>      <span class="keyword">try</span>
<span class="ln"> 7 </span>      <span class="punctuation">{</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>          <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">);</span>
<span class="ln">10 </span>
<span class="ln">11 </span>          <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">set_serial_model</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">BY_CLASS</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>          <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_init</span><span class="punctuation">();</span>
<span class="ln">14 </span>
<span class="ln">15 </span>          <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Ready to accept request&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">16 </span>          <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_run</span><span class="punctuation">();</span>
<span class="ln">17 </span>      <span class="punctuation">}</span>
<span class="ln">18 </span>      <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">19 </span>      <span class="punctuation">{</span>
<span class="ln">20 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Can't allocate memory!!!&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">21 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Exiting&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">22 </span>      <span class="punctuation">}</span>
<span class="ln">23 </span>      <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">Exception</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">24 </span>      <span class="punctuation">{</span>
<span class="ln">25 </span>           <span class="name">Tango</span><span class="operator">::</span><span class="name">Except</span><span class="operator">::</span><span class="name">print_exception</span><span class="punctuation">(</span><span class="name">e</span><span class="punctuation">);</span>
<span class="ln">26 </span>
<span class="ln">27 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Received a CORBA::Exception&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">28 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Exiting&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">29 </span>      <span class="punctuation">}</span>
<span class="ln">30 </span>
<span class="ln">31 </span>      <span class="keyword">return</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">);</span>
<span class="ln">32 </span>  <span class="punctuation">}</span>
</pre>
<p>The serialization model is set at line 11 before the server is
initialized and the infinite loop is started. See
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id1">[TangoRefMan]</a>  for all details on the methods to
set/get serialization model.</p>
</div>
<div class="section" id="attribute-serialization-model">
<h3>Attribute Serialization model<a class="headerlink" href="#attribute-serialization-model" title="Permalink to this headline">¶</a></h3>
<p>Even with the serialization model described previously, in case of
attributes carrying a large number of data and several clients reading
this attribute, a device attribute serialization has to be followed.
Without this level of serialization, for attribute using a shared
buffer, a thread scheduling may happens while the device server process
is in the CORBA layer transferring the attribute data on the network.
Three serialization models are available for attribute serialization.
The default is well adapted to nearly all cases. Nevertheless, if the
user code manages several attributes data buffer or if it manages its
own buffer protection by one way or another, it could be interesting to
tune this serialization level. The available models are:</p>
<ol class="arabic simple">
<li>Serialization by kernel. This is the default case. The kernel is
managing the serialization</li>
<li>Serialization by user. The user code is in charge of the
serialization. This serialization is done by the use of a omni_mutex
object. An omni_mutex is an object provided by the omniORB package.
It is the user responsability to lock this mutex when appropriate and
to give this mutex to the Tango kernel before leaving the attribute
read method</li>
<li>No serialization.</li>
</ol>
<p>By default, every Tango device attribute is in serialization by kernel.
Methods of the Tango::Attribute class allow to change the attribute
serialization behavior and to give the user omni_mutex object to the
kernel.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="keyword type">void</span> <span class="name">MyClass</span><span class="operator">::</span><span class="name">init_device</span><span class="punctuation">()</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span>    <span class="punctuation">...</span>
<span class="ln"> 4 </span>    <span class="punctuation">...</span>
<span class="ln"> 5 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">att</span> <span class="operator">=</span> <span class="name">dev_attr</span><span class="operator">-&gt;</span><span class="name">get_attr_by_name</span><span class="punctuation">(</span><span class="literal string">&quot;TheAttribute&quot;</span><span class="punctuation">);</span>
<span class="ln"> 6 </span>    <span class="name">att</span><span class="punctuation">.</span><span class="name">set_attr_serial_model</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">ATTR_BY_USER</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>    <span class="punctuation">....</span>
<span class="ln"> 8 </span>    <span class="punctuation">....</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span> <span class="punctuation">}</span>
<span class="ln">11 </span>
<span class="ln">12 </span>
<span class="ln">13 </span> <span class="keyword type">void</span> <span class="name">MyClass</span><span class="operator">::</span><span class="name">read_TheAttribute</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">attr</span><span class="punctuation">)</span>
<span class="ln">14 </span> <span class="punctuation">{</span>
<span class="ln">15 </span>    <span class="punctuation">....</span>
<span class="ln">16 </span>    <span class="punctuation">....</span>
<span class="ln">17 </span>    <span class="name">the_mutex</span><span class="punctuation">.</span><span class="name">lock</span><span class="punctuation">();</span>
<span class="ln">18 </span>    <span class="punctuation">....</span>
<span class="ln">19 </span>    <span class="comment single">// Fill the attribute buffer
</span><span class="ln">20 </span><span class="comment single"></span>    <span class="punctuation">....</span>
<span class="ln">21 </span>    <span class="name">attr</span><span class="punctuation">.</span><span class="name">set_value</span><span class="punctuation">(</span><span class="name">buffer</span><span class="punctuation">,....);</span>
<span class="ln">22 </span>    <span class="name">attr</span><span class="operator">-&gt;</span><span class="name">set_user_attr_mutex</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">the_mutex</span><span class="punctuation">);</span>
<span class="ln">23 </span> <span class="punctuation">}</span>
</pre>
<p>The serialization model is set at line 6 in the init_device() method.
The user omni_mutex is passed to the Tango kernel at line 22. This
omni_mutex object is a device data member. See
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id2">[TangoRefMan]</a>  for all details on the methods to set
attribute serialization model.</p>
</div>
</div>
<div class="section" id="client-process">
<h2>Client process<a class="headerlink" href="#client-process" title="Permalink to this headline">¶</a></h2>
<p>Clients are also multi threaded processes. The underlying C++ ORB
(omniORB) try to keep system resources to a minimum. To decrease process
file descriptors usage, each connection to server is automatically
closed if it is idle for more than 2 minutes and automatically re-opened
when needed. A dedicated thread is spawned by the ORB to manage this
automatic closing connection (the ORB scavenger thread).</p>
<p>Threrefore, a Tango client has two threads which are:</p>
<ol class="arabic simple">
<li>The main thread</li>
<li>The ORB scavanger thread</li>
</ol>
<p>If the client is using the event system and as Tango is using the event
push-push model, it has to be a server for receiving the events. This
increases the number of threads. The client now has 6 threads which are:</p>
<ul class="simple">
<li>The main thread</li>
<li>The ORB scavenger thread</li>
<li>Two Zmq implementation threads</li>
<li>Two Tango event system related threads (the KeepAliveThread and the
EventConsumer thread)</li>
</ul>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="transferring-images.html" class="btn btn-neutral float-right" title="Transferring images" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Advanced" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Tango Community, Creative Commons Attribution 4.0 International (CC BY 4.0).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'9.2.5',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>