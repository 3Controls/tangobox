

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a TANGO device server &mdash; Tango Controls 9.2.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Tango Controls 9.2.5 documentation" href="../../index.html"/>
        <link rel="up" title="Device Servers" href="index.html"/>
        <link rel="next" title="Attribute alarms" href="attribute-alarms.html"/>
        <link rel="prev" title="The TANGO device server model" href="device-server-model.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../contents.html" class="icon icon-home"> Tango Controls
          

          
            
            <img src="../../_static/logo_tangocontrols_white.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                9.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to Tango Controls documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general-guidelines/index.html">General guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../corba.html">10 things you should know about CORBA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-api/index.html">Tango Client</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Device Servers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">Introduction to device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="ds-guideline/index.html">TANGO Device Server Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-server-model.html">The TANGO device server model</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing a TANGO device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="attribute-alarms.html">Attribute alarms</a></li>
<li class="toctree-l3"><a class="reference internal" href="enumerated-attribute.html">Enumerated attribute</a></li>
<li class="toctree-l3"><a class="reference internal" href="memorized-attribute.html">Memorized attribute</a></li>
<li class="toctree-l3"><a class="reference internal" href="forwarded-attribute.html">Forwarded attribute</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-polling.html">Device polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="generating-events.html">Generating events in a device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="java/index.html">Tango Device in Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="python/index.html">PyTango - a Python binding to Tango</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debugging-and-testing/index.html">Debugging and Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpp-api/index.html">Tango Core C++ Classes Reference Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools-and-extensions/index.html">Tools and Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-howtos/index.html">Tutorials and How-Tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">Tango Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Device Servers</a> &raquo;</li>
        
      <li>Writing a TANGO device server</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/development/device-api/device-server-writing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-tango-device-server">
<h1>Writing a TANGO device server<a class="headerlink" href="#writing-a-tango-device-server" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-device-server-framework">
<h2>The device server framework<a class="headerlink" href="#the-device-server-framework" title="Permalink to this headline">¶</a></h2>
<p>This chapter will present the TANGO device server framework. It will
introduce what is the device server pattern and then it will describe a
complete device server framework. A definition of classes used by the
device server framework is given in this chapter. This manual is not
intended to give the complete and detailed description of classes data
member or methods, refer to <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id1">[TangoRefMan]</a> to get
this full description. But first, the naming convention used in this
project is detailed.</p>
<p>The aim of the class definition given in this chapter is only to help
the reader to understand how a TANGO device server works. For a detailed
description of these classes (and their methods), refer to chapter
[Writing_chapter] or to <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id2">[TangoRefMan]</a>.</p>
<div class="section" id="naming-convention-and-programming-language">
<h3>Naming convention and programming language<a class="headerlink" href="#naming-convention-and-programming-language" title="Permalink to this headline">¶</a></h3>
<p>TANGO fully supports three different programming languages which are
<strong>C++, Java</strong> and <strong>Python</strong>. This documentation focuses on C++ Tango
class. For Java and Python Tango class, have a look at the <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id3">[TangoRefMan]</a>
pages where similar chapter for Java and Python are available.</p>
<p>Every software project needs a naming convention. The naming convention
adopted for the TDSOM is very simple and only defines two guidelines
which are:</p>
<ul class="simple">
<li>Class names start with uppercase and use capitalization for compound
words (For instance MyClassName).</li>
<li>Method names are in lowercase and use underscores for compound words
(For instance my_method_name).</li>
</ul>
</div>
<div class="section" id="the-device-pattern">
<h3>The device pattern<a class="headerlink" href="#the-device-pattern" title="Permalink to this headline">¶</a></h3>
<p>Device server are written using the Device pattern. The aim of this
pattern is to provide the control programmer with a framework in which
s/he can develop new control objects. The device pattern uses other
design patterns like the Singleton and Command patterns. These patterns
are fully described in <a class="reference internal" href="../../reference/bibliography.html#patterns" id="id4">[Patterns]</a>. The device pattern
class diagram for stepper motor device is drawn in figure <a class="reference internal" href="#id5">6.1</a></p>
<div class="figure align-center" id="id67">
<span id="id5"></span><a class="reference internal image-reference" href="../../_images/device_et.png"><img alt="Device pattern class diagram" src="../../_images/device_et.png" style="width: 16cm;" /></a>
<p class="caption"><span class="caption-text">Figure 6.1: Device pattern class diagram</span></p>
</div>
<p>. In this figure, only classes surrounded with a dash line square are
device specific. All the other classes are part of the TDSOM core and
are developed by the Tango system team. Different kind of classes are
used by the device pattern.</p>
<ul class="simple">
<li>Three of them are root classes and it is only necessary to inherit
from them. These classes are the <strong>DeviceImpl</strong>, <strong>DeviceClass</strong> and
<strong>Command</strong> classes.</li>
<li>Classes necessary to implement commands. The TDSOM supports two ways
to create command : Using inheritance or using the template command
model. It is possible to mix model within the same device pattern<ol class="arabic">
<li>Using <strong>inheritance</strong>. This model of creating command heavily used
the polymorphism offered by each modern object oriented
programming language. In this schema, each command supported by a
device via the command_inout or command_inout_async operation
is implemented by a separate class. The Command class is the root
class for each of these classes. It is an abstract class. A
<em>execute</em> method must be defined in each sub-class. A
<em>is_allowed</em> method may also be re-defined in each class if the
default one does not fulfill all the needs <a class="footnote-reference" href="#id62" id="id6">[1]</a>. In our stepper
motor device server example, the DevReadPosition command follows
this model.</li>
<li>Using the <strong>template command</strong> model. Using this model, it is not
necessary to write one class for each command. You create one
instance of classes already defined in the TDSOM for each command.
The link between command name and method which need to be executed
is done through pointers to method. To support different kind of
command, four classes are part of the TDSOM. These classes are :<ol class="arabic">
<li>The <strong>TemplCommand</strong> class for command without input or output
parameter</li>
<li>The <strong>TemplCommandIn</strong> class for command with input parameter
but without output parameter</li>
<li>The <strong>TemplCommandOu</strong>t class for command with output
parameter but without input parameter</li>
<li>The <strong>TemplCommandInOut</strong> class for all the remaining commands</li>
</ol>
</li>
</ol>
</li>
<li>Classes necessary to implement TANGO device attributes. All these
classes are part of the TANGO core classes. These classes are the
<strong>MultiAttribute</strong>, <strong>Attribute</strong>, <strong>WAttribute</strong>, <strong>Attr</strong>,
<strong>SpectrumAttr</strong> and <strong>ImageAttr</strong> classes. The last three are used
to create user attribute. Each attribute supported by a device is
implemented by a separate class. The Attr class is the root class for
each of these classes. According to the attribute data format, the
user class implementing the attribute must inherit from the Attr,
SpectrumAttr or ImageAtttr class. SpectrumAttr class inherits from
Attr class and Image Attr class inherits from the SpectrumAttr class.
The Attr base class defined three methods called <em>is_allowed</em>,
<em>read</em> and <em>write</em>. These methods may be redefined in sub-classes in
order to implement the attribute specific behaviour.</li>
<li>The other are device specific. For stepper motor device, they are
named StepperMotor, StepperMotorClass and DevReadPosition.</li>
</ul>
<div class="section" id="the-tango-base-class-deviceimpl-class">
<h4>The Tango base class (DeviceImpl class)<a class="headerlink" href="#the-tango-base-class-deviceimpl-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="description">
<h5>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h5>
<p>This class is the device root class and is the link between the Device
pattern and CORBA. It inherits from CORBA classes and implements all the
methods needed to execute CORBA operations and attributes. For instance,
its method <em>command_inout</em> is executed when a client requests a
command_inout operation. The method <em>name</em> of the DeviceImpl class is
executed when a client requests the name CORBA attribute. This class
also encapsulates some key device data like its name, its state, its
status, its black box…. This class is an abstract class and cannot be
instantiated as is.</p>
</div>
<div class="section" id="contents">
<h5>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h5>
<p>The contents of this class can be summarized as :</p>
<ul class="simple">
<li>Different constructors and one destructor</li>
<li>Methods to access instance data members outside the class or its
derivate classes. These methods are necessary because data members
are declared as protected.</li>
<li>Methods triggered by CORBA attribute request</li>
<li>Methods triggered by CORBA operation request</li>
<li>The <em>init_device()</em> method. This method makes the class abstract. It
should be implemented by a sub-class. It is used by the inherited
classes constructors.</li>
<li>Methods triggered by the automatically added State and Status
commands. These methods are declared virtual and therefore can be
redefined in sub-classes. These two commands are automatically added
to the list of commands defined for a class of devices. They are
discussed in chapter [Auto_cmd]</li>
<li>A method called <em>always_executed_hook()</em> always executed for each
command before the device state is tested for command execution. This
method gives the programmer a hook where he(she) can program some
mandatory action which must be done before any command execution. An
example of the such action is an hardware access to the device to
read its real hardware state.</li>
<li>A method called <em>read_attr_hardware()</em> triggered by the
read_attributes CORBA operation. This method is called once for each
read_attributes call. This method is virtual and may be redefined in
sub-classes.</li>
<li>A method called <em>write_attr_hardware()</em> triggered by the
write_attributes CORBA operation. This method is called once for
each write_attributes call. This method is virtual and may be
redefined in sub-classes.</li>
<li>Methods for signal management (C++ specific)</li>
<li>Data members like the device name, the device status, the device
state</li>
<li>Some private methods and data members</li>
</ul>
</div>
</div>
<div class="section" id="the-dbdevice-class">
<h4>The DbDevice class<a class="headerlink" href="#the-dbdevice-class" title="Permalink to this headline">¶</a></h4>
<p>Each DeviceImpl instance is an aggregate with one instance of the
DbDevice class. This DbDevice class can be used to query or modify
device properties. It provides an easy to use interface for device
objects in the database. The description of this class can be found in
the Tango API reference documentation available on the Tango WEB pages.</p>
</div>
<div class="section" id="the-command-class">
<h4>The Command class<a class="headerlink" href="#the-command-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="description-of-the-inheritance-model">
<h5>Description of the inheritance model<a class="headerlink" href="#description-of-the-inheritance-model" title="Permalink to this headline">¶</a></h5>
<p>Within the TDSOM, each command supported by a device and implemented
using the inheritance model is implemented by a separate class. The
Command class is the root class for each of these classes. It is an
abstract class. It stores the command name, the command argument types
and description and mainly defines two methods which are the <em>execute</em>
and <em>is_allowed</em> methods. The <em>execute</em> method should be implemented in
each sub-class. A default <em>is_allowed</em> method exists for command always
allowed. A command also stores a parameter which is the command display
type. It is also used to select if the command must be displayed
according to the application mode (every day operation or expert mode).</p>
</div>
<div class="section" id="description-of-the-template-model">
<h5>Description of the template model<a class="headerlink" href="#description-of-the-template-model" title="Permalink to this headline">¶</a></h5>
<p>Using this method, it is not necessary to create a separate class for
each device command. In this method, each command is represented by an
instance of one of the template command classes. They are four template
command classes. All these classes inherits from the Command class.
These four classes are :</p>
<ol class="arabic simple">
<li>The <strong>TemplCommand</strong> class. One object of this class must be created
for each command without input nor output parameters</li>
<li>The <strong>TemplCommandIn</strong> class. One object of this class must be
created for each command without output parameter but with input
parameter</li>
<li>The <strong>TemplCommandOut</strong> class. One object of this class must be
created for each command without input parameter but with output
parameter</li>
<li>The <strong>TemplCommandInOut</strong> class. One object of this class must be
created for each command with input and output parameters</li>
</ol>
<p>These four classes redefine the <em>execute</em> and <em>is_allowed</em> method of
the Command class. These classes provides constructors which allow the
user to :</p>
<ul class="simple">
<li>specify which method must be executed by these classes <em>execute</em>
method</li>
<li>optionally specify which method must be executed by these classes
<em>is_allowed</em> method.</li>
</ul>
<p>The method specification is done via pointer to method.</p>
<p>Remember that it is possible to mix command implementation method within
the same device pattern.</p>
</div>
<div class="section" id="id7">
<h5>Contents<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<p>The content of this class can be summarizes as :</p>
<ul class="simple">
<li>Class constructors and destructor</li>
<li>Declaration of the <em>execute</em> method</li>
<li>Declaration of the <em>is_allowed</em> method</li>
<li>Methods to read/set class data members</li>
<li>Methods to extract data from the object used to transfer data on the
network</li>
<li>Methods to insert data into the object used to transfer data on the
network</li>
<li>Class data members like command name, command input data type,
command input data description…</li>
</ul>
</div>
</div>
<div class="section" id="the-deviceclass-class">
<h4>The DeviceClass class<a class="headerlink" href="#the-deviceclass-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id8">
<h5>Description<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<p>This class implements all what is specific for a controlled object
class. For instance, every device of the same class supports the same
list of commands and therefore, this list of available commands is
stored in this DeviceClass. The structure returned by the info operation
contains a documentation URL <a class="footnote-reference" href="#id63" id="id9">[2]</a>. This documentation URL is the same
for every device of the same class. Therefore, the documentation URL is
a data member of this class. There should have only one instance of this
class per device pattern implementation. The device list is also stored
in this class. It is an abstract class because the two methods
<em>device_factory()</em> and <em>command_factory()</em> are declared as pure
virtual. The rule of the <em>device_factory()</em> method is to create all the
devices belonging to the device class. The rule of the
<em>command_factory()</em> method is to create one instance of all the classes
needed to support device commands. This class also stored the
<em>attribute_factory</em> method. The rule of this method is to store in a
vector of strings, the name of all the device attributes. This method
has a default implementation which is an empty body for device without
attribute.</p>
</div>
<div class="section" id="id10">
<h5>Contents<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<p>The contents of this class can be summarize as :</p>
<ul class="simple">
<li>The <em>command_handler</em> method</li>
<li>Methods to access data members.</li>
<li>Signal related method (C++ specific)</li>
<li>Class constructor. It is protected to implements the Singleton
pattern</li>
<li>Class data members like the class command list, the device list…</li>
</ul>
</div>
</div>
<div class="section" id="the-dbclass-class">
<h4>The DbClass class<a class="headerlink" href="#the-dbclass-class" title="Permalink to this headline">¶</a></h4>
<p>Each DeviceClass instance is an aggregate with one instance of the
DbClass class. This DbClass class can be used to query or modify class
properties. It provides an easy to use interface for device objects in
the database. The description of this class can be found in the
reference Tango C++ API documentation available in the Tango WEB pages.</p>
</div>
<div class="section" id="the-multiattribute-class">
<h4>The MultiAttribute class<a class="headerlink" href="#the-multiattribute-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id11">
<h5>Description<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<p>This class is a container for all the TANGO attributes defined for the
device. There is one instance of this class for each device. This class
is mainly an aggregate of Attribute object(s). It has been developed to
ease TANGO attribute management.</p>
</div>
<div class="section" id="id12">
<h5>Contents<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<p>The class contents could be summarizes as :</p>
<ul class="simple">
<li>Miscellaneous methods to retrieve one attribute object in the
aggregate</li>
<li>Method to retrieve a list of attribute with an alarm level defined</li>
<li>Get attribute number method</li>
<li>Miscellaneous methods to check if an attribute value is outside the
authorized limits</li>
<li>Method to add messages for all attribute with an alarm set</li>
<li>Data members with the attribute list</li>
</ul>
</div>
</div>
<div class="section" id="the-attribute-class">
<h4>The Attribute class<a class="headerlink" href="#the-attribute-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id13">
<h5>Description<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<p>There is one object of this class for each device attribute. This class
is used to store all the attribute properties, the attribute value and
all the alarm related data. Like commands, this class also stores th
attribute display type. It is foreseen to be used by future Tango
graphical application toolkit to select if the attribute must be
displayed according to the application mode (every day operation or
expert mode).</p>
</div>
<div class="section" id="id14">
<h5>Contents<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Miscellaneous method to get boolean attribute information</li>
<li>Methods to access some data members</li>
<li>Methods to get/set attribute properties</li>
<li>Method to check if the attribute is in alarm condition</li>
<li>Methods related to attribute data</li>
<li>Friend function to print attribute properties</li>
<li>Data members (properties value and attribute data)</li>
</ul>
</div>
</div>
<div class="section" id="the-wattribute-class">
<h4>The WAttribute class<a class="headerlink" href="#the-wattribute-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id15">
<h5>Description<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<p>This class inherits from the Attribute class. There is one instance of
this class for each writable device attribute. On top of all the data
already managed by the Attribute class, this class stores the attribute
set value.</p>
</div>
<div class="section" id="id16">
<h5>Contents<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<p>Within this class, you will mainly find methods related to attribute set
value storage and some data members.</p>
</div>
</div>
<div class="section" id="the-attr-class">
<h4>The Attr class<a class="headerlink" href="#the-attr-class" title="Permalink to this headline">¶</a></h4>
<p>Within the TDSOM, each attribute supported by a device is implemented by
a separate class. The Attr class is the root class for each of these
classes. It is used in conjonction with the Attribute and Wattribute
classes to implement Tango attribute behaviour. It defines three methods
which are the <em>is_allowed, read</em> and <em>write</em> methods. A default
<em>is_allowed</em> method exists for attribute always allowed. Default <em>read</em>
and <em>write</em> empty methods are defined. For readable attribute, it is
necessary to overwrite the <em>read</em> method. For writable attribute, it is
necessary to overwrite the <em>write</em> method and for read and write
attribute, both methods must be overwritten.</p>
</div>
<div class="section" id="the-spectrumattr-class">
<h4>The SpectrumAttr class<a class="headerlink" href="#the-spectrumattr-class" title="Permalink to this headline">¶</a></h4>
<p>This class inherits from the Attr class. It is the base class for user
spectrum attribute. It is used in conjonction with the Attribute and
WAttribute class to implement Tango spectrum attribute behaviour. From
the Attr class, it inherits the Attr <em>is_allowed</em>, <em>read</em> and <em>write</em>
methods.</p>
</div>
<div class="section" id="the-imageattr-class">
<h4>The ImageAttr class<a class="headerlink" href="#the-imageattr-class" title="Permalink to this headline">¶</a></h4>
<p>This class inherits from the SpectrumAttr class. It is the base class
for user image attribute. It is used in conjonction with the Attribute
and WAttribute class to implement Tango image attribute behaviour. From
the Attr class, it inherits the Attr <em>is_allowed</em>, <em>read</em> and <em>write</em>
methods.</p>
</div>
<div class="section" id="the-steppermotor-class">
<h4>The StepperMotor class<a class="headerlink" href="#the-steppermotor-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id17">
<h5>Description<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<p>This class inherits from the DeviceImpl class and is the class
implementing the controlled object behavior. Each command will trigger a
method in this class written by the device server programmer and
specific to the object to be controlled. This class also stores all the
device specific data.</p>
</div>
<div class="section" id="definition">
<h5>Definition<a class="headerlink" href="#definition" title="Permalink to this headline">¶</a></h5>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="keyword">class</span> <span class="name class">StepperMotor</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">TANGO_BASE_CLASS</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span> <span class="keyword">public</span> <span class="operator">:</span>
<span class="ln"> 4 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="name">string</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln"> 6 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>    <span class="operator">~</span><span class="name">StepperMotor</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>    <span class="name">DevLong</span> <span class="name function">dev_read_position</span><span class="punctuation">(</span><span class="name">DevLong</span><span class="punctuation">);</span>
<span class="ln">10 </span>   <span class="name">DevLong</span> <span class="name function">dev_read_direction</span><span class="punctuation">(</span><span class="name">DevLong</span><span class="punctuation">);</span>
<span class="ln">11 </span>   <span class="keyword type">bool</span> <span class="name function">direct_cmd_allowed</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>   <span class="keyword">virtual</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevState</span> <span class="name">dev_state</span><span class="punctuation">();</span>
<span class="ln">14 </span>   <span class="keyword">virtual</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ConstDevString</span> <span class="name">dev_status</span><span class="punctuation">();</span>
<span class="ln">15 </span>
<span class="ln">16 </span>   <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">always_executed_hook</span><span class="punctuation">();</span>
<span class="ln">17 </span>
<span class="ln">18 </span>   <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">read_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">);</span>
<span class="ln">19 </span>   <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">write_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">);</span>
<span class="ln">20 </span>
<span class="ln">21 </span>   <span class="keyword type">void</span> <span class="name function">read_position</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">22 </span>   <span class="keyword type">bool</span> <span class="name function">is_Position_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">AttReqType</span> <span class="name">req</span><span class="punctuation">);</span>
<span class="ln">23 </span>   <span class="keyword type">void</span> <span class="name function">write_SetPosition</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">WAttribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">24 </span>   <span class="keyword type">void</span> <span class="name function">read_Direction</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">25 </span>
<span class="ln">26 </span>   <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">init_device</span><span class="punctuation">();</span>
<span class="ln">27 </span>   <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">delete_device</span><span class="punctuation">();</span>
<span class="ln">28 </span>
<span class="ln">29 </span>   <span class="keyword type">void</span> <span class="name function">get_device_properties</span><span class="punctuation">();</span>
<span class="ln">30 </span>
<span class="ln">31 </span> <span class="keyword">protected</span> <span class="operator">:</span>
<span class="ln">32 </span>   <span class="keyword type">long</span> <span class="name">axis</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">33 </span>   <span class="name">DevLong</span> <span class="name">position</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">34 </span>   <span class="name">DevLong</span> <span class="name">direction</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">35 </span>   <span class="keyword type">long</span> <span class="name">state</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">36 </span>
<span class="ln">37 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">attr_Position_read</span><span class="punctuation">;</span>
<span class="ln">38 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">attr_Direction_read</span><span class="punctuation">;</span>
<span class="ln">39 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">attr_SetPosition_write</span><span class="punctuation">;</span>
<span class="ln">40 </span>
<span class="ln">41 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">min</span><span class="punctuation">;</span>
<span class="ln">42 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">max</span><span class="punctuation">;</span>
<span class="ln">43 </span>
<span class="ln">44 </span>   <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">ptr</span><span class="punctuation">;</span>
<span class="ln">45 </span> <span class="punctuation">};</span>
<span class="ln">46 </span>
<span class="ln">47 </span> <span class="punctuation">}</span> <span class="comment multiline">/* End of StepperMotor namespace */</span>
</pre>
<p>Line 1 : The StepperMotor class inherits from the DeviceImpl class</p>
<p>Line 4-7 : Class constructors and destructor</p>
<p>Line 9 : Method triggered by the DevReadPosition command</p>
<p>Line 10-11 : Methods triggered by the DevReadDirection command</p>
<p>Line 13 : Redefinition of the <em>dev_state</em> method of the DeviceImpl
class. This method will be triggered by the State command</p>
<p>Line 14 : Redefinition of the <em>dev_statu</em>s method of the DeviceImpl
class. This method will be triggered by the Status command</p>
<p>Line 16 : Redefinition of the <em>always_executed_hook</em> method.</p>
<p>Line 26 : Definition of the <em>init_device</em> method (declared as pure
virtual by the DeviceImpl class)</p>
<p>Line 27 : Definition of the <em>delete_device</em> method</p>
<p>Line 31-45 : Device data</p>
</div>
</div>
<div class="section" id="the-steppermotorclass-class">
<h4>The StepperMotorClass class<a class="headerlink" href="#the-steppermotorclass-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id18">
<h5>Description<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<p>This class inherits from the DeviceClass class. Like the DeviceClass
class, there should be only one instance of the StepperMotorClass. This
is ensured because this class is written following the Singleton pattern
as defined in <a class="reference internal" href="../../reference/bibliography.html#patterns" id="id19">[Patterns]</a>. All controlled object class
data which should be defined only once per class must be stored in this
object.</p>
</div>
<div class="section" id="id20">
<h5>Definition<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h5>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="keyword">class</span> <span class="name class">StepperMotorClass</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name">DeviceClass</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span>   <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 4 </span>     <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="error">\</span><span class="operator">*</span><span class="name">init</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="error">\</span><span class="operator">*</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>     <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="error">\</span><span class="operator">*</span><span class="name">instance</span><span class="punctuation">();</span>
<span class="ln"> 6 </span>     <span class="operator">~</span><span class="name">StepperMotorClass</span><span class="punctuation">()</span> <span class="punctuation">{</span><span class="error">\</span><span class="name">_instance</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;}</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>   <span class="keyword">protected</span><span class="operator">:</span>
<span class="ln"> 9 </span>     <span class="name">StepperMotorClass</span><span class="punctuation">(</span><span class="name">string</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">10 </span>     <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="error">\</span><span class="operator">*</span><span class="error">\</span><span class="name">_instance</span><span class="punctuation">;</span>
<span class="ln">11 </span>     <span class="keyword type">void</span> <span class="name">command</span><span class="error">\</span><span class="name">_factory</span><span class="punctuation">();</span>
<span class="ln">12 </span>
<span class="ln">13 </span>   <span class="keyword">private</span><span class="operator">:</span>
<span class="ln">14 </span>     <span class="keyword type">void</span> <span class="name">device</span><span class="error">\</span><span class="name">_factory</span><span class="punctuation">(</span><span class="name">Tango</span><span class="error">\</span><span class="name">_DevVarStringArray</span> <span class="error">\</span><span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">15 </span> <span class="punctuation">};</span>
</pre>
<p>Line 1 : This class is a sub-class of the DeviceClass class</p>
<p>Line 4-5 and 9-10: Methods and data member necessary for the Singleton
pattern</p>
<p>Line 6 : Class destructor</p>
<p>Line 11 : Definition of the <em>command_factory</em> method declared as pure
virtual in the DeviceClass call</p>
<p>Line 13-14 : Definition of the <em>device_factory</em> method declared as pure
virtual in the DeviceClass class</p>
</div>
</div>
<div class="section" id="the-devreadposition-class">
<h4>The DevReadPosition class<a class="headerlink" href="#the-devreadposition-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id21">
<h5>Description<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h5>
<p>This is the class for the DevReadPosition command. This class implements
the <em>execute</em> and <em>is_allowed</em> methods defined by the Command class.
This class is necessary because this command is implemented using the
inheritance model.</p>
</div>
<div class="section" id="id22">
<h5>Definition<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h5>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword">class</span> <span class="name class">DevReadPositionCmd</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name">Command</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 4 </span>      <span class="name">DevReadPositionCmd</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span><span class="name">Tango_CmdArgType</span><span class="punctuation">,</span> <span class="name">Tango_CmdArgType</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">char</span><span class="operator">*</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>      <span class="operator">~</span><span class="name">DevReadPositionCmd</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>      <span class="keyword">virtual</span> <span class="keyword type">bool</span> <span class="name function">is_allowed</span> <span class="punctuation">(</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>      <span class="keyword">virtual</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">execute</span> <span class="punctuation">(</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>  <span class="punctuation">};</span>
</pre>
<p>Line 1 : The class is a sub class of the Command class</p>
<p>Line 4-5 : Class constructor and destructor</p>
<p>Line 7-8 : Definition of the <em>is_allowed</em> and <em>execute</em> method declared
as pure virtual in the Command class.</p>
</div>
</div>
<div class="section" id="the-positionattr-class">
<h4>The PositionAttr class<a class="headerlink" href="#the-positionattr-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id23">
<h5>Description<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h5>
<p>This is the class for the Position attribute. This attribute is a scalar
attribute and therefore inherits from the Attr base class. This class
implements the <em>read</em> and <em>is_allowed</em> methods defined by the Attr
class.</p>
</div>
<div class="section" id="id24">
<h5>Definition<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h5>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword">class</span> <span class="name class">PositionAttr</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 4 </span>     <span class="name">PositionAttr</span><span class="punctuation">()</span><span class="operator">:</span><span class="name">Attr</span><span class="punctuation">(</span><span class="literal string">&quot;Position&quot;</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_LONG</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">READ</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>     <span class="operator">~</span><span class="name">PositionAttr</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>     <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">read</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">att</span><span class="punctuation">)</span>
<span class="ln"> 8 </span>     <span class="punctuation">{(</span><span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">StepperMotor</span> <span class="operator">*&gt;</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">))</span><span class="operator">-&gt;</span><span class="name">read_Position</span><span class="punctuation">(</span><span class="name">att</span><span class="punctuation">);}</span>
<span class="ln"> 9 </span>     <span class="keyword">virtual</span> <span class="keyword type">bool</span> <span class="name function">is_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">AttReqType</span> <span class="name">ty</span><span class="punctuation">)</span>
<span class="ln">10 </span>     <span class="punctuation">{</span><span class="keyword">return</span> <span class="punctuation">(</span><span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">StepperMotor</span> <span class="operator">*&gt;</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">))</span><span class="operator">-&gt;</span><span class="name">is_Position_allowed</span><span class="punctuation">(</span><span class="name">ty</span><span class="punctuation">);}</span>
<span class="ln">11 </span>  <span class="punctuation">};</span>
</pre>
<p>Line 1 : The class is a sub class of the Attr class</p>
<p>Line 4-5 : Class constructor and destructor</p>
<p>Line 7 : Re-definition of the <em>read</em> method defined in the Attr class.
This is simply a forward to the <em>read_Position</em> method of the
StepperMotor class</p>
<p>Line 9 : Re-definition of the <em>is_allowed</em> method defined in the Attr
class. This is also a forward to the <em>is_Position_allowed</em> method of
the StepperMotor class</p>
</div>
</div>
</div>
<div class="section" id="startup-of-a-device-pattern">
<h3>Startup of a device pattern<a class="headerlink" href="#startup-of-a-device-pattern" title="Permalink to this headline">¶</a></h3>
<p>To start the device pattern implementation for stepper motor device,
four methods of the StepperMotorClass class must be executed. These
methods are :</p>
<ol class="arabic simple">
<li>The creation of the StepperMethodClass singleton via its <em>init</em>()
method</li>
<li>The <em>command_factory</em>() method of the StepperMotorClass class</li>
<li>The <em>attribute_factory</em>() method of the StepperMotorClass class.
This method has a default empty body for device class without
attributes.</li>
<li>The <em>device_factory</em>() method of the StepperMotorClass class</li>
</ol>
<p>This startup procedure is described in figure <a class="reference internal" href="#id25">6.2</a></p>
<div class="figure align-center" id="id68">
<span id="id25"></span><img alt="Device pattern startup sequence" src="../../_images/startup.jpg" />
<p class="caption"><span class="caption-text">Figure 6.2: Device pattern startup sequence</span></p>
</div>
<p>. The creation of the StepperMotorClass will automatically create an
instance of the DeviceClass class. The constructor of the DeviceClass
class will create the Status, State and Init command objects and store
them in its command list.</p>
<p>The <em>command_factory</em>() method will simply create all the user
defined commands and add them in the command list.</p>
<p>The <em>attribute_factory</em>() method will simply build a list of device
attribute names.</p>
<p>The <em>device_factory</em>() method will create each StepperMotor object
and store them in the StepperMotorClass instance device list. The list
of devices to be created and their names is passed to the
<em>device_factory</em> method in its input argument. StepperMotor is a
sub-class of DeviceImpl class. Therefore, when a StepperMotor object is
created, a DeviceImpl object is also created. The DeviceImpl constructor
builds all the device attribute object(s) from the attribute list built
by the <em>attribute_factory()</em> method.</p>
</div>
<div class="section" id="command-execution-sequence">
<h3>Command execution sequence<a class="headerlink" href="#command-execution-sequence" title="Permalink to this headline">¶</a></h3>
<p>The figure <a class="reference internal" href="#id26">6.3</a></p>
<div class="figure align-center" id="id69">
<span id="id26"></span><img alt="../../_images/command.png" src="../../_images/command.png" />
<p class="caption"><span class="caption-text">Figure 6.3: Command execution timing</span></p>
</div>
<p>described how the method implementing a command is executed when a
command_inout CORBA operation is requested by a client. The
<em>command_inout</em> method of the StepperMotor object (inherited from the
DeviceImpl class) is triggered by an instance of a class generated by
the CORBA IDL compiler. This method calls the <em>command_handler</em>()
method of the StepperMotorClass object (inherited from the DeviceClass
class). The <em>command_handler</em> method searches in its command list for
the wanted command (using its name). If the command is found, the
<em>always_executed_hook</em> method of the StepperMotor object is called.
Then, the <em>is_allowed</em> method of the wanted command is executed. If the
<em>is_allowed</em> method returns correctly, the <em>execute</em> method is
executed. The <em>execute</em> method extracts the incoming data from the CORBA
object use to transmit data over the network and calls the user written
method which implements the command.</p>
</div>
<div class="section" id="the-automatically-added-commands">
<h3>The automatically added commands<a class="headerlink" href="#the-automatically-added-commands" title="Permalink to this headline">¶</a></h3>
<p>In order to increase the common behavior of every kind of devices in a
TANGO control system, three commands are automatically added to each
class of devices. These commands are :</p>
<ul class="simple">
<li>State</li>
<li>Status</li>
<li>Init</li>
</ul>
<p>The default behavior of the method called by the State command depends
on the device state. If the device state is ON or ALARM, the method will
:</p>
<ul class="simple">
<li>read the attribute(s) with an alarm level defined</li>
<li>check if the read value is above/below the alarm level and eventually
change the device state to ALARM.</li>
<li>returns the device state.</li>
</ul>
<p>For all the other device state, the method simply returns the device
state stored in the DeviceImpl class. Nevertheless, the method used to
return this state (called <em>dev_state</em>) is defined as virtual and can be
redefined in DeviceImpl sub-class. The difference between the default
State command and the state CORBA attribute is the ability of the State
command to signal an error to the caller by throwing an exception.</p>
<p>The default behavior of the method called by the Status command depends
on the device state. If the device state is ON or ALARM, the method
returns the device status stored in the DeviceImpl class plus additional
message(s) for all the attributes which are in alarm condition. For all
the other device state, the method simply returns the device status as
it is stored in the DeviceImpl class. Nevertheless, the method used to
return this status (called <em>dev_status</em>) is defined as virtual and can
be redefined in DeviceImpl sub-class. The difference between the default
Status command and the status CORBA attribute is the ability of the
Status command to signal an error to the caller by throwing an
exception.</p>
<p>The Init command is used to re-initialize a device without changing its
network connection. This command calls the device <em>delete_device</em>
method and the device <em>init_device</em> method. The rule of the
<em>delete_device</em> method is to free memory allocated in the
<em>init_device</em> method in order to avoid memory leak.</p>
</div>
<div class="section" id="reading-writing-attributes">
<h3>Reading/Writing attributes<a class="headerlink" href="#reading-writing-attributes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="reading-attributes">
<h4>Reading attributes<a class="headerlink" href="#reading-attributes" title="Permalink to this headline">¶</a></h4>
<p>A Tango client is able to read Tango attribute(s) with the CORBA
read_attributes call. Inside the device server, this call will trigger
several methods of the device class (StepperMotor in our example) :</p>
<ol class="arabic simple">
<li>The <em>always_executed_hook()</em> method.</li>
<li>A method call <em>read_attr_hardware()</em>. This method is called one
time per read_attributes CORBA call. The aim of this method is to
read the device hardware and to store the result in a device class
data member.</li>
<li>For each attribute to be read<ol class="arabic">
<li>A method called <em>is_&lt;att name&gt;_allowed()</em>. The rule of this
method is to allow (or disallow) the next method to be executed.
It is usefull for device with some attributes which can be read
only in some precise conditions. It has one parameter which is the
request type (read or write)</li>
<li>A method called <em>read_&lt;att name&gt;()</em>. The aim of this method is to
extract the real attribute value from the hardware read-out and to
store the attribute value into the attribute object. It has one
parameter which is a reference to the Attribute object to be read.</li>
</ol>
</li>
</ol>
<p>The figure <a class="reference internal" href="#id27">6.4</a> is a drawing of these method
calls sequencing. For attribute always readable, a default <em>is_allowed</em>
method is provided. This method always returns true.</p>
<div class="figure align-center" id="id70">
<span id="id27"></span><img alt="Read attribute sequencing" src="../../_images/r_attribute.png" />
<p class="caption"><span class="caption-text">Figure 6.4: Read attribute sequencing</span></p>
</div>
</div>
<div class="section" id="writing-attributes">
<h4>Writing attributes<a class="headerlink" href="#writing-attributes" title="Permalink to this headline">¶</a></h4>
<p>A Tango client is able to write Tango attribute(s) with the CORBA
write_attributes call. Inside a device server, this call will trigger
several methods of the device class (StepperMotor in our example)</p>
<ol class="arabic simple">
<li>The <em>always_executed_hook()</em> method.</li>
<li>For each attribute to be written<ol class="arabic">
<li>A method called <em>is_&lt;att name&gt;_allowed()</em>. The rule of this
method is to allow (or disallow) the next method to be executed.
It is usefull for device with some attributes which can be written
only in some precise conditions. It has one parameter which is the
request type (read or write)</li>
<li>A method called <em>write_&lt;att name&gt;()</em>. It has one parameter which
is a reference to the WAttribute object to be written. The aim of
this method is to get the data to be written from the WAttribute
object and to write this value into the corresponding hardware. If
the hardware support writing several data in one go, code the
hardware access in the <em>write_attr_harware()</em> method.</li>
</ol>
</li>
<li>The write_attr_hardware() method. The rule of this method is to
effectively write the hardware in case it is able to support writing
several data in one go. If this is not the case, don’t code this
method (a default implementation is coded in the Tango base class)
and code the real hardware access in each <em>write_&lt;att name&gt;()</em>
method.</li>
</ol>
<p>The figure <a class="reference internal" href="#id28">6.5</a> is a drawing of these method
calls sequencing. For attribute always writeable, a default is_allowed
method is provided. This method always allways returns true.</p>
<div class="figure align-center" id="id71">
<span id="id28"></span><img alt="Write attribute sequencing" src="../../_images/w_attribute.png" />
<p class="caption"><span class="caption-text">Write attribute sequencing</span></p>
</div>
</div>
</div>
<div class="section" id="id29">
<h3>The device server framework<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="section" id="vocabulary">
<h4>Vocabulary<a class="headerlink" href="#vocabulary" title="Permalink to this headline">¶</a></h4>
<p>A device server pattern implementation is embedded in a process called a
<strong>device server</strong>. Several instances of the same device server process
can be used in a TANGO control system. To identify instances, a device
server process is started with an <strong>instance name</strong> which is different
for each instance. The device server name is the couple device server
executable name/device server instance name. For instance, a device
server started with the following command</p>
<p>Perkin id11</p>
<p>starts a device server process with an instance name id11, an executable
name Perkin and a device server name Perkin/id11.</p>
</div>
<div class="section" id="the-dserver-class">
<span id="dserverclass-deviceserverwriting"></span><h4>The DServer class<a class="headerlink" href="#the-dserver-class" title="Permalink to this headline">¶</a></h4>
<p>In order to simplify device server process administration, a device of
the DServer class is automatically added to each device server process.
Thus, every device server process supports the same set of
administration commands. The implementation of this DServer class
follows the device pattern and therefore, its device behaves like any
other devices. The device name is</p>
<p>dserver/device server executable name/device server instance name</p>
<p>For instance, for the device server process described in chapter [Voc],
the dserver device name is dserver/perkin/id11. This name is returned by
the adm_name CORBA attribute available for every device. On top of the
three automatically added commands, this device supports the following
commands :</p>
<ul class="simple">
<li>DevRestart</li>
<li>RestartServer</li>
<li>QueryClass</li>
<li>QueryDevice</li>
<li>Kill</li>
<li>AddLoggingTarget (C++ server only)</li>
<li>RemoveLoggingTarget (C++ server only)</li>
<li>GetLoggingTarget (C++ server only)</li>
<li>GetLoggingLevel (C++ server only)</li>
<li>SetLoggingLevel (C++ server only)</li>
<li>StopLogging (C++ server only)</li>
<li>StartLogging (C++ server only)</li>
<li>PolledDevice</li>
<li>DevPollStatus</li>
<li>AddObjPolling</li>
<li>RemObjPolling</li>
<li>UpdObjPollingPeriod</li>
<li>StartPolling</li>
<li>StopPolling</li>
<li>EventSubscriptionChange</li>
<li>ZmqEventSubscriptionChange</li>
<li>LockDevice</li>
<li>UnLockDevice</li>
<li>ReLockDevices</li>
<li>DevLockStatus</li>
</ul>
<p>These commands will be fully described later in this document.</p>
<p>Several controlled object classes can be embedded within the same device
server process and it is the rule of this device to create all these
device server patterns and to call their command and device factories as
described in <a class="reference internal" href="#startup-of-a-device-pattern">Startup of a device pattern</a>. The name and number of all the classes
to be created is known to this device after the execution of a method
called <em>class_factory</em>. It is the user responsibility to write this
method.</p>
</div>
<div class="section" id="the-tango-util-class">
<h4>The Tango::Util class<a class="headerlink" href="#the-tango-util-class" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id30">
<h5>Description<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h5>
<p>This class merges a complete set of utilities in the same class. It is
implemented as a singleton and there is only one instance of this class
per device server process. It is mandatory to create this instance in
order to run a device server. The description of all the methods
implemented in this class can be found in <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id31">[TangoRefMan]</a>.</p>
</div>
<div class="section" id="id32">
<h5>Contents<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h5>
<p>Within this class, you can find :</p>
<ul class="simple">
<li>Static method to create/retrieve the singleton object</li>
<li>Miscellaneous utility methods like getting the server output trace
level, getting the CORBA ORB pointer, retrieving device server
instance name, getting the server PID and more. Please, refer to
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id33">[TangoRefMan]</a> to get a complete list of all these
utility methods.</li>
<li>Method to create the device pattern implementing the DServer class
(<em>server_init()</em>)</li>
<li>Method to start the server (<em>server_run()</em>)</li>
<li>TANGO database related methods</li>
</ul>
</div>
</div>
<div class="section" id="a-complete-device-server">
<h4>A complete device server<a class="headerlink" href="#a-complete-device-server" title="Permalink to this headline">¶</a></h4>
<p>Within a complete device server, at least two implementations of the
device server pattern are created (one for the dserver object and the
other for the class of devices to control). On top of that, one instance
of the Tango::Util class must also be created.</p>
<div class="figure align-center" id="id72">
<span id="id34"></span><img alt="A complete device server" src="../../_images/complete_server.png" />
<p class="caption"><span class="caption-text">Figure 6.6: A complete device server</span></p>
</div>
<p>A drawing of a complete device server is in figure <a class="reference internal" href="#id34">6.6</a></p>
</div>
<div class="section" id="device-server-startup-sequence">
<h4>Device server startup sequence<a class="headerlink" href="#device-server-startup-sequence" title="Permalink to this headline">¶</a></h4>
<p>The device server startup sequence is the following :</p>
<ol class="arabic simple">
<li>Create an instance of the Tango::Util class. This will initialize the
CORBA Object Request Broker</li>
<li>Called the <em>server_init</em> method of the Tango::Util instance The call
to this method will :<ol class="arabic">
<li>Create the DServerClass object of the device pattern implementing
the DServer class. This will create the dserver object which
during its construction will :<ol class="arabic">
<li>Called the <em>class_factory</em> method of the DServer object. This
method must create all the xxxClass instance for all the device
pattern implementation embedded in the device server process.</li>
<li>Call the <em>command_factory</em> and <em>device_factory</em> of all the
classes previously created. The list of devices passed to each
call to the <em>device_factory</em> method is retrieved from the
TANGO database.</li>
</ol>
</li>
</ol>
</li>
<li>Wait for incoming request with the <em>server_run()</em> method of the
Tango::Util class.</li>
</ol>
</div>
</div>
</div>
<div class="section" id="exchanging-data-between-client-and-server">
<h2>Exchanging data between client and server<a class="headerlink" href="#exchanging-data-between-client-and-server" title="Permalink to this headline">¶</a></h2>
<p>Exchanging data between clients and server means most of the time
passing data between processes running on different computer using the
network. Tango limits the type of data exchanged between client and
server and defines a way to exchange these data. This chapter details
these features. Memory allocation and error reporting are also
discussed.</p>
<p><strong>All the rules described in this chapter are valid only for data
exchanged between client and server. For device server internal data,
classical C++ types can be used.</strong></p>
<div class="section" id="command-attribute-data-types">
<h3>Command / Attribute data types<a class="headerlink" href="#command-attribute-data-types" title="Permalink to this headline">¶</a></h3>
<p>Commands have a fixed calling syntax - consisting of one input argument
and one output argument. Arguments type must be chosen out of a fixed
set of 24 data types. Attributes support a sub-set of these data types
(those are the data type with the (1) note) plus the DevEnum data type.
The following table details type name, code and the corresponding CORBA
IDL types.</p>
<p>The type name used in the type name column of this table is the C++
name. In the IDL file, all the Tango definition are grouped in a IDL
module named Tango. The IDL module maps to C++ namespace. Therefore, all
the data type are parts of a namespace called Tango.</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type name</th>
<th class="head">IDL type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tango::DevBoolean (1)</td>
<td>boolean</td>
</tr>
<tr class="row-odd"><td>Tango::DevShort (1)</td>
<td>short</td>
</tr>
<tr class="row-even"><td>Tango::DevEnum (2)</td>
<td>short (See chapter on advanced features)</td>
</tr>
<tr class="row-odd"><td>Tango::DevLong (1)</td>
<td>long</td>
</tr>
<tr class="row-even"><td>Tango::DevLong64 (1)</td>
<td>long long</td>
</tr>
<tr class="row-odd"><td>Tango::DevFloat (1)</td>
<td>float</td>
</tr>
<tr class="row-even"><td>Tango::DevDouble (1)</td>
<td>double</td>
</tr>
<tr class="row-odd"><td>Tango::DevUShort (1)</td>
<td>unsigned short</td>
</tr>
<tr class="row-even"><td>Tango::DevULong (1)</td>
<td>unsigned long</td>
</tr>
<tr class="row-odd"><td>Tango::DevULong64 (1)</td>
<td>unsigned long long</td>
</tr>
<tr class="row-even"><td>Tango::DevString (1)</td>
<td>string</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarCharArray</td>
<td>sequence of unsigned char</td>
</tr>
<tr class="row-even"><td>Tango::DevVarShortArray</td>
<td>sequence of short</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarLongArray</td>
<td>sequence of long</td>
</tr>
<tr class="row-even"><td>Tango::DevVarLong64Array</td>
<td>sequence of long long</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarFloatArray</td>
<td>sequence of float</td>
</tr>
<tr class="row-even"><td>Tango::DevVarDoubleArray</td>
<td>sequence of double</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarUShortArray</td>
<td>sequence of unsigned short</td>
</tr>
<tr class="row-even"><td>Tango::DevVarULongArray</td>
<td>sequence of unsigned long</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarULong64Array</td>
<td>sequence of unsigned long long</td>
</tr>
<tr class="row-even"><td>Tango::DevVarStringArray</td>
<td>sequence of string</td>
</tr>
<tr class="row-odd"><td>Tango::DevVarLongStringArray</td>
<td>structure with a sequence of long and a
sequence of string</td>
</tr>
<tr class="row-even"><td>Tango::DevVarDoubleStringArray</td>
<td>structure with a sequence of double
and a sequence of string</td>
</tr>
<tr class="row-odd"><td>Tango::DevState (1)</td>
<td>enumeration</td>
</tr>
<tr class="row-even"><td>Tango::DevEncoded (1)</td>
<td>structure with a string and a sequence of char</td>
</tr>
</tbody>
</table>
<p>The CORBA Interface Definition Language uses a type called <strong>sequence</strong>
for variable length array. The Tango::DevUxxx types are used for
unsigned types. The Tango::DevVarxxxxArray must be used when the data to
be transferred are variable length array. The
Tango::DevVarLongStringArray and Tango::DevVarDoubleStringArray are
structures with two fields which are variable length array of Tango long
(32 bits) and variable length array of strings for the
Tango::DevVarLongStringArray and variable length array of double and
variable length array of string for the Tango::DevVarDoubleStringArray.
The Tango::State type is used by the State command to return the device
state.</p>
<div class="section" id="using-data-types-with-c">
<h4>Using data types with C++<a class="headerlink" href="#using-data-types-with-c" title="Permalink to this headline">¶</a></h4>
<p>Unfortunately, the mapping between IDL and C++ was defined before the
C++ class library had been standardized. This explains why the standard
C++ string class or vector classes are not used in the IDL to C++
mapping.</p>
<p>TANGO commands/attributes argument types can be grouped on five groups
depending on the IDL data type used. These groups are :</p>
<ol class="arabic simple">
<li>Data type using basic types (Tango::DevBoolean, Tango::DevShort,
Tango::DevEnum, Tango::DevLong, Tango::DevFloat, Tango::DevDouble,
Tango::DevUshort and Tango::DevULong)</li>
<li>Data type using strings (Tango::DevString type)</li>
<li>Data types using sequences (Tango::DevVarxxxArray types except
Tango::DevVarLongStringArray and Tango::DevVarDoubleStringArray)</li>
<li>Data types using structures (Tango::DevVarLongStringArray and
Tango::DevVarDoubleStringArray types)</li>
<li>Data type using IDL enumeration (Tango::DevState type)</li>
</ol>
<p>In the following sub chapters, only summaries of the IDL to C++ mapping
are given. For a full description of the C++ mapping, please refer to
<a class="reference internal" href="../../reference/bibliography.html#henning" id="id35">[Henning]</a>.</p>
<div class="section" id="basic-types">
<h5>Basic types<a class="headerlink" href="#basic-types" title="Permalink to this headline">¶</a></h5>
<p>For these types, the mapping between IDL and C++ is obvious and defined
in the following table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Tango type name</th>
<th class="head">IDL type</th>
<th class="head">C++</th>
<th class="head">typedef</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tango::DevBoolean</td>
<td>boolean</td>
<td>CORBA::Boolean</td>
<td>unsigned char</td>
</tr>
<tr class="row-odd"><td>Tango::DevShort</td>
<td>short</td>
<td>CORBA::Short</td>
<td>short</td>
</tr>
<tr class="row-even"><td>Tango::DevEnum</td>
<td>short</td>
<td>CORBA::Short</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Tango::DevLong</td>
<td>long</td>
<td>CORBA::Long</td>
<td>int</td>
</tr>
<tr class="row-even"><td>Tango::DevLong64</td>
<td>long long</td>
<td>CORBA::LongLong</td>
<td>long long or long (64
bits chip)</td>
</tr>
<tr class="row-odd"><td>Tango::DevFloat</td>
<td>float</td>
<td>CORBA::Float</td>
<td>float</td>
</tr>
<tr class="row-even"><td>Tango::DevDouble</td>
<td>double</td>
<td>CORBA::Double</td>
<td>double</td>
</tr>
<tr class="row-odd"><td>Tango::DevUShort</td>
<td>unsigned short</td>
<td>CORBA::UShort</td>
<td>unsigned short</td>
</tr>
<tr class="row-even"><td>Tango::DevULong</td>
<td>unsigned long</td>
<td>CORBA::ULong</td>
<td>unsigned long</td>
</tr>
<tr class="row-odd"><td>Tango::DevULong64</td>
<td>unsigned long long</td>
<td>CORBA:ULongLong</td>
<td>unsigned
long long or unsigned long (64 bits chip)</td>
</tr>
</tbody>
</table>
<p>The types defined in the column named C++ should be used for a better
portability. All these types are defined in the CORBA namespace and
therefore their qualified names is CORBA::xxx. The Tango data type
DevEnum is a special case described in detail in the chapter about
advanced features.</p>
</div>
<div class="section" id="strings">
<h5>Strings<a class="headerlink" href="#strings" title="Permalink to this headline">¶</a></h5>
<p>Strings are mapped to <strong>char *</strong>. The use of <em>new</em> and <em>delete</em> for
dynamic allocation of strings is not portable. Instead, you must use
helper functions defined by CORBA (in the CORBA namespace). These
functions are :</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>      <span class="keyword type">char</span> <span class="operator">*</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">string_alloc</span><span class="punctuation">(</span><span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="name">len</span><span class="punctuation">);</span>
<span class="ln">2 </span>      <span class="keyword type">char</span> <span class="operator">*</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">3 </span>      <span class="keyword type">void</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_free</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
</pre>
<p>These functions handle dynamic memory for strings. The <em>string_alloc</em>
function allocates one more byte than requested by the len parameter
(for the trailing 0). The function <em>string_dup</em> combines the allocation
and copy. Both <em>string_alloc</em> and <em>string_dup</em> return a null pointer
if allocation fails. The <em>string_free</em> function must be used to free
memory allocated with <em>string_alloc</em> and <em>string_dup</em>. Calling
<em>string_free</em> for a null pointer is safe and does nothing. The
following code fragment is an example of the Tango::DevString type usage</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">str</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_alloc</span><span class="punctuation">(</span><span class="literal number integer">5</span><span class="punctuation">);</span>
<span class="ln">2 </span>     <span class="name">strcpy</span><span class="punctuation">(</span><span class="name">str</span><span class="punctuation">,</span><span class="literal string">&quot;TANGO&quot;</span><span class="punctuation">);</span>
<span class="ln">3 </span>
<span class="ln">4 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">str1</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Do you want to danse TANGO?&quot;</span><span class="punctuation">);</span>
<span class="ln">5 </span>
<span class="ln">6 </span>     <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_free</span><span class="punctuation">(</span><span class="name">str</span><span class="punctuation">);</span>
<span class="ln">7 </span>     <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_free</span><span class="punctuation">(</span><span class="name">str1</span><span class="punctuation">);</span>
</pre>
<p>Line 1-2 : TANGO is a five letters string. The CORBA::string_alloc
function parameter is 5 but the function allocates 6 bytes</p>
<p>Line 4 : Example of the CORBA::string_dup function</p>
<p>Line 6-7 : Memory deallocation</p>
</div>
<div class="section" id="sequences">
<h5>Sequences<a class="headerlink" href="#sequences" title="Permalink to this headline">¶</a></h5>
<p>IDL sequences are mapped to C++ classes that behave like vectors with a
variable number of elements. Each IDL sequence type results in a
separate C++ class. Within each class representing a IDL sequence types,
you find the following method (only the main methods are related here) :</p>
<ol class="arabic simple">
<li>Four constructors.<ol class="arabic">
<li>A default constructor which creates an empty sequence.</li>
<li>The maximum constructor which creates a sequence with memory
allocated for at least the number of elements passed as argument.
This does not limit the number of element in the sequence but only
the way how memory is allocated to store element</li>
<li>A sophisticated constructor where it is possible to assign the
memory used by the sequence with a preallocated buffer.</li>
<li>A copy constructor which does a deep copy</li>
</ol>
</li>
<li>An assignment operator which does a deep copy</li>
<li>A <em>length</em> accessor which simply returns the current number of
elements in the sequence</li>
<li>A <em>length</em> modifier which changes the length of the sequence (which
is different than the number of elements in the sequence)</li>
<li>Overloading of the [] operator. The subscript operator [] provides
access to the sequence element. For a sequence containing elements of
type T, the [] operator is overloaded twice to return value of type T
&amp; and const T &amp;. Insertion into a sequence using the [] operator for
the const T &amp; make a deep copy. Sequence are numbered between 0 and
<em>length</em>() -1.</li>
</ol>
<p>Note that using the maximum constructor will not prevent you from
setting the length of the sequence with a call to the length modifier.
The following code fragment is an example of how to use a
Tango::DevVarLongArray type</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span> <span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">;</span>
<span class="ln"> 2 </span>     <span class="name">mylongseq_ptr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span><span class="punctuation">();</span>
<span class="ln"> 3 </span>     <span class="name">mylongseq_ptr</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">);</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">2</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">3</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="literal number integer">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">4</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>     <span class="comment single">// (*mylongseq_ptr)[4] = 5;
</span><span class="ln">11 </span><span class="comment single"></span>
<span class="ln">12 </span>     <span class="name">CORBA</span><span class="operator">::</span><span class="name">Long</span> <span class="name">nb_elt</span> <span class="operator">=</span> <span class="name">mylongseq_ptr</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">();</span>
<span class="ln">13 </span>
<span class="ln">14 </span>     <span class="name">mylongseq_ptr</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">5</span><span class="punctuation">);</span>
<span class="ln">15 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="literal number integer">4</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">5</span><span class="punctuation">;</span>
<span class="ln">16 </span>
<span class="ln">17 </span>     <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">mylongseq_ptr</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">();</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln">18 </span>          <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Sequence elt &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">i</span> <span class="operator">+</span> <span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; = &quot;</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="operator">*</span><span class="name">mylongseq_ptr</span><span class="punctuation">)[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
</pre>
<p>Line 1 : Declare a pointer to Tango::DevVarLongArray type which is a
sequence of long</p>
<p>Line 2 : Create an empty sequence</p>
<p>Line 3 : Change the length of the sequence to 4</p>
<p>Line 5 - 8 : Initialize sequence elements</p>
<p>Line 10 ; Oups !!! The length of the sequence is 4. The behavior of this
line is undefined and may be a core can be dumped at run time</p>
<p>Line 12 : Get the number of element actually stored in the sequence</p>
<p>Line 14-15 : Grow the sequence to five elements and initialize element
number 5</p>
<p>Line 17-18 : Print sequence element</p>
<p>Another example for the Tango::DevVarStringArray type is given</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="name">mystrseq</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">);</span>
<span class="ln"> 2 </span>     <span class="name">mystrseq</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">);</span>
<span class="ln"> 3 </span>
<span class="ln"> 4 </span>     <span class="name">mystrseq</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Rock and Roll&quot;</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>     <span class="name">mystrseq</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Bossa Nova&quot;</span><span class="punctuation">);</span>
<span class="ln"> 6 </span>     <span class="name">mystrseq</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Waltz&quot;</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>     <span class="name">mystrseq</span><span class="punctuation">[</span><span class="literal number integer">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Tango&quot;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>     <span class="name">CORBA</span><span class="operator">::</span><span class="name">Long</span> <span class="name">nb_elt</span> <span class="operator">=</span> <span class="name">mystrseq</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">();</span>
<span class="ln">10 </span>
<span class="ln">11 </span>     <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">mystrseq</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">();</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln">12 </span>          <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Sequence elt &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">i</span> <span class="operator">+</span> <span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; = &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">mystrseq</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
</pre>
<p>Line 1 : Create a sequence using the maximum constructor</p>
<p>Line 2 : Set the sequence length to 4. This is mandatory even if you
used the maximum constructor.</p>
<p>Line 4-7 : Populate the sequence</p>
<p>Line 9 : Get how many strings are stored into the sequence</p>
<p>Line 11-12 : Print sequence elements.</p>
</div>
<div class="section" id="structures">
<h5>Structures<a class="headerlink" href="#structures" title="Permalink to this headline">¶</a></h5>
<p>Only three TANGO types are defined as structures. These types are the
Tango::DevVarLongStringArray, the Tango::DevVarDoubleStringArray and the
Tango::DevEncoded data type. IDL structures map to C++ structures with
corresponding members. For the Tango::DevVarLongStringArray, the two
members are named <em>svalue</em> for the sequence of strings and <em>lvalue</em> for
the sequence of longs. For the Tango::DevVarDoubleStringArray, the two
structure members are called <em>svalue</em> for the sequence of strings and
<em>dvalue</em> for the sequence of double. For the Tango::DevEncoded, the two
structure members are called <em>encoded_format</em> for a string describing
the data coding and <em>encoded_data</em> for the data themselves. The
encoded_data field type is a Tango::DevVarCharArray. An example of the
usage of the Tango::DevVarLongStringArray type is detailed below.</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongStringArray</span> <span class="name">my_vl</span><span class="punctuation">;</span>
<span class="ln">2 </span>
<span class="ln">3 </span>     <span class="name">myvl</span><span class="punctuation">.</span><span class="name">svalue</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="ln">4 </span>     <span class="name">myvl</span><span class="punctuation">.</span><span class="name">svalue</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA_string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Samba&quot;</span><span class="punctuation">);</span>
<span class="ln">5 </span>     <span class="name">myvl</span><span class="punctuation">.</span><span class="name">svalue</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA_string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Rumba&quot;</span><span class="punctuation">);</span>
<span class="ln">6 </span>
<span class="ln">7 </span>     <span class="name">myvl</span><span class="punctuation">.</span><span class="name">lvalue</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">);</span>
<span class="ln">8 </span>     <span class="name">myvl</span><span class="punctuation">.</span><span class="name">lvalue</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">10</span><span class="punctuation">;</span>
</pre>
<p>Line 1 : Declaration of the structure</p>
<p>Line 3-5 : Initialization of two strings in the sequence of string
member</p>
<p>Line 7-8 : Initialization of one long in the sequence of long member</p>
</div>
<div class="section" id="the-devstate-data-type">
<h5>The DevState data type<a class="headerlink" href="#the-devstate-data-type" title="Permalink to this headline">¶</a></h5>
<p>The Tango::DevState data type is used to transfer device state between
client and server. It is a IDL enumeration. IDL enumerated types map to
C++ enumerations (amazing no!) with a trailing dummy enumerator to force
enumeration to be a 32 bit type. The first enumerator will have the
value 0, the next one will have the value 1 and so on.</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevState</span> <span class="name">state</span><span class="punctuation">;</span>
<span class="ln">2 </span>
<span class="ln">3 </span>     <span class="name">state</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ON</span><span class="punctuation">;</span>
<span class="ln">4 </span>     <span class="name">state</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">FAULT</span><span class="punctuation">;</span>
</pre>
</div>
</div>
</div>
<div class="section" id="passing-data-between-client-and-server">
<h3>Passing data between client and server<a class="headerlink" href="#passing-data-between-client-and-server" title="Permalink to this headline">¶</a></h3>
<p>In order to have one definition of the CORBA operation used to send a
command to a device whatever the command data type is, TANGO uses CORBA
IDL <strong>any</strong> object. The IDL type <em>any</em> provides a universal type that
can hold a value of arbitrary IDL types. Type <em>any</em> therefore allows you
to send and receive values whose types are not fixed at compile time.</p>
<p>Type <em>any</em> is often compared to a void * in C. Like a pointer to void,
an <em>any</em> value can denote a datum of any type. However, there is an
important difference; whereas a void * denotes a completely untyped
value that can be interpreted only with advance knowledge of its type,
values of type <em>any</em> maintain type safety. For example, if a sender
places a string value into an <em>any</em>, the receiver cannot extract the
string as a value of the wrong type. Attempt to read the contents of an
<em>any</em> as the wrong type cause a run-time error.</p>
<p>Internally, a value of type <em>any</em> consists of a pair of values. One
member of the pair is the actual value contained inside the <em>any</em> and
the other member of the pair is the type code. The type code is a
description of the value’s type. The type description is used to enforce
type safety when the receiver extracts the value. Extraction of the
value succeeds only if the receiver extracts the value as a type that
matches the information in the type code.</p>
<p>Within TANGO, the command input and output parameters are objects of the
IDL <em>any</em> type. Only insertion/extraction of all types defined as
command data types is possible into/from these <em>any</em> objects.</p>
<div class="section" id="c-mapping-for-idl-any-type">
<h4>C++ mapping for IDL any type<a class="headerlink" href="#c-mapping-for-idl-any-type" title="Permalink to this headline">¶</a></h4>
<p>The IDL any maps to the C++ class <strong>CORBA::Any</strong>. This class contains a
large number of methods with mainly methods to insert/extract data
into/from the any. It provides a default constructor which builds an any
which contains no value and a type code that indicates “no value”. Such
an any must be used for command which does not need input or output
parameter. The operator <strong>&lt;&lt;=</strong> is overloaded many times to insert data
into an any object. The operator <strong>&gt;&gt;=</strong> is overloaded many times to
extract data from an any object.</p>
<div class="section" id="inserting-extracting-tango-basic-types">
<h5>Inserting/Extracting TANGO basic types<a class="headerlink" href="#inserting-extracting-tango-basic-types" title="Permalink to this headline">¶</a></h5>
<p>The insertion or extraction of TANGO basic types is straight forward
using the &lt;&lt;= or &gt;&gt;= operators. Nevertheless, the Tango::DevBoolean type
is mapped to a unsigned char and other IDL types are also mapped to char
C++ type (The unsigned is not taken into account in the C++ overloading
algorithm). Therefore, it is not possible to use operator overloading
for these IDL types which map to C++ char. For the Tango::DevBoolean
type, you must use the <em>CORBA::Any::from_boolean</em> or
<em>CORBA::Any::to_boolean</em> intermediate objects defined in the CORBA::Any
class.</p>
</div>
<div class="section" id="inserting-extracting-tango-strings">
<h5>Inserting/Extracting TANGO strings<a class="headerlink" href="#inserting-extracting-tango-strings" title="Permalink to this headline">¶</a></h5>
<p>The &lt;&lt;= operator is overloaded for const char * and always makes a deep
copy. This deep copy is done using the CORBA::<em>string_dup</em> function.
The extraction of strings uses the &gt;&gt;= overloaded operator. The main
point is that the Any object retains ownership of the string, so the
returned pointer points at memory inside the Any. This means that you
must not deallocate the extracted string and you must treat the
extracted string as read-only.</p>
</div>
<div class="section" id="inserting-extracting-tango-sequences">
<h5>Inserting/Extracting TANGO sequences<a class="headerlink" href="#inserting-extracting-tango-sequences" title="Permalink to this headline">¶</a></h5>
<p>Insertion and extraction of sequences also uses the overloaded &lt;&lt;= and
&gt;&gt;= operators. The insertion operator is overloaded twice: once for
insertion by reference and once for insertion by pointer. If you insert
a value by reference, the insertion makes a deep copy. If you insert a
value by pointer, the Any assumes the ownership of the pointed-to
memory.</p>
<p>Extraction is always by pointer. As with strings, you must treat the
extracted pointer as read-only and must not deallocate it because the
pointer points at memory internal to the Any.</p>
</div>
<div class="section" id="inserting-extracting-tango-structures">
<h5>Inserting/Extracting TANGO structures<a class="headerlink" href="#inserting-extracting-tango-structures" title="Permalink to this headline">¶</a></h5>
<p>This is identical to inserting/extracting sequences.</p>
</div>
<div class="section" id="inserting-extracting-tango-enumeration">
<h5>Inserting/Extracting TANGO enumeration<a class="headerlink" href="#inserting-extracting-tango-enumeration" title="Permalink to this headline">¶</a></h5>
<p>This is identical to inserting/extracting basic types</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="name">a</span><span class="punctuation">;</span>
<span class="ln"> 2 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">l1</span><span class="punctuation">,</span><span class="name">l2</span><span class="punctuation">;</span>
<span class="ln"> 3 </span>    <span class="name">l1</span> <span class="operator">=</span> <span class="literal number integer">2</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>    <span class="name">a</span> <span class="operator">&lt;&lt;=</span> <span class="name">l1</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>    <span class="name">a</span> <span class="operator">&gt;&gt;=</span> <span class="name">l2</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="name">b</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevBoolean</span> <span class="name">b1</span><span class="punctuation">,</span><span class="name">b2</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>    <span class="name">b1</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">10 </span>    <span class="name">b</span> <span class="operator">&lt;&lt;=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span><span class="operator">::</span><span class="name">from_boolean</span><span class="punctuation">(</span><span class="name">b1</span><span class="punctuation">);</span>
<span class="ln">11 </span>    <span class="name">b</span> <span class="operator">&gt;&gt;=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span><span class="operator">::</span><span class="name">to_boolean</span><span class="punctuation">(</span><span class="name">b2</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="name">s</span><span class="punctuation">;</span>
<span class="ln">14 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">str1</span><span class="punctuation">,</span><span class="name">str2</span><span class="punctuation">;</span>
<span class="ln">15 </span>    <span class="name">str1</span> <span class="operator">=</span> <span class="literal string">&quot;I like dancing TANGO&quot;</span><span class="punctuation">;</span>
<span class="ln">16 </span>    <span class="name">s</span> <span class="operator">&lt;&lt;=</span> <span class="name">str1</span><span class="punctuation">;</span>
<span class="ln">17 </span>    <span class="name">s</span> <span class="operator">&gt;&gt;=</span> <span class="name">str2</span><span class="punctuation">;</span>
<span class="ln">18 </span>
<span class="ln">19 </span>  <span class="comment single">//   CORBA::string_free(str2);
</span><span class="ln">20 </span><span class="comment single"></span>  <span class="comment single">//   a &lt;&lt;= CORBA::string_dup(&quot;Oups&quot;);
</span><span class="ln">21 </span><span class="comment single"></span>
<span class="ln">22 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="name">seq</span><span class="punctuation">;</span>
<span class="ln">23 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarFloatArray</span> <span class="name">fl_arr1</span><span class="punctuation">;</span>
<span class="ln">24 </span>    <span class="name">fl_arr1</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="ln">25 </span>    <span class="name">fl_arr1</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
<span class="ln">26 </span>    <span class="name">fl_arr1</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number float">2.0</span><span class="punctuation">;</span>
<span class="ln">27 </span>    <span class="name">seq</span> <span class="operator">&lt;&lt;=</span> <span class="name">fl_arr1</span><span class="punctuation">;</span>
<span class="ln">28 </span>    <span class="keyword">const</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarFloatArray</span> <span class="operator">*</span><span class="name">fl_arr_ptr</span><span class="punctuation">;</span>
<span class="ln">29 </span>    <span class="name">seq</span> <span class="operator">&gt;&gt;=</span> <span class="name">fl_arr_ptr</span><span class="punctuation">;</span>
<span class="ln">30 </span>
<span class="ln">31 </span>  <span class="comment single">//   delete fl_arr_ptr;</span>
</pre>
<p>Line 1-5 : Insertion and extraction of Tango::DevLong type</p>
<p>Line 7-11 Insertion and extraction of Tango::DevBoolean type using the
CORBA::Any::from_boolean and CORBA::Any::to_boolean intermediate
structure</p>
<p>Line 13-17 : Insertion and extraction of Tango::DevString type</p>
<p>Line 19 : Wrong ! You should not deallocate a string extracted from an
any</p>
<p>Line 20 : Wrong ! Memory leak because the &lt;&lt;= operator will do the copy.</p>
<p>Line 22-29 : Insertion and extraction of Tango::DevVarxxxArray types.
This is an insertion by reference and the use of the &lt;&lt;= operator makes
a deep copy of the sequence. Therefore, after line 27, it is possible to
deallocate the sequence</p>
<p>Line 31: Wrong.! You should not deallocate a sequence extracted from an
any</p>
</div>
</div>
<div class="section" id="the-insert-and-extract-methods-of-the-command-class">
<h4>The insert and extract methods of the Command class<a class="headerlink" href="#the-insert-and-extract-methods-of-the-command-class" title="Permalink to this headline">¶</a></h4>
<p>In order to simplify the insertion/extraction into/from Any objects,
small helper methods have been written in the Command class. The
signatures of these methods are :</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>          <span class="keyword type">void</span> <span class="name function">extractextract</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">,</span><span class="operator">&lt;</span><span class="name">Tango</span> <span class="name">type</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">2 </span>          <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">insertinsert</span><span class="punctuation">(</span><span class="operator">&lt;</span><span class="name">Tango</span> <span class="name">type</span><span class="operator">&gt;</span><span class="punctuation">);</span>
</pre>
<p>An <em>extract</em> method has been written for all Tango types. These method
extract the data from the Any object passed as parameter and throw an
exception if the Any data type is incompatible with the awaiting type.
An <em>insert</em> method have been written for all Tango types. These method
create an Any object, insert the data into the Any and return a pointer
to the created Any. For Tango types mapped to sequences or structures,
two <em>insert</em> methods have been written: one for the insertion from
pointer and the other for the insertion from reference. For Tango
strings, two <em>insert</em> methods have been written: one for insertion from
a classical Tango::DevString type and the other from a const
Tango::DevString type. The first one deallocate the memory after the
insert into the Any object. The second one only inserts the string into
the Any object.</p>
<p>The previous example can be rewritten using the insert/extract helper
methods (We suppose that we can use the Command class insert/extract
methods)</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">l1</span><span class="punctuation">,</span><span class="name">l2</span><span class="punctuation">;</span>
<span class="ln"> 2 </span>    <span class="name">l1</span> <span class="operator">=</span> <span class="literal number integer">2</span><span class="punctuation">;</span>
<span class="ln"> 3 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">a_ptr</span> <span class="operator">=</span> <span class="name">insert</span><span class="punctuation">(</span><span class="name">l1</span><span class="punctuation">);</span>
<span class="ln"> 4 </span>    <span class="name">extract</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">a_ptr</span><span class="punctuation">,</span><span class="name">l2</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevBoolean</span> <span class="name">b1</span><span class="punctuation">,</span><span class="name">b2</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>    <span class="name">b1</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">b_ptr</span> <span class="operator">=</span> <span class="name">insert</span><span class="punctuation">(</span><span class="name">b1</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>    <span class="name">extract</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">b_ptr</span><span class="punctuation">,</span><span class="name">b2</span><span class="punctuation">);</span>
<span class="ln">10 </span>
<span class="ln">11 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">str1</span><span class="punctuation">,</span><span class="name">str2</span><span class="punctuation">;</span>
<span class="ln">12 </span>    <span class="name">str1</span> <span class="operator">=</span> <span class="literal string">&quot;I like dancing TANGO&quot;</span><span class="punctuation">;</span>
<span class="ln">13 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">s_ptr</span> <span class="operator">=</span> <span class="name">insert</span><span class="punctuation">(</span><span class="name">str1</span><span class="punctuation">);</span>
<span class="ln">14 </span>    <span class="name">extract</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">s_ptr</span><span class="punctuation">,</span><span class="name">str2</span><span class="punctuation">);</span>
<span class="ln">15 </span>
<span class="ln">16 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarFloatArray</span> <span class="name">fl_arr1</span><span class="punctuation">;</span>
<span class="ln">17 </span>    <span class="name">fl_arr1</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="ln">18 </span>    <span class="name">fl_arr1</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
<span class="ln">19 </span>    <span class="name">fl_arr1</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number float">2.0</span><span class="punctuation">;</span>
<span class="ln">20 </span>    <span class="name">insert</span><span class="punctuation">(</span><span class="name">fl_arr1</span><span class="punctuation">);</span>
<span class="ln">21 </span>    <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">seq_ptr</span> <span class="operator">=</span> <span class="name">insert</span><span class="punctuation">(</span><span class="name">fl_arr1</span><span class="punctuation">);</span>
<span class="ln">22 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarFloatArray</span> <span class="operator">*</span><span class="name">fl_arr_ptr</span><span class="punctuation">;</span>
<span class="ln">23 </span>    <span class="name">extract</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">seq_ptr</span><span class="punctuation">,</span><span class="name">fl_arr_ptr</span><span class="punctuation">);</span>
</pre>
<p>Line 1-4 : Insertion and extraction of Tango::DevLong type</p>
<p>Line 6-9 : Insertion and extraction of Tango::DevBoolean type</p>
<p>Line 11-14 : Insertion and extraction of Tango::DevString type</p>
<p>Line 16-23 : Insertion and extraction of Tango::DevVarxxxArray types.
This is an insertion by reference which makes a deep copy of the
sequence. Therefore, after line 20, it is possible to deallocate the
sequence</p>
</div>
</div>
<div class="section" id="c-memory-management">
<h3>C++ memory management<a class="headerlink" href="#c-memory-management" title="Permalink to this headline">¶</a></h3>
<p>The rule described here are valid for variable length command data types
like Tango::DevString or all the Tango:: DevVarxxxxArray types.</p>
<p>The method executing the command must allocate the memory used to pass
data back to the client or use static memory (like buffer declares as
object data member. If necessary, the ORB will deallocate this memory
after the data have been sent to the caller. Fortunately, for incoming
data, the method have no memory management responsibilities. The details
about memory management given in this chapter assume that the
insert/extract methods of the Tango::Command class are used and only the
method in the device object is discussed.</p>
<div class="section" id="for-string">
<h4>For string<a class="headerlink" href="#for-string" title="Permalink to this headline">¶</a></h4>
<p>Example of a method receiving a Tango::DevString and returning a
Tango::DevString is detailed just below</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">MyDev</span><span class="operator">::</span><span class="name">dev_string</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">argin</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span>        <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>      <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;the received string is &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">argin</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>      <span class="name">string</span> <span class="name function">str</span><span class="punctuation">(</span><span class="literal string">&quot;Am I a good Tango dancer ?&quot;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>      <span class="name">argout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="keyword type">char</span><span class="punctuation">[</span><span class="name">str</span><span class="punctuation">.</span><span class="name">size</span><span class="punctuation">()</span> <span class="operator">+</span> <span class="literal number integer">1</span><span class="punctuation">];</span>
<span class="ln"> 9 </span>      <span class="name">strcpy</span><span class="punctuation">(</span><span class="name">argout</span><span class="punctuation">,</span><span class="name">str</span><span class="punctuation">.</span><span class="name">c_str</span><span class="punctuation">());</span>
<span class="ln">10 </span>
<span class="ln">11 </span>      <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln">12 </span>  <span class="punctuation">}</span>
</pre>
<p>Note that there is no need to deallocate the memory used by the incoming
string. Memory for the outgoing string is allocated at line 8, then it
is initialized at the following line. The memory allocated at line 8
will be automatically freed by the usage of the <em>Command::insert()</em>
method. Using this schema, memory is allocated/freed each time the
command is executed. For constant string length, a statically allocated
buffer can be used.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">ConstDevString</span> <span class="name">MyDev</span><span class="operator">::</span><span class="name">dev_string</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevString</span> <span class="name">argin</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">ConstDevString</span>   <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>      <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;the received string is &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">argin</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>      <span class="name">argout</span> <span class="operator">=</span> <span class="literal string">&quot;Hello world&quot;</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>      <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>  <span class="punctuation">}</span>
</pre>
<p>A Tango::ConstDevString data type is used. It is not a new data Tango
data type. It has been introduced only to allows <em>Command::insert()</em>
method overloading. The argout pointer is initialized at line 7 with
memory statically allocated. In this case, no memory will be freed by
the <em>Command::insert()</em> method. There is also no memory copy in the
contrary of the previous example. A buffer defined as object data member
can also be used to set the argout pointer.</p>
</div>
<div class="section" id="for-array-sequence">
<h4>For array/sequence<a class="headerlink" href="#for-array-sequence" title="Permalink to this headline">¶</a></h4>
<p>Example of a method returning a Tango::DevVarLongArray is detailed just
below</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span> <span class="operator">*</span><span class="name">MyDev</span><span class="operator">::</span><span class="name">dev_array</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span>  <span class="operator">*</span><span class="name">argout</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span><span class="punctuation">();</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>      <span class="keyword type">long</span> <span class="name">output_array_length</span> <span class="operator">=</span> <span class="punctuation">...;</span>
<span class="ln"> 6 </span>      <span class="name">argout</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">(</span><span class="name">output_array_length</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>      <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">output_array_length</span><span class="punctuation">;</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 8 </span>          <span class="punctuation">(</span><span class="operator">*</span><span class="name">argout</span><span class="punctuation">)[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>      <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln">11 </span>  <span class="punctuation">}</span>
</pre>
<p>In this case, memory is allocated at line 3 and 6. Then, the sequence is
populated. The sequence is created and returned using pointer. The
<em>Command::insert()</em> method will insert the sequence into the CORBA::Any
object using this pointer. Therefore, the CORBA::Any object will take
ownership of the allocated memory. It will free it when it will be
destroyed by the CORBA ORB after the data have been sent away. It is
also possible to use a statically allocated memory and to avoid copying
in the sequence used to returned the data. This is explained in the
following example assuming a buffer of long data is declared as device
data member and named buffer.</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span> <span class="operator">*</span><span class="name">MyDev</span><span class="operator">::</span><span class="name">dev_array</span><span class="punctuation">()</span>
<span class="ln">2 </span>  <span class="punctuation">{</span>
<span class="ln">3 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span>  <span class="operator">*</span><span class="name">argout</span><span class="punctuation">;</span>
<span class="ln">4 </span>
<span class="ln">5 </span>      <span class="keyword type">long</span> <span class="name">output_array_length</span> <span class="operator">=</span> <span class="punctuation">...;</span>
<span class="ln">6 </span>      <span class="name">argout</span> <span class="operator">=</span> <span class="name">create_DevVarLongArray</span><span class="punctuation">(</span><span class="name">buffer</span><span class="punctuation">,</span><span class="name">output_array_length</span><span class="punctuation">);</span>
<span class="ln">7 </span>      <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln">8 </span>  <span class="punctuation">}</span>
</pre>
<p>At line 3 only a pointer to a DevVarLongArray is defined. This pointer
is set at line 6 using the <em>create_DevVarLongArray()</em> method. This
method will create a sequence using this buffer without memory
allocation and with minimum copying. The <em>Command::insert()</em> method used
here is the same than the one used in the previous example. The sequence
is created in a way that the destruction of the CORBA::Any object in
which the sequence will be inserted will not destroy the buffer. The
following create_xxx methods are defined in the DeviceImpl class :</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method name</th>
<th class="head">data type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>create_DevVarCharArray()</td>
<td>unsigned char</td>
</tr>
<tr class="row-odd"><td>create_DevVarShortArray()</td>
<td>short</td>
</tr>
<tr class="row-even"><td>create_DevVarLongArray()</td>
<td>DevLong</td>
</tr>
<tr class="row-odd"><td>create_DevVarLong64Array()</td>
<td>DevLong64</td>
</tr>
<tr class="row-even"><td>create_DevVarFloatArray()</td>
<td>float</td>
</tr>
<tr class="row-odd"><td>create_DevVarDoubleArray()</td>
<td>double</td>
</tr>
<tr class="row-even"><td>create_DevVarUShortArray()</td>
<td>unsigned short</td>
</tr>
<tr class="row-odd"><td>create_DevVarULongArray()</td>
<td>DevULong</td>
</tr>
<tr class="row-even"><td>create_DevVarULong64Array()</td>
<td>DevULong64</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="for-string-array-sequence">
<h4>For string array/sequence<a class="headerlink" href="#for-string-array-sequence" title="Permalink to this headline">¶</a></h4>
<p>Example of a method returning a Tango::DevVarStringArray is detailed
just below</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="operator">*</span><span class="name">MyDev</span><span class="operator">::</span><span class="name">dev_str_array</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="operator">*</span><span class="name">argout</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span><span class="punctuation">();</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>     <span class="name">argout</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">);</span>
<span class="ln"> 6 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">argout</span><span class="punctuation">)[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Rumba&quot;</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">argout</span><span class="punctuation">)[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Waltz&quot;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>     <span class="name">string</span> <span class="name function">str</span><span class="punctuation">(</span><span class="literal string">&quot;Jerck&quot;</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>     <span class="punctuation">(</span><span class="operator">*</span><span class="name">argout</span><span class="punctuation">)[</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="name">str</span><span class="punctuation">.</span><span class="name">c_str</span><span class="punctuation">());</span>
<span class="ln">10 </span>     <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln">11 </span>  <span class="punctuation">}</span>
</pre>
<p>Memory is allocated at line 3 and 5. Then, the sequence is populated at
lines 6,7 and 9. The usage of the <em>CORBA::string_dup</em> function also
allocates memory. The sequence is created and returned using pointer.
The <em>Command::insert()</em> method will insert the sequence into the
CORBA::Any object using this pointer. Therefore, the CORBA::Any object
will take ownership of the allocated memory. It will free it when it
will be destroyed by the CORBA ORB after the data have been sent away.
For portability reason, the ORB uses the <em>CORBA::string_free</em> function
to free the memory allocated for each string. This is why the
corresponding <em>CORBA::string_du</em>p or <em>CORBA::string_alloc</em> function
must be used to reserve this memory.It is also possible to use a
statically allocated memory and to avoid copying in the sequence used to
returned the data. This is explained in the following example assuming a
buffer of pointer to char is declared as device data member and named
int_buffer.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="operator">*</span><span class="name">DocDs</span><span class="operator">::</span><span class="name">dev_str_array</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="name">int_buffer</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal string">&quot;first&quot;</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>     <span class="name">int_buffer</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal string">&quot;second&quot;</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="operator">*</span><span class="name">argout</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>     <span class="name">argout</span> <span class="operator">=</span> <span class="name">create_DevVarStringArray</span><span class="punctuation">(</span><span class="name">int_buffer</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>     <span class="keyword">return</span> <span class="name">argout</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>  <span class="punctuation">}</span>
</pre>
<p>The intermediate buffer is initialized with statically allocated memory
at lines 3 and 4. The returned sequence is created at line 7 with the
<em>create_DevVarStringArray()</em> method. Like for classical array, the
sequence is created in a way that the destruction of the CORBA::Any
object in which the sequence will be inserted will not destroy the
buffer.</p>
</div>
<div class="section" id="for-tango-composed-types">
<h4>For Tango composed types<a class="headerlink" href="#for-tango-composed-types" title="Permalink to this headline">¶</a></h4>
<p>Tango supports only two composed types which are
Tango::DevVarLongStringArray and Tango::DevVarDoubleStringArray. These
types are translated to C++ structure with two sequences. It is not
possible to use memory statically allocated for these types. Each
structure element must be initialized as described in the previous
sub-chapters using the dynamically allocated memory case.</p>
</div>
</div>
<div class="section" id="reporting-errors">
<h3>Reporting errors<a class="headerlink" href="#reporting-errors" title="Permalink to this headline">¶</a></h3>
<p>Tango uses the C++ try/catch plus exception mechanism to report errors.
Two kind of errors can be transmitted between client and server :</p>
<ol class="arabic simple">
<li>CORBA system error. These exceptions are raised by the ORB and
indicates major failures (A communication failure, An invalid object
reference…)</li>
<li>CORBA user exception. These kind of exceptions are defined in the IDL
file. This allows an exception to contain an arbitrary amount of
error information of arbitrary type.</li>
</ol>
<p>TANGO defines one user exception called <strong>DevFailed</strong>. This exception is
a variable length array of <strong>DevError</strong> type (a sequence of DevError).
The DevError type is a four fields structure. These fields are :</p>
<ol class="arabic simple">
<li>A string describing the type of the error. This string replaces an
error code and allows a more easy management of include files.</li>
<li>The error severity. It is an enumeration with the three values which
are WARN, ERR or PANIC.</li>
<li>A string describing in plain text the reason of the error</li>
<li>A string describing the origin of the error</li>
</ol>
<p>The Tango::DevFailed type is a sequence of DevError structures in order
to transmit to the client what is the primary error reason when several
classes are used within a command. The sequence element 0 must be the
DevError structure describing the primary error. A method called
<em>print_exception</em>() defined in the Tango::Except class prints the
content of exception (CORBA system exception or Tango::DevFailed
exception). Some static methods of the Tango::Except class called
<em>throw_exception</em>() can be used to throw Tango::DevFailed exception.
Some other static methods called <em>re_throw_exception()</em> may also be
used when the user want to add a new element in the exception sequence
and re-throw the exception. Details on these methods can be found in
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id36">[TangoRefMan]</a>.</p>
<div class="section" id="example-of-throwing-exception">
<h4>Example of throwing exception<a class="headerlink" href="#example-of-throwing-exception" title="Permalink to this headline">¶</a></h4>
<p>This example is a piece of code from the <em>command_handler</em>() method
of the DeviceImpl class. An exception is thrown to the client to
indicate that the requested command is not defined in the command list.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>    <span class="name">TangoSys_OMemStream</span> <span class="name">o</span><span class="punctuation">;</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span>    <span class="name">o</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Command &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">command</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; not found&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">ends</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">Except</span><span class="operator">::</span><span class="name">throw_exception</span><span class="punctuation">(</span><span class="literal string">&quot;API_CommandNotFound&quot;</span><span class="punctuation">,</span>
<span class="ln"> 5 </span>                                <span class="name">o</span><span class="punctuation">.</span><span class="name">str</span><span class="punctuation">(),</span>
<span class="ln"> 6 </span>                                <span class="literal string">&quot;DeviceClass::command_handler&quot;</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>    <span class="keyword">try</span>
<span class="ln">10 </span>    <span class="punctuation">{</span>
<span class="ln">11 </span>        <span class="punctuation">.....</span>
<span class="ln">12 </span>    <span class="punctuation">}</span>
<span class="ln">13 </span>    <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevFailed</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">14 </span>    <span class="punctuation">{</span>
<span class="ln">15 </span>        <span class="name">TangoSys_OMemStream</span> <span class="name">o</span><span class="punctuation">;</span>
<span class="ln">16 </span>
<span class="ln">17 </span>        <span class="name">o</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Command &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">command</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; not found&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">ends</span><span class="punctuation">;</span>
<span class="ln">18 </span>        <span class="name">Tango</span><span class="operator">::</span><span class="name">Except</span><span class="operator">::</span><span class="name">re_throw_exception</span><span class="punctuation">(</span><span class="name">e</span><span class="punctuation">,</span>
<span class="ln">19 </span>                                  <span class="literal string">&quot;API_CommandNotFound&quot;</span><span class="punctuation">,</span>
<span class="ln">20 </span>                                  <span class="name">o</span><span class="punctuation">.</span><span class="name">str</span><span class="punctuation">(),</span>
<span class="ln">21 </span>                                  <span class="literal string">&quot;DeviceClass::command_handler&quot;</span><span class="punctuation">);</span>
<span class="ln">22 </span>    <span class="punctuation">}</span>
</pre>
<p>Line 1 : Build a memory stream. Use the TangoSys_MemStream because
memory streams are not managed the same way between Windows and Unix</p>
<p>Line 3 : Build the reason string in the memory stream</p>
<p>Line 4-5 : Throw the exception to client using one of the
<em>throw_exception</em> static method of the Except class. This
throw_exception method used here allows the definition of the error
type string, the reason string and the origin string of the DevError
structure. The remaining DevError field (the error severity) will be set
to its default value. Note that the first and third parameters are
casted to a <em>const char *</em>. Standard C++ defines that such a string is
already a <em>const char *</em> but the GNU C++ compiler (release 2.95) does
not use this type inside its function overloading but rather uses a
<em>char *</em> which leads to calling the wrong function.</p>
<p>Line 13-22 : Re-throw an already catched tango::DevFailed exception with
one more element in the exception sequence.</p>
</div>
</div>
</div>
<div class="section" id="the-tango-logging-service">
<h2>The Tango Logging Service<a class="headerlink" href="#the-tango-logging-service" title="Permalink to this headline">¶</a></h2>
<p>A first introduction about this logging service has been done in chapter
[sec:The-Tango-Logging]</p>
<p>The TANGO Logging Service (TLS) gives the user the control over how much
information is actually generated and to where it goes. In practice, the
TLS allows to select both the logging level and targets of any device
within the control system.</p>
<div class="section" id="logging-targets">
<h3>Logging Targets<a class="headerlink" href="#logging-targets" title="Permalink to this headline">¶</a></h3>
<p>The TLS implementation allows each device logging requests to print
simultaneously to multiple destinations. In the TANGO terminology, an
output destination is called a <strong>logging target</strong>. Currently, targets
exist for console, file and log consumer device.</p>
<p>CONSOLE: logs are printed to the console (i.e. the standard output),</p>
<p>FILE: logs are stored in a XML file. A rolling mechanism is used to
backup the log file when it reaches a certain size (see below),</p>
<p>DEVICE: logs are sent to a device implementing a well known TANGO
interface (see section [sec:Tango-log-consumer] for a definition of the
log consumer interface). One implementation of a log consumer associated
to a graphical user interface is available within the Tango package. It
is called the LogViewer.</p>
<p>The device’s logging behavior can be control by adding and/or removing
targets.</p>
<p>Note : When the size of a log file (for file logging target) reaches the
so-called rolling-file-threshold (rft), it is backuped as
current_log_file_name + _1 and a new current_log_file_name is
opened. Obviously, there is only one backup file at a time (i.e. any
existing backup is destroyed before the current log file is backuped).
The default threshold is 20 Mb, the minimum is 500 Kb and the maximum is
1000 Mb.</p>
</div>
<div class="section" id="logging-levels">
<h3>Logging Levels<a class="headerlink" href="#logging-levels" title="Permalink to this headline">¶</a></h3>
<p>Devices can be assigned a logging level. It acts as a filter to control
the kind of information sent to the targets. Since, there are (usually)
much more low level log statements than high level statements, the
logging level also control the amount of information produced by the
device. The TLS provides the following levels (semantic is just given to
be indicative of what could be log at each level):</p>
<p>OFF: Nothing is logged</p>
<p>FATAL: A fatal error occurred. The process is about to abort</p>
<p>ERROR: An (unrecoverable) error occurred but the process is still alive</p>
<p>WARN: An error occurred but could be recovered locally</p>
<p>INFO: Provides information on important actions performed</p>
<p>DEBUG: Generates detailed information describing the internal behavior
of a device</p>
<p>Levels are ordered the following way:</p>
<p>DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF</p>
<p>For a given device, a level is said to be enabled if it is greater or
equal to the logging level assigned to this device. In other words, any
logging request which level is lower than the device’s logging level is
ignored.</p>
<p>Note: The logging level can’t be controlled at target level. The
device’s targets shared the same device logging level.</p>
</div>
<div class="section" id="sending-tango-logging-messages">
<h3>Sending TANGO Logging Messages<a class="headerlink" href="#sending-tango-logging-messages" title="Permalink to this headline">¶</a></h3>
<div class="section" id="logging-macros-in-c">
<h4>Logging macros in C++<a class="headerlink" href="#logging-macros-in-c" title="Permalink to this headline">¶</a></h4>
<p>The TLS provides the user with easy to use C++ macros with <em>printf</em> and
<em>stream</em> like syntax. For each logging level, a macro is defined in both
styles:</p>
<ul class="simple">
<li>LOG_{FATAL, ERROR, WARN, INFO or DEBUG}</li>
<li>{FATAL, ERROR, WARN, INFO or DEBUG}_STREAM</li>
</ul>
<p>These macros are supposed to be used within the device’s main
implementation class (i.e. the class that inherits (directly or
indirectly) from the Tango::DeviceImpl class). In this context, they
produce logging messages containing the device name. In other words,
they automatically identify the log source. Section [sub:C++-logging-in]
gives a trick to log in the name of device outside its main
implementation class. Printf like example:</p>
<p>LOG_DEBUG((Msg#%d - Hello world, i++));</p>
<p>Stream like example:</p>
<p>DEBUG_STREAM &lt;&lt; Msg# &lt;&lt; i++ &lt;&lt; - Hello world &lt;&lt; endl;</p>
<p>These two logging requests are equivalent. Note the double parenthesis
in the printf version.</p>
</div>
<div class="section" id="c-logging-in-the-name-of-a-device">
<h4>C++ logging in the name of a device<a class="headerlink" href="#c-logging-in-the-name-of-a-device" title="Permalink to this headline">¶</a></h4>
<p>A device implementation is sometimes spread over several classes. Since
all these classes implement the same device, their logging requests
should be associated with this device name. Unfortunately, the C++
logging macros can’t be used because they are outside the device’s main
implementation class. The Tango::LogAdapter class is a workaround for
this limitation.</p>
<p>Any method not member of the device’s main implementation class, which
send log messages associated to a device must be a member of a class
inheriting from the Tango::LogAdapter class. Here is an example:</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="keyword">class</span> <span class="name class">MyDeviceActualImpl</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">LogAdapter</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span> <span class="keyword">public</span> <span class="operator">:</span>
<span class="ln"> 4 </span>    <span class="name">MyDeviceActualImpl</span><span class="punctuation">(...,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">device</span><span class="punctuation">,...)</span>
<span class="ln"> 5 </span>    <span class="operator">:</span><span class="name">Tango</span><span class="operator">::</span><span class="name">LogAdpater</span><span class="punctuation">(</span><span class="name">device</span><span class="punctuation">)</span>
<span class="ln"> 6 </span>    <span class="punctuation">{</span>
<span class="ln"> 7 </span>          <span class="punctuation">....</span>
<span class="ln"> 8 </span> <span class="comment single">//
</span><span class="ln"> 9 </span><span class="comment single"></span> <span class="comment single">// The following log is associated to the device passed to the constructor
</span><span class="ln">10 </span><span class="comment single"></span> <span class="comment single">//
</span><span class="ln">11 </span><span class="comment single"></span>         <span class="name">DEBUG_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In MyDeviceActualImpl constructor&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">12 </span>
<span class="ln">13 </span>         <span class="punctuation">....</span>
<span class="ln">14 </span>    <span class="punctuation">}</span>
<span class="ln">15 </span> <span class="punctuation">};</span>
</pre>
</div>
</div>
</div>
<div class="section" id="writing-a-device-server-process">
<h2>Writing a device server process<a class="headerlink" href="#writing-a-device-server-process" title="Permalink to this headline">¶</a></h2>
<p>Writing a device server can be made easier by adopting the correct
approach. This chapter will describe how to write a device server
process. It is divided into the following parts : understanding the
device, defining device commands/attributes/pipes, choosing device state
and writing the necessary classes. All along this chapter, examples will
be given using the stepper motor device server. Writing a device server
for our stepper motor example device means writing :</p>
<ul class="simple">
<li>The <em>main</em> function</li>
<li>The <em>class_factory</em> method (only for C++ device server)</li>
<li>The <em>StepperMotorClass</em> class</li>
<li>The <em>DevReadPositionCmd</em> and <em>DevReadDirectionCmd</em> classes</li>
<li>The <em>PositionAttr</em>, <em>SetPositionAttr</em> and <em>DirectionAttr</em> classes</li>
<li>The <em>StepperMotor</em> class.</li>
</ul>
<p>All these functions and classes will be detailed. The stepper motor
device server described in this chapter supports 2 commands and 3
attributes which are :</p>
<ul class="simple">
<li>Command DevReadPosition implemented using the inheritance model</li>
<li>Command DevReadDirection implemented using the template command model</li>
<li>Attribute Position (position of the first motor). This attribute is
readable and is linked with a writable attribute (called
SetPosition). When the value of this attribute is requested by the
client, the value of the associated writable attribute is also
returned.</li>
<li>Attribute SetPosition (writable attribute linked with the Position
attribute). This attribute has some properties with user defined
default value.</li>
<li>Attribute Direction (direction of the first motor)</li>
</ul>
<p>As the reader will understand during the reading of the following
sub-chapters, the command and attributes classes (<em>DevReadPositionCmd</em>,
<em>DevReadDirectionCmd</em>, <em>PositionAttr</em>, <em>SetPositionAttr</em> and
<em>DirectionAttr</em>) are very simple classes. A tool called <strong>Pogo</strong> has
been developped to automatically generate/maintain these classes and to
write part of the code needed in the remaining one. See xx to know more
on this Pogo tool.</p>
<p>In order to also gives an example of how the database objects part of
the Tango device pattern could be used, our device have two properties.
These properties are of the Tango long data types and are named “Max”
and “Min”.</p>
<div class="section" id="understanding-the-device">
<h3>Understanding the device<a class="headerlink" href="#understanding-the-device" title="Permalink to this headline">¶</a></h3>
<p>The first step before writing a device server is to develop an
understanding of the hardware to be programmed. The Equipment
Responsible should have description of the hardware and its operating
modes (manuals, spec sheets etc.). The Equipment Responsible must also
provide specifications of what the device server should do. The Device
Server Programmer should demand an exact description of the registers,
alarms, interlocks and any timing constraints which have to be kept. It
is very important to have a good understanding of the device interfacing
before starting designing a new class.</p>
<p>Once the Device Server Programmer has understood the hardware the next
important step is to define what is a logical device i.e. what part of
the hardware will be abstracted out and treated as a logical device. In
doing so the following points of the TDSOM should be kept in mind</p>
<ul class="simple">
<li>Each device is known and accessed by its ascii name.</li>
<li>The device is exported onto the network to be imported by
applications.</li>
<li>Each device belongs to a class.</li>
<li>A list of commands exists per device.</li>
<li>Applications use the device server api to execute commands on a
device.</li>
</ul>
<p>The above points have to be taken into account when designing the level
of device abstraction. The definition of what is a device for a certain
hardware is primarily the job of the Device Server Programmer and the
Applications Programmer but can also involve the Equipment Responsible.
The Device Server Programmer should make sure that the Applications
Programmer agrees with her definition of what is a device.</p>
<p>Here are some guidelines to follow while defining the level of device
abstraction -</p>
<ul class="simple">
<li><strong>efficiency</strong>, make sure that not a too fine level of device
abstraction has been chosen. If possible group as many attributes
together to form a device. Discuss this with the Applications
Programmer to find out what is efficient for her application.</li>
<li><strong>hardware independency</strong>, one of the main reasons for writing device
servers is to provide the Applications Programmer with a <em>software</em>
interface as opposed to a <em>hardware</em> interface. Hide the hardware
structure of the device. For example if the user is only interested
in a single channel of a multichannel device then define each channel
to be a logical device. The user should not be aware of hardware
addresses or cabling details. The user is very often a scientist who
has a physics-oriented world view and not a hardware-oriented world
view. Hardware independency also has the advantage that applications
are immune to hardware changes to the device</li>
<li><strong>object oriented world view</strong>, another <em>raison d’etre</em> behind the
device server model is to build up an object oriented view of the
world. The device should resemble the user’s view of the object as
closely as possible. In the case of the ESRF’s beam lines for
example, the devices should resemble beam line scientist’s view of
the machine.</li>
<li><strong>atomism</strong>, each device can be considered like an atom - is a
independent object. It should appear independent to the client even
if behind the scenes it shares some hardware or software with other
objects. This is often the case with multichannel devices where the
user would like to see each channel as a device but it is obvious
that the channels cannot be programmed completely independently. The
logical device is there to hide or make transparent this fact. If it
is impossible to send commands to one device without modifying
another device then a single device should be made out the two
devices.</li>
<li><strong>tailored</strong> <em>vs</em> <strong>general</strong>, one of the philosophies of the TDSOM
is to provide tailored solutions. For example instead of writing one
<em>serial line</em> class which treats the general case of a serial line
device and leaving the device protocol to be implemented in the
client the TDSOM advocates implementing a device class which handles
the protocol of the device. This way the client only has to know the
commands of the class and not the details of the protocol. Nothing
prevents the device class from using a general purpose serial line
class if it exists of course.</li>
</ul>
</div>
<div class="section" id="defining-device-commands">
<h3>Defining device commands<a class="headerlink" href="#defining-device-commands" title="Permalink to this headline">¶</a></h3>
<p>Each device has a list of commands which can be executed by the
application across the network or locally. These commands are the
Application Programmer’s network knobs and dials for interacting with
the device.</p>
<p>The list of commands to be implemented depends on the capabilities of
the hardware, the list of sensible functions which can be executed at a
distance and of course the functionality required by the application.
This implies a close collaboration between the Equipment Responsible,
Device Server Programmer and the Application Programmer.</p>
<p>When drawing up the list of commands particular attention should be paid
to the following points</p>
<ul class="simple">
<li><strong>performance</strong>, no single command should monopolize the device
server for a long time (a nominal value for long is one second).
Commands should be implemented in such a way that it executes
immediately returning with a response. At best try to keep command
execution time down to less than the typical overhead of an rpc call
i.e. som milliseconds. This of course is not always possible e.g. a
serial line device could require 100 milliseconds of protocol
exchange. The Device Server Programmer should find the best trade-off
between the users requirements and the devices capabilities. If a
command implies a sequence of events which could last for a long time
then implement the sequence of events in another thread - don’t block
the device server.</li>
<li><strong>robustness</strong>, should be provided which allow the client to recover
from error conditions and or do a warm startup.</li>
</ul>
<div class="section" id="standard-commands">
<h4>Standard commands<a class="headerlink" href="#standard-commands" title="Permalink to this headline">¶</a></h4>
<p>A minimum set of three commands exist for all devices. These commands
are</p>
<ul class="simple">
<li>State which returns the state of a device</li>
<li>Status which returns the status of the device as a formatted ascii
string</li>
<li>Init which re-initialize a device without changing its network
connection</li>
</ul>
<p>These commands have already been discussed in [Auto_cmd]</p>
</div>
</div>
<div class="section" id="choosing-device-state">
<span id="choosingdevicestate-deviceserverwriting"></span><h3>Choosing device state<a class="headerlink" href="#choosing-device-state" title="Permalink to this headline">¶</a></h3>
<p>The device state is a number which reflects the availability of the
device. To simplify the coding for generic application, a predefined set
of states are supported by TANGO. This list has 14 members which are</p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">State name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ON</td>
</tr>
<tr class="row-odd"><td>OFF</td>
</tr>
<tr class="row-even"><td>CLOSE</td>
</tr>
<tr class="row-odd"><td>OPEN</td>
</tr>
<tr class="row-even"><td>INSERT</td>
</tr>
<tr class="row-odd"><td>EXTRACT</td>
</tr>
<tr class="row-even"><td>MOVING</td>
</tr>
<tr class="row-odd"><td>STANDBY</td>
</tr>
<tr class="row-even"><td>FAULT</td>
</tr>
<tr class="row-odd"><td>INIT</td>
</tr>
<tr class="row-even"><td>RUNNING</td>
</tr>
<tr class="row-odd"><td>ALARM</td>
</tr>
<tr class="row-even"><td>DISABLE</td>
</tr>
<tr class="row-odd"><td>UNKNOWN</td>
</tr>
</tbody>
</table>
<p>The names used here have obvious meaning.</p>
</div>
<div class="section" id="device-server-utilities-to-ease-coding-debugging">
<h3>Device server utilities to ease coding/debugging<a class="headerlink" href="#device-server-utilities-to-ease-coding-debugging" title="Permalink to this headline">¶</a></h3>
<p>The device server framework supports one set of utilities to ease the
process of coding and debugging device server code. This utility is :</p>
<ol class="arabic simple">
<li>The device server verbose option</li>
</ol>
<p>Using this facility avoids the usage of the classical “#ifdef DEBUG”
style which makes code less readable.</p>
<div class="section" id="the-device-server-verbose-option">
<h4>The device server verbose option<a class="headerlink" href="#the-device-server-verbose-option" title="Permalink to this headline">¶</a></h4>
<p>Each device server supports a verbose option called <strong>-v</strong>. Four verbose
levels are defined from 1 to 4. Level 4 is the most talkative one. If
you use the -v option without specifying level, level 4 will be assumed.</p>
<p>Since Tango release 3, a Tango Logging Service has been introduced
(detailed in chapter [The-Tango-Logging chapter]). This -v option set-up
the logging service. If it used, it will automatically add a <em>console</em>
target to all devices embedded within the device server process. Level 1
and 2 will set the logging level to all devices embedded within the
device server to INFO. Level 3 and 4 will set the logging level to all
devices embedded within the device server to DEBUG. All messages sent by
the API layer are associated to the administration device.</p>
</div>
<div class="section" id="c-utilities-to-ease-device-server-coding">
<h4>C++ utilities to ease device server coding<a class="headerlink" href="#c-utilities-to-ease-device-server-coding" title="Permalink to this headline">¶</a></h4>
<p>Some utilities functions have been added in the C++ release to ease
Tango device server development. These utilities allow the user to</p>
<ul class="simple">
<li>Init a C++ vector from a data of one of the Tango DevVarXXXArray data
types</li>
<li>Init a data of one of the Tango::DevVarxxxArray data type from a C++
vector</li>
<li>Print a data of one of Tango::DevVarxxxArray data type</li>
</ul>
<p>They mainly used the “&lt;&lt;” operator overloading features. The following
code lines are an example of usage of these utilities.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>    <span class="name">vector</span><span class="operator">&lt;</span><span class="name">string</span><span class="operator">&gt;</span> <span class="name">v1</span><span class="punctuation">;</span>
<span class="ln"> 2 </span>    <span class="name">v1</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;one&quot;</span><span class="punctuation">);</span>
<span class="ln"> 3 </span>    <span class="name">v1</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;two&quot;</span><span class="punctuation">);</span>
<span class="ln"> 4 </span>    <span class="name">v1</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;three&quot;</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="name">s</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>    <span class="name">s</span> <span class="operator">&lt;&lt;</span> <span class="name">v1</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>    <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="name">s</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>    <span class="name">vector</span><span class="operator">&lt;</span><span class="name">string</span><span class="operator">&gt;</span> <span class="name">v2</span><span class="punctuation">;</span>
<span class="ln">11 </span>    <span class="name">v2</span> <span class="operator">&lt;&lt;</span> <span class="name">s</span><span class="punctuation">;</span>
<span class="ln">12 </span>
<span class="ln">13 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">v2</span><span class="punctuation">.</span><span class="name">size</span><span class="punctuation">();</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln">14 </span>       <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;vector element = &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">v2</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
</pre>
<p>Line 1-4 : Create and Init a C++ string vector</p>
<p>Line 7 : Init a Tango::DevVarStringArray data from the C++ vector</p>
<p>Line 8 : Print all the Tango::DevVarStringArray element in one line of
code.</p>
<p>Line 11 : Init a second empty C++ string vector with the content of the
Tango::DevVarStringArray</p>
<div class="line-block">
<div class="line">Line 13-14 : Print vector element</div>
<div class="line"><strong>Warning</strong>: Note that due to a strange behavior of the Windows VC++
compiler compared to other compilers, to use these utilities with the
Windows VC++ compiler, you must add the line “using namespace tango”
at the beginning of your source file.</div>
</div>
</div>
</div>
<div class="section" id="avoiding-name-conflicts">
<h3>Avoiding name conflicts<a class="headerlink" href="#avoiding-name-conflicts" title="Permalink to this headline">¶</a></h3>
<p>Namespace are used to avoid name conflicts. Each device pattern
implementation is defined within its own namespace. The name of the
namespace is the device pattern class name. In our example, the
namespace name is <em>StepperMotor.</em></p>
</div>
<div class="section" id="the-device-server-main-function">
<h3>The device server main function<a class="headerlink" href="#the-device-server-main-function" title="Permalink to this headline">¶</a></h3>
<p>A device server main function (or method) always follows the same
framework. It exactly implements all the action described in chapter
[Server_startup]. Even if it could be always the same, it has not been
included in the library because some linkers are perturbed by the
presence of two main functions.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span>  <span class="keyword type">int</span> <span class="name function">main</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">*</span><span class="name">argv</span><span class="punctuation">[])</span>
<span class="ln"> 4 </span>  <span class="punctuation">{</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>      <span class="keyword">try</span>
<span class="ln"> 9 </span>      <span class="punctuation">{</span>
<span class="ln">10 </span>
<span class="ln">11 </span>          <span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>          <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_init</span><span class="punctuation">();</span>
<span class="ln">14 </span>
<span class="ln">15 </span>          <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Ready to accept request&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">16 </span>          <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_run</span><span class="punctuation">();</span>
<span class="ln">17 </span>      <span class="punctuation">}</span>
<span class="ln">18 </span>      <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">19 </span>      <span class="punctuation">{</span>
<span class="ln">20 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Can't allocate memory!!!&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">21 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Exiting&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">22 </span>      <span class="punctuation">}</span>
<span class="ln">23 </span>      <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">Exception</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">24 </span>      <span class="punctuation">{</span>
<span class="ln">25 </span>           <span class="name">Tango</span><span class="operator">::</span><span class="name">Except</span><span class="operator">::</span><span class="name">print_exception</span><span class="punctuation">(</span><span class="name">e</span><span class="punctuation">);</span>
<span class="ln">26 </span>
<span class="ln">27 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Received a CORBA::Exception&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">28 </span>           <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Exiting&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">29 </span>      <span class="punctuation">}</span>
<span class="ln">30 </span>
<span class="ln">31 </span>      <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_cleanup</span><span class="punctuation">();</span>
<span class="ln">32 </span>
<span class="ln">33 </span>      <span class="keyword">return</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">);</span>
<span class="ln">34 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 1 : Include the <strong>tango.h</strong> file. This file is a master include
file. It includes several other files. The list of files included by
tango.h can be found in <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id37">[TangoRefMan]</a></p>
<p>Line 11 : Create the instance of the Tango::Util class (a singleton).
Passing argc,argv to this method is mandatory because the device server
command line is checked when the Tango::Util object is constructed.</p>
<p>Line 13 : Start all the device pattern creation and initialization with
the <em>server_init()</em> method</p>
<p>Line 16 : Put the server in a endless waiting loop with the
<em>server_run()</em> method. In normal case, the process should never returns
from this line.</p>
<p>Line 18-22 : Catch all exceptions due to memory allocation error,
display a message to the user and exit</p>
<p>Line 23 : Catch all standard TANGO exception which could occur during
device pattern creation and initialization</p>
<p>Line 25 : Print exception parameters</p>
<p>Line 27-28 : Print an additional message</p>
<p>Line 31 : Cleanup the server before exiting by calling the
<em>server_cleanup()</em> method.</p>
</div>
<div class="section" id="the-dserver-class-factory-method">
<h3>The DServer::class_factory method<a class="headerlink" href="#the-dserver-class-factory-method" title="Permalink to this headline">¶</a></h3>
<p>As described in chapter [DServer_class], C++ device server needs a
<em>class_factory</em>() method. This method creates all the device pattern
implemented in the device server by calling their <em>init</em>() method. The
following is an example of a <em>class_factory</em> method for a device server
with one implementation of the device server pattern for stepper motor
device.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;steppermotorclass.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword type">void</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DServer</span><span class="operator">::</span><span class="name">class_factory</span><span class="punctuation">()</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>     <span class="name">add_class</span><span class="punctuation">(</span><span class="name">StepperMotor</span><span class="operator">::</span><span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="literal string">&quot;StepperMotor&quot;</span><span class="punctuation">));</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 1 : Include the Tango master include file</p>
<p>Line 2 : Include the steppermotorclass class definition file</p>
<p>Line 7 : Create the StepperMotorClass singleton by calling its <em>init</em>
method and stores the returned pointer into the DServer object. Remember
that all classes for the device pattern implementation for the stepper
motor class is defined within a namespace called <em>StepperMotor</em>.</p>
</div>
<div class="section" id="writing-the-steppermotorclass-class">
<h3>Writing the StepperMotorClass class<a class="headerlink" href="#writing-the-steppermotorclass-class" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-class-declaration-file">
<h4>The class declaration file<a class="headerlink" href="#the-class-declaration-file" title="Permalink to this headline">¶</a></h4>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span>  <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 4 </span>  <span class="punctuation">{</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>  <span class="keyword">class</span> <span class="name class">StepperMotorClass</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span>
<span class="ln"> 7 </span>  <span class="punctuation">{</span>
<span class="ln"> 8 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 9 </span>      <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name">init</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">10 </span>      <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name function">instance</span><span class="punctuation">();</span>
<span class="ln">11 </span>      <span class="operator">~</span><span class="name">StepperMotorClass</span><span class="punctuation">()</span> <span class="punctuation">{</span><span class="name">_instance</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;}</span>
<span class="ln">12 </span>
<span class="ln">13 </span>  <span class="keyword">protected</span><span class="operator">:</span>
<span class="ln">14 </span>      <span class="name">StepperMotorClass</span><span class="punctuation">(</span><span class="name">string</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">15 </span>      <span class="keyword">static</span> <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name">_instance</span><span class="punctuation">;</span>
<span class="ln">16 </span>      <span class="keyword type">void</span> <span class="name function">command_factory</span><span class="punctuation">();</span>
<span class="ln">17 </span>      <span class="keyword type">void</span> <span class="name function">attribute_factory</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span> <span class="operator">*&gt;</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">18 </span>
<span class="ln">19 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln">20 </span>      <span class="keyword type">void</span> <span class="name">device_factory</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarStringArray</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">21 </span>  <span class="punctuation">};</span>
<span class="ln">22 </span>
<span class="ln">23 </span>  <span class="punctuation">}</span> <span class="comment multiline">/* End of StepperMotor namespace */</span>
</pre>
<p>Line 1 : Include the Tango master include file</p>
<p>Line 3 : This class is defined within the <em>StepperMotor</em> namespace</p>
<p>Line 6 : Class StepperMotorClass inherits from Tango::DeviceClass</p>
<p>Line 9-10 : Definition of the <em>init</em> and <em>instance</em> methods. These
methods are static and can be called even if the object is not already
constructed.</p>
<p>Line 11: The destructor</p>
<p>Line 14 : The class constructor. It is protected and can’t be called
from outside the class. Only the <em>init</em> method allows a user to create
an instance of this class. See <a class="reference internal" href="../../reference/bibliography.html#patterns" id="id38">[Patterns]</a> to get
details about the singleton design pattern.</p>
<p>Line 15 : The instance pointer. It is static in order to set it to NULL
during process initialization phase</p>
<p>Line 16 : Definition of the <em>command_factory</em> method</p>
<p>Line 17 : Definition of the <em>attribute_factory</em> method</p>
<p>Line 20 : Definition of the <em>device_factory</em> method</p>
</div>
<div class="section" id="the-singleton-related-methods">
<h4>The singleton related methods<a class="headerlink" href="#the-singleton-related-methods" title="Permalink to this headline">¶</a></h4>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;steppermotor.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 4 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;steppermotorclass.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 5 </span><span class="comment preproc"></span>
<span class="ln"> 6 </span>  <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 7 </span>  <span class="punctuation">{</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>  <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">_instance</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">10 </span>
<span class="ln">11 </span>  <span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">StepperMotorClass</span><span class="punctuation">(</span><span class="name">string</span> <span class="operator">&amp;</span><span class="name">s</span><span class="punctuation">)</span><span class="operator">:</span>
<span class="ln">12 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span><span class="punctuation">(</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln">13 </span>  <span class="punctuation">{</span>
<span class="ln">14 </span>      <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Entering StepperMotorClass constructor&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">15 </span>
<span class="ln">16 </span>      <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Leaving StepperMotorClass constructor&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">17 </span>  <span class="punctuation">}</span>
<span class="ln">18 </span>
<span class="ln">19 </span>
<span class="ln">20 </span>  <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">name</span><span class="punctuation">)</span>
<span class="ln">21 </span>  <span class="punctuation">{</span>
<span class="ln">22 </span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">_instance</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span>
<span class="ln">23 </span>      <span class="punctuation">{</span>
<span class="ln">24 </span>            <span class="keyword">try</span>
<span class="ln">25 </span>            <span class="punctuation">{</span>
<span class="ln">26 </span>                 <span class="name">string</span> <span class="name">s</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">);</span>
<span class="ln">27 </span>                 <span class="name">_instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">StepperMotorClass</span><span class="punctuation">(</span><span class="name">s</span><span class="punctuation">);</span>
<span class="ln">28 </span>            <span class="punctuation">}</span>
<span class="ln">29 </span>            <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">30 </span>            <span class="punctuation">{</span>
<span class="ln">31 </span>                 <span class="keyword">throw</span><span class="punctuation">;</span>
<span class="ln">32 </span>            <span class="punctuation">}</span>
<span class="ln">33 </span>      <span class="punctuation">}</span>
<span class="ln">34 </span>      <span class="keyword">return</span> <span class="name">_instance</span><span class="punctuation">;</span>
<span class="ln">35 </span>  <span class="punctuation">}</span>
<span class="ln">36 </span>
<span class="ln">37 </span>  <span class="name">StepperMotorClass</span> <span class="operator">*</span><span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">()</span>
<span class="ln">38 </span>  <span class="punctuation">{</span>
<span class="ln">39 </span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">_instance</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span>
<span class="ln">40 </span>      <span class="punctuation">{</span>
<span class="ln">41 </span>            <span class="name">cerr</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Class is not initialised !!&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">42 </span>            <span class="name">exit</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">);</span>
<span class="ln">43 </span>      <span class="punctuation">}</span>
<span class="ln">44 </span>      <span class="keyword">return</span> <span class="name">_instance</span><span class="punctuation">;</span>
<span class="ln">45 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 1-4 : include files: the Tango master include file (tango.h), the
StepperMotorClass class definition file (steppermotorclass.h) and the
StepperMotor class definition file (steppermotor.h)</p>
<p>Line 6 : Open the <em>StepperMotor</em> namespace.</p>
<p>Line 9 : Initialize the static _instance field of the StepperMotorClass
class to NULL</p>
<p>Line 11-18 : The class constructor. It takes an input parameter which is
the controlled device class name. This parameter is passed to the
constructor of the DeviceClass class. Otherwise, the constructor does
nothing except printing a message</p>
<p>Line 20-35 : The <em>init</em> method. This method needs an input parameter
which is the controlled device class name (StepperMotor in this case).
This method checks is the instance is already constructed by testing the
_instance data member. If the instance is not constructed, it creates
one. If the instance is already constructed, the method simply returns a
pointer to it.</p>
<p>Line 37-45 : The <em>instance</em> method. This method is very similar to the
<em>init</em> method except that if the instance is not already constructed.
the method print a message and abort the process.</p>
<p>As you can understand, it is not possible to construct more than one
instance of the StepperMotorClass (it is a singleton) and the <em>init</em>
method must be called prior to any other method.</p>
</div>
<div class="section" id="the-command-factory-method">
<h4>The command_factory method<a class="headerlink" href="#the-command-factory-method" title="Permalink to this headline">¶</a></h4>
<p>Within our example, the stepper motor device supports two commands which
are called DevReadPosition and DevReadDirection. These two command takes
a Tango::DevLong argument as input and output parameter. The first
command is created using the inheritance model and the second command is
created using the template command model.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">command_factory</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>          <span class="name">command_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">DevReadPositionCmd</span><span class="punctuation">(</span><span class="literal string">&quot;DevReadPosition&quot;</span><span class="punctuation">,</span>
<span class="ln"> 4 </span>                                                        <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_LONG</span><span class="punctuation">,</span>
<span class="ln"> 5 </span>                                                        <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_LONG</span><span class="punctuation">,</span>
<span class="ln"> 6 </span>                                                        <span class="literal string">&quot;Motor number (0-7)&quot;</span><span class="punctuation">,</span>
<span class="ln"> 7 </span>                                                        <span class="literal string">&quot;Motor position&quot;</span><span class="punctuation">));</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>          <span class="name">command_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span>
<span class="ln">10 </span>              <span class="keyword">new</span> <span class="name">TemplCommandInOut</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span><span class="operator">&gt;</span>
<span class="ln">11 </span>                  <span class="punctuation">((</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">)</span><span class="literal string">&quot;DevReadDirection&quot;</span><span class="punctuation">,</span>
<span class="ln">12 </span>                   <span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Lg_CmdMethPtr_Lg</span><span class="operator">&gt;</span>
<span class="ln">13 </span>                          <span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">StepperMotor</span><span class="operator">::</span><span class="name">dev_read_direction</span><span class="punctuation">),</span>
<span class="ln">14 </span>                   <span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">StateMethPtr</span><span class="operator">&gt;</span>
<span class="ln">15 </span>                          <span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">StepperMotor</span><span class="operator">::</span><span class="name">direct_cmd_allowed</span><span class="punctuation">))</span>
<span class="ln">16 </span>                                <span class="punctuation">);</span>
<span class="ln">17 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 4 : Creation of one instance of the DevReadPositionCmd class. The
class is created with five arguments which are the command name, the
command type code for its input and output parameters and two strings
which are the command input and output parameters description. The
pointer returned by the new C++ keyword is added to the vector of
available command.</p>
<p>Line 10-14 : Creation of the object used for the DevReadDirection
command. This command has one input and output parameter. Therefore the
created object is an instance of the TemplCommandInOut class. This class
is a C++ template class. The first template parameter is the command
input parameter type, the second template parameter is the command
output parameter type. The second TemplCommandInOut class constructor
parameter (set at line 13) is a pointer to the method to be executed
when the command is requested. A casting is necessary to store this
pointer as a pointer to a method of the DeviceImpl class <a class="footnote-reference" href="#id64" id="id39">[3]</a>. The
third TemplCommandInOut class constructor parameter (set at line 15) is
a pointer to the method to be executed to check if the command is
allowed. This is necessary only if the default behavior (command always
allowed) does not fulfill the needs. A casting is necessary to store
this pointer as a pointer to a method of the DeviceImpl class. When a
command is created using the template command method, the input and
output parameters type are determined from the template C++ class
parameters.</p>
</div>
<div class="section" id="the-device-factory-method">
<h4>The device_factory method<a class="headerlink" href="#the-device-factory-method" title="Permalink to this headline">¶</a></h4>
<p>The <em>device_factory</em> method has one input parameter. It is a pointer to
Tango::DevVarStringArray data which is the device name list for this
class and the instance of the device server process. This list is fetch
from the Tango database.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">device_factory</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">_DevVarStringArray</span> <span class="operator">*</span><span class="name">devlist_ptr</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>
<span class="ln"> 4 </span>      <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">long</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">devlist_ptr</span><span class="operator">-&gt;</span><span class="name">length</span><span class="punctuation">();</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 5 </span>      <span class="punctuation">{</span>
<span class="ln"> 6 </span>           <span class="name">DEBUG_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Device name : &quot;</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="operator">*</span><span class="name">devlist_ptr</span><span class="punctuation">)[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>           <span class="name">device_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">,(</span><span class="operator">*</span><span class="name">devlist_ptr</span><span class="punctuation">)[</span><span class="name">i</span><span class="punctuation">]));</span>       <span class="literal number integer">9</span>
<span class="ln"> 9 </span>           <span class="name function">if</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">_UseDb</span> <span class="operator">==</span> <span class="name builtin">true</span><span class="punctuation">)</span>
<span class="ln">10 </span>                <span class="name">export_device</span><span class="punctuation">(</span><span class="name">device_list</span><span class="punctuation">.</span><span class="name">back</span><span class="punctuation">());</span>
<span class="ln">11 </span>           <span class="keyword">else</span>
<span class="ln">12 </span>                <span class="name function">export_device</span><span class="punctuation">(</span><span class="name">device_list</span><span class="punctuation">.</span><span class="name">back</span><span class="punctuation">(),(</span><span class="operator">*</span><span class="name">devlist_ptr</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]));</span>
<span class="ln">13 </span>      <span class="punctuation">}</span>
<span class="ln">14 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 4 : A loop for each device</p>
<p>Line 8 : Create the device object using a StepperMotor class constructor
which needs two arguments. These two arguments are a pointer to the
StepperMotorClass instance and the device name. The pointer to the
constructed object is then added to the device list vector</p>
<p>Line 10-13 : Export device to the outside world using the
<em>export_device</em> method of the DeviceClass class.</p>
</div>
<div class="section" id="the-attribute-factory-method">
<h4>The attribute_factory method<a class="headerlink" href="#the-attribute-factory-method" title="Permalink to this headline">¶</a></h4>
<p>The rule of this method is to fulfill a vector of pointer to attributes.
A reference to this vector is passed as argument to this method.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotorClass</span><span class="operator">::</span><span class="name">attribute_factory</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span> <span class="operator">*&gt;</span> <span class="operator">&amp;</span><span class="name">att_list</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="name">att_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">PositionAttr</span><span class="punctuation">());</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">UserDefaultAttrProp</span> <span class="name">def_prop</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>      <span class="name">def_prop</span><span class="punctuation">.</span><span class="name">set_label</span><span class="punctuation">(</span><span class="literal string">&quot;Set the motor position&quot;</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>      <span class="name">def_prop</span><span class="punctuation">.</span><span class="name">set_format</span><span class="punctuation">(</span><span class="literal string">&quot;scientific;setprecision(4)&quot;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span> <span class="operator">*</span><span class="name">at</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">SetPositionAttr</span><span class="punctuation">();</span>
<span class="ln"> 9 </span>      <span class="name">at</span><span class="operator">-&gt;</span><span class="name">set_default_properties</span><span class="punctuation">(</span><span class="name">def_prop</span><span class="punctuation">);</span>
<span class="ln">10 </span>      <span class="name">att_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="name">at</span><span class="punctuation">);</span>
<span class="ln">11 </span>
<span class="ln">12 </span>      <span class="name">att_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">DirectcionAttr</span><span class="punctuation">());</span>
<span class="ln">13 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 3 : Create the PositionAttr class and store the pointer to this
object into the attribute pointer vector.</p>
<p>Line 5-7 : Create a Tango::UserDefaultAttrProp instance and set the
label and format properties default values in this object</p>
<p>Line 8 : Create the SetPositionAttr attribute.</p>
<p>Line 9 : Set attribute user default value with the
<em>set_default_properties()</em> method of the Tango::Attr class.</p>
<p>Line 10 : Store the pointer to this object into the attribute pointer
vector.</p>
<p>Line 12 : Create the DirectionAttr class and store the pointer to this
object into the attribute pointer vector.</p>
<p>Please, note that in some rare case, it is necessary to add attribute to
this list during the device server life cycle. This
<em>attribute_factory()</em> method is called once during device server
start-up. A method <em>add_attribute()</em> of the DeviceImpl class allows the
user to add a new attribute to the attribute list outside of this
<em>attribute_factory()</em> method. See <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id40">[TangoRefMan]</a> for
more information on this method.</p>
</div>
</div>
<div class="section" id="the-devreadpositioncmd-class">
<h3>The DevReadPositionCmd class<a class="headerlink" href="#the-devreadpositioncmd-class" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id41">
<h4>The class declaration file<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span>  <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 4 </span>  <span class="punctuation">{</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>  <span class="keyword">class</span> <span class="name class">DevReadPositionCmd</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Command</span>
<span class="ln"> 7 </span>  <span class="punctuation">{</span>
<span class="ln"> 8 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 9 </span>      <span class="name">DevReadPositionCmd</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">CmdArgType</span><span class="punctuation">,</span>
<span class="ln">10 </span>                             <span class="name">Tango</span><span class="operator">::</span><span class="name">CmdArgType</span><span class="punctuation">,</span>
<span class="ln">11 </span>                             <span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">12 </span>      <span class="operator">~</span><span class="name">DevReadPositionCmd</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln">13 </span>
<span class="ln">14 </span>      <span class="keyword">virtual</span> <span class="keyword type">bool</span> <span class="name function">is_allowed</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">15 </span>      <span class="keyword">virtual</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">execute</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">16 </span>  <span class="punctuation">};</span>
<span class="ln">17 </span>
<span class="ln">18 </span>  <span class="punctuation">}</span> <span class="comment multiline">/* End of StepperMotor namespace */</span>
</pre>
<p>Line 1 : Include the tango master include file</p>
<p>Line 3 : Open the <em>StepperMotor</em> namespace.</p>
<p>Line 6 : The DevReadPositionCmd class inherits from the Tango::Command
class</p>
<p>Line 9 : The constructor</p>
<p>Line 12 : The destructor</p>
<p>Line 14 : The definition of the <em>is_allowed</em> method. This method is not
necessary if the default behavior implemented by the default
<em>is_allowed</em> method fulfill the requirements. The default behavior is
to always allows the command execution (always return true).</p>
<p>Line 15: The definition of the <em>execute</em> method</p>
</div>
<div class="section" id="the-class-constructor">
<h4>The class constructor<a class="headerlink" href="#the-class-constructor" title="Permalink to this headline">¶</a></h4>
<p>The class constructor does nothing. It simply invoke the Command
constructor by passing it its five arguments which are:</p>
<ol class="arabic simple">
<li>The command name</li>
<li>The command input type code</li>
<li>The command output type code</li>
<li>The command input parameter description</li>
<li>The command output parameter description</li>
</ol>
<p>With this 5 parameters command class constructor, the command display
level is not specified. Therefore it is set to its default value
(OPERATOR). If the command does not have input or output parameter, it
is not possible to use the Command class constructor defined with five
parameters. In this case, the command constructor execute the Command
class constructor with three elements (class name, input type, output
type) and set the input or output parameter description fields with the
<em>set_in_type_desc</em> or <em>set_out_type_desc</em> Command class methods.
To set the command display level, it is possible to use a 6 parameters
constructor or it is also possible to set it in the constructor code
with the <em>set_disp_level</em> method. Many Command class constructors are
defined. See <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id42">[TangoRefMan]</a> for a complete list.</p>
</div>
<div class="section" id="the-is-allowed-method">
<h4>The is_allowed method<a class="headerlink" href="#the-is-allowed-method" title="Permalink to this headline">¶</a></h4>
<p>In our example, the DevReadPosition command is allowed only if the
device is in the ON state. This method receives two argument which are a
pointer to the device object on which the command must be executed and a
reference to the command input Any object. This method returns a boolean
which must be set to true if the command is allowed. If this boolean is
set to false, the DeviceClass <em>command_handle</em>r method will
automatically send an exception to the caller.</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>  <span class="keyword type">bool</span> <span class="name">DevReadPositionCmd</span><span class="operator">::</span><span class="name">is_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">device</span><span class="punctuation">,</span>
<span class="ln">2 </span>                                      <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="name">in_any</span><span class="punctuation">)</span>
<span class="ln">3 </span>  <span class="punctuation">{</span>
<span class="ln">4 </span>       <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">device</span><span class="operator">-&gt;</span><span class="name">get_state</span><span class="punctuation">()</span> <span class="operator">==</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ON</span><span class="punctuation">)</span>
<span class="ln">5 </span>            <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">6 </span>       <span class="keyword">else</span>
<span class="ln">7 </span>            <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln">8 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 4 : Call the <em>get_state</em> method of the DeviceImpl class which
simply returns the device state</p>
<p>Line 5 : Authorize command if the device state is ON</p>
<p>Line 7 : Refuse command execution in all other cases.</p>
</div>
<div class="section" id="the-execute-method">
<h4>The execute method<a class="headerlink" href="#the-execute-method" title="Permalink to this headline">¶</a></h4>
<p>This method receives two arguments which are a pointer to the device
object on which the command must be executed and a reference to the
command input Any object. This method returns a pointer to an any object
which must be initialized with the data to be returned to the caller.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">*</span><span class="name">DevReadPositionCmd</span><span class="operator">::</span><span class="name">execute</span><span class="punctuation">(</span>
<span class="ln"> 2 </span>                          <span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">device</span><span class="punctuation">,</span>
<span class="ln"> 3 </span>                          <span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="name">in_any</span><span class="punctuation">)</span>
<span class="ln"> 4 </span>  <span class="punctuation">{</span>
<span class="ln"> 5 </span>       <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;DevReadPositionCmd::execute(): arrived&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>       <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">motor</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>       <span class="name">extract</span><span class="punctuation">(</span><span class="name">in_any</span><span class="punctuation">,</span><span class="name">motor</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>       <span class="keyword">return</span> <span class="name function">insert</span><span class="punctuation">(</span>
<span class="ln">10 </span>          <span class="punctuation">(</span><span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">StepperMotor</span> <span class="operator">*&gt;</span><span class="punctuation">(</span><span class="name">device</span><span class="punctuation">))</span><span class="operator">-&gt;</span><span class="name">dev_read_position</span><span class="punctuation">(</span><span class="name">motor</span><span class="punctuation">));</span>
<span class="ln">11 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 8 : Extract incoming data from the input any object using a Command
class <em>extract</em> helper method. If the type of the data in the Any object
is not a Tango::DevLong, the <em>extract</em> method will throw an exception to
the client.</p>
<p>Line 9 : Call the stepper motor object method which execute the
DevReadPosition command and insert the returned value into an allocated
Any object. The Any object allocation is done by the <em>insert</em> method
which return a pointer to this Any.</p>
</div>
</div>
<div class="section" id="id43">
<h3>The PositionAttr class<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id44">
<h4>The class declaration file<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;steppermotor.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>  <span class="keyword">class</span> <span class="name class">PositionAttr</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span>
<span class="ln"> 9 </span>  <span class="punctuation">{</span>
<span class="ln">10 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln">11 </span>      <span class="name">PositionAttr</span><span class="punctuation">()</span><span class="operator">:</span><span class="name">Attr</span><span class="punctuation">(</span><span class="literal string">&quot;Position&quot;</span><span class="punctuation">,</span>
<span class="ln">12 </span>                          <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_LONG</span><span class="punctuation">,</span>
<span class="ln">13 </span>                          <span class="name">Tango</span><span class="operator">::</span><span class="name">READ_WITH_WRITE</span><span class="punctuation">,</span>
<span class="ln">14 </span>                          <span class="literal string">&quot;SetPosition&quot;</span><span class="punctuation">)</span> <span class="punctuation">{};</span>
<span class="ln">15 </span>      <span class="operator">~</span><span class="name">PositionAttr</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln">16 </span>
<span class="ln">17 </span>      <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">read</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">att</span><span class="punctuation">)</span>
<span class="ln">18 </span>      <span class="punctuation">{(</span><span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">StepperMotor</span> <span class="operator">*&gt;</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">))</span><span class="operator">-&gt;</span><span class="name">read_Position</span><span class="punctuation">(</span><span class="name">att</span><span class="punctuation">);}</span>
<span class="ln">19 </span>      <span class="keyword">virtual</span> <span class="keyword type">bool</span> <span class="name function">is_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">AttReqType</span> <span class="name">ty</span><span class="punctuation">)</span>
<span class="ln">20 </span>      <span class="punctuation">{</span><span class="keyword">return</span> <span class="punctuation">(</span><span class="keyword">static_cast</span><span class="operator">&lt;</span><span class="name">StepperMotor</span> <span class="operator">*&gt;</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">))</span><span class="operator">-&gt;</span><span class="name">is_Position_allowed</span><span class="punctuation">(</span><span class="name">ty</span><span class="punctuation">);}</span>
<span class="ln">21 </span>  <span class="punctuation">};</span>
<span class="ln">22 </span>
<span class="ln">23 </span>  <span class="punctuation">}</span> <span class="comment multiline">/* End of StepperMotor namespace */</span>
<span class="ln">24 </span>
<span class="ln">25 </span>  <span class="comment preproc">#endif </span><span class="comment single">// _STEPPERMOTORCLASS_H</span>
</pre>
<p>Line 1-2 : Include the tango master include file and the steppermotor
class definition include file</p>
<p>Line 4 : Open the <em>StepperMotor</em> namespace.</p>
<p>Line 8 : The PosiitionAttr class inherits from the Tango::Attr class</p>
<p>Line 11-14 : The constructor with 4 arguments</p>
<p>Line 15 : The destructor</p>
<p>Line 17 : The definition of the <em>read</em> method. This method forwards the
call to a StepperMotor class method called <em>read_Position()</em></p>
<p>Line 19 : The definition of the <em>is_allowed</em> method. This method is not
necessary if the default behaviour implemented by the default
<em>is_allowed</em> method fulfills the requirements. The default behaviour is
to always allows the attribute reading (always return true). This method
forwards the call to a StepperMotor class method called
<em>is_Position_allowed()</em></p>
</div>
<div class="section" id="id45">
<h4>The class constructor<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>The class constructor does nothing. It simply invoke the Attr
constructor by passing it its four arguments which are:</p>
<ol class="arabic simple">
<li>The attribute name</li>
<li>The attribute data type code</li>
<li>The attribute writable type code</li>
<li>The name of the associated write attribute</li>
</ol>
<p>With this 4 parameters Attr class constructor, the attribute display
level is not specified. Therefore it is set to its default value
(OPERATOR). To set the attribute display level, it is possible to use in
the constructor code the <em>set_disp_level</em> method. Many Attr class
constructors are defined. See <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id46">[TangoRefMan]</a> for a
complete list.</p>
<p>This Position attribute is a scalar attribute. For spectrum attribute,
instead of inheriting from the Attr class, the class must inherits from
the SpectrumAttr class. Many SpectrumAttr class constructors are
defined. See <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id47">[TangoRefMan]</a> for a complete list.</p>
<p>For Image attribute, instead of inheriting from the Attr class, the
class must inherits from the ImageAttr class. Many ImageAttr class
constructors are defined. See <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id48">[TangoRefMan]</a> for a
complete list.</p>
</div>
<div class="section" id="id49">
<h4>The is_allowed method<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h4>
<p>This method receives two argument which are a pointer to the device
object to which the attribute belongs to and the type of request (read
or write). In the PositionAttr class, this method simply forwards the
request to a method of the StepperMotor class called
<em>is_Position_allowed()</em> passing the request type to this method. This
method returns a boolean which must be set to true if the attribute is
allowed. If this boolean is set to false, the DeviceImpl read_attribute
method will automatically send an exception to the caller.</p>
</div>
<div class="section" id="the-read-method">
<h4>The read method<a class="headerlink" href="#the-read-method" title="Permalink to this headline">¶</a></h4>
<p>This method receives two arguments which are a pointer to the device
object to which the attribute belongs to and a reference to the
corresponding attribute object. This method forwards the request to a
StepperMotor class called <em>read_Position()</em> passing it the reference on
the attribute object.</p>
</div>
</div>
<div class="section" id="id50">
<h3>The StepperMotor class<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id51">
<h4>The class declaration file<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h4>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>
<span class="ln"> 3 </span> <span class="comment preproc">#define AGSM_MAX_MOTORS 8 </span><span class="comment single">// maximum number of motors per device
</span><span class="ln"> 4 </span><span class="comment single"></span>
<span class="ln"> 5 </span> <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 6 </span> <span class="punctuation">{</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span> <span class="keyword">class</span> <span class="name class">StepperMotor</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">TANGO_BASE_CLASS</span>
<span class="ln"> 9 </span> <span class="punctuation">{</span>
<span class="ln">10 </span> <span class="keyword">public</span> <span class="operator">:</span>
<span class="ln">11 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="name">string</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">12 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">13 </span>    <span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">14 </span>    <span class="operator">~</span><span class="name">StepperMotor</span><span class="punctuation">()</span> <span class="punctuation">{};</span>
<span class="ln">15 </span>
<span class="ln">16 </span>    <span class="name">DevLong</span> <span class="name function">dev_read_position</span><span class="punctuation">(</span><span class="name">DevLong</span><span class="punctuation">);</span>
<span class="ln">17 </span>    <span class="name">DevLong</span> <span class="name function">dev_read_direction</span><span class="punctuation">(</span><span class="name">DevLong</span><span class="punctuation">);</span>
<span class="ln">18 </span>    <span class="keyword type">bool</span> <span class="name function">direct_cmd_allowed</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">19 </span>
<span class="ln">20 </span>    <span class="keyword">virtual</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevState</span> <span class="name">dev_state</span><span class="punctuation">();</span>
<span class="ln">21 </span>    <span class="keyword">virtual</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ConstDevString</span> <span class="name">dev_status</span><span class="punctuation">();</span>
<span class="ln">22 </span>
<span class="ln">23 </span>    <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">always_executed_hook</span><span class="punctuation">();</span>
<span class="ln">24 </span>
<span class="ln">25 </span>    <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">read_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">);</span>
<span class="ln">26 </span>    <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">write_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">);</span>
<span class="ln">27 </span>
<span class="ln">28 </span>    <span class="keyword type">void</span> <span class="name function">read_position</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">29 </span>    <span class="keyword type">bool</span> <span class="name function">is_Position_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">AttReqType</span> <span class="name">req</span><span class="punctuation">);</span>
<span class="ln">30 </span>    <span class="keyword type">void</span> <span class="name function">write_SetPosition</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">WAttribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">31 </span>    <span class="keyword type">void</span> <span class="name function">read_Direction</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="punctuation">);</span>
<span class="ln">32 </span>
<span class="ln">33 </span>    <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">init_device</span><span class="punctuation">();</span>
<span class="ln">34 </span>    <span class="keyword">virtual</span> <span class="keyword type">void</span> <span class="name function">delete_device</span><span class="punctuation">();</span>
<span class="ln">35 </span>
<span class="ln">36 </span>    <span class="keyword type">void</span> <span class="name function">get_device_properties</span><span class="punctuation">();</span>
<span class="ln">37 </span>
<span class="ln">38 </span> <span class="keyword">protected</span> <span class="operator">:</span>
<span class="ln">39 </span>    <span class="keyword type">long</span> <span class="name">axis</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">40 </span>    <span class="name">DevLong</span> <span class="name">position</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">41 </span>    <span class="name">DevLong</span> <span class="name">direction</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">42 </span>    <span class="keyword type">long</span> <span class="name">state</span><span class="punctuation">[</span><span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">];</span>
<span class="ln">43 </span>
<span class="ln">44 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">attr_Position_read</span><span class="punctuation">;</span>
<span class="ln">45 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">attr_Direction_read</span><span class="punctuation">;</span>
<span class="ln">46 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">attr_SetPosition_write</span><span class="punctuation">;</span>
<span class="ln">47 </span>
<span class="ln">48 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">min</span><span class="punctuation">;</span>
<span class="ln">49 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="name">max</span><span class="punctuation">;</span>
<span class="ln">50 </span>
<span class="ln">51 </span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span> <span class="operator">*</span><span class="name">ptr</span><span class="punctuation">;</span>
<span class="ln">52 </span> <span class="punctuation">};</span>
<span class="ln">53 </span>
<span class="ln">54 </span> <span class="punctuation">}</span> <span class="comment multiline">/* End of StepperMotor namespace */</span>
</pre>
<p>Line 1 : Include the Tango master include file</p>
<p>Line 5 : Open the <em>StepperMotor</em> namespace.</p>
<p>Line 8 : The StepperMotor class inherits from a Tango base class</p>
<p>Line 11-13 : Three different object constructors</p>
<p>Line 14 : The destructor which calls the <em>delete_device()</em> method</p>
<p>Line 16 : The method to be called for the execution of the
DevReadPosition command. This method must be declared as virtual if it
is needed to redefine it in a class inheriting from StepperMotor. See
chapter [Inheriting] for more details about inheriting.</p>
<p>Line 17 : The method to be called for the execution of the
DevReadDirection command</p>
<p>Line 18 : The method called to check if the execution of the
DevReadDirection command is allowed. This method is necessary because
the DevReadDirection command is created using the template command
method and the default behavior is not acceptable</p>
<p>Line 20 : Redefinition of the <em>dev_state</em>. This method is used by the
State command</p>
<p>Line 21 : Redefinition of the <em>dev_status</em>. This method is used by the
Status command</p>
<p>Line 23 : Redefinition of the <em>always_executed_hook</em> method. This
method is the place to code mandatory action which must be executed
prior to any command.</p>
<p>Line 25-31 : Attribute related methods</p>
<p>Line 32 : Definition of the <em>init_device</em> method.</p>
<p>Line 33 : Definition of the <em>delete_device</em> method</p>
<p>Line 35 : Definition of the <em>get_device_properties</em> method</p>
<p>Line 38-50 : Data members.</p>
<p>Line 43-44 : Pointers to data for readable attributes Position and
Direction</p>
<p>Line 45 : Data for the SetPosition attribute</p>
<p>Line 47-48 : Data members for the two device properties</p>
</div>
<div class="section" id="the-constructors">
<h4>The constructors<a class="headerlink" href="#the-constructors" title="Permalink to this headline">¶</a></h4>
<p>Three constructors are defined here. It is not mandatory to defined
three constructors. But at least one is mandatory. The three
constructors take a pointer to the StepperMotorClass instance as first
parameter <a class="footnote-reference" href="#id65" id="id52">[4]</a>. The second parameter is the device name as a C++ string
or as a classical pointer to char array. The third parameter necessary
only for the third form of constructor is the device description string
passed as a classical pointer to a char array.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;steppermotor.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword">namespace</span> <span class="name">StepperMotor</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>  <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="name">cl</span><span class="punctuation">,</span><span class="name">string</span> <span class="operator">&amp;</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln"> 8 </span>  <span class="operator">:</span><span class="name">TANGO_BASE_CLASS</span><span class="punctuation">(</span><span class="name">cl</span><span class="punctuation">,</span><span class="name">s</span><span class="punctuation">.</span><span class="name">c_str</span><span class="punctuation">())</span>
<span class="ln"> 9 </span>  <span class="punctuation">{</span>
<span class="ln">10 </span>    <span class="name">init_device</span><span class="punctuation">();</span>
<span class="ln">11 </span> <span class="punctuation">}</span>
<span class="ln">12 </span>
<span class="ln">13 </span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="name">cl</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln">14 </span> <span class="operator">:</span><span class="name">TANGO_BASE_CLASS</span><span class="punctuation">(</span><span class="name">cl</span><span class="punctuation">,</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln">15 </span> <span class="punctuation">{</span>
<span class="ln">16 </span>    <span class="name">init_device</span><span class="punctuation">();</span>
<span class="ln">17 </span> <span class="punctuation">}</span>
<span class="ln">18 </span>
<span class="ln">19 </span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">StepperMotor</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="name">cl</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">d</span><span class="punctuation">)</span>
<span class="ln">20 </span> <span class="operator">:</span><span class="name">TANGO_BASE_CLASS</span><span class="punctuation">(</span><span class="name">cl</span><span class="punctuation">,</span><span class="name">s</span><span class="punctuation">,</span><span class="name">d</span><span class="punctuation">)</span>
<span class="ln">21 </span> <span class="punctuation">{</span>
<span class="ln">22 </span>    <span class="name">init_device</span><span class="punctuation">();</span>
<span class="ln">23 </span> <span class="punctuation">}</span>
<span class="ln">24 </span>
<span class="ln">25 </span> <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">init_device</span><span class="punctuation">()</span>
<span class="ln">26 </span> <span class="punctuation">{</span>
<span class="ln">27 </span>    <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;StepperMotor::StepperMotor() create &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">device_name</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">28 </span>
<span class="ln">29 </span>    <span class="keyword type">long</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln">30 </span>
<span class="ln">31 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">i</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">&lt;</span> <span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln">32 </span>    <span class="punctuation">{</span>
<span class="ln">33 </span>       <span class="name">axis</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">34 </span>       <span class="name">position</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">35 </span>       <span class="name">direction</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">36 </span>    <span class="punctuation">}</span>
<span class="ln">37 </span>
<span class="ln">38 </span>    <span class="name">ptr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">DevLong</span><span class="punctuation">[</span><span class="literal number integer">10</span><span class="punctuation">];</span>
<span class="ln">39 </span>
<span class="ln">40 </span>    <span class="name">get_device_properties</span><span class="punctuation">();</span>
<span class="ln">41 </span> <span class="punctuation">}</span>
<span class="ln">42 </span>
<span class="ln">43 </span> <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">delete_device</span><span class="punctuation">()</span>
<span class="ln">44 </span> <span class="punctuation">{</span>
<span class="ln">45 </span>    <span class="keyword">delete</span> <span class="punctuation">[]</span> <span class="name">ptr</span><span class="punctuation">;</span>
<span class="ln">46 </span> <span class="punctuation">}</span>
</pre>
<p>Line 1-2 : Include the Tango master include file (tango.h) and the
StepperMotor class definition file (steppermotor.h)</p>
<p>Line 4 : Open the <em>StepperMotor</em> namespace</p>
<p>Line 7-11 : The first form of the class constructor. It execute the
Tango base class constructor with the two parameters. Note that the
device name passed to this constructor as a C++ string is passed to the
Tango::DeviceImpl constructor as a classical C string. Then the
<em>init_device</em> method is executed.</p>
<p>Line 13-17 : The second form of the class constructor. It execute the
Tango base class constructor with its two parameters. Then the
<em>init_device</em> method is executed.</p>
<p>Line 19-23: The third form of constructor. Again, it execute the Tango
base class constructor with its three parameters. Then the
<em>init_device</em> method is executed.</p>
<p>Line 25-41 : The <em>init_device</em> method. All the device data
initialization is done in this method. The device properties are also
retrieved from database with a call to the <em>get_device_properties</em>
method at line 40. The device data member called <em>ptr</em> is initialized
with allocated memory at line 38. It is not needed to have this pointer,
it has been added only for educational purpose.</p>
<p>Line 43-46 : The <em>delete_device</em> method. The rule of this method is to
free memory allocated in the <em>init_device</em> method. In our case , only
the device data member <em>ptr</em> is allocated in the <em>init_device</em> method.
Therefore, its memory is freed at line 45. This method is called by the
automatically added Init command before it calls the <em>init_device</em>
method. It is also called by the device destructor.</p>
</div>
<div class="section" id="the-methods-used-for-the-devreaddirection-command">
<h4>The methods used for the DevReadDirection command<a class="headerlink" href="#the-methods-used-for-the-devreaddirection-command" title="Permalink to this headline">¶</a></h4>
<p>The DevReadDirection command is created using the template command
method. Therefore, there is no specific class needed for this command
but only one object of the TemplCommandInOut class. This command needs
two methods which are the <em>dev_read_direction</em> method and the
<em>direct_cmd_allowed</em> method. The <em>direct_cmd_allowed</em> method defines
here implements exactly the same behavior than the default one. This
method has been used only for pedagogic issue. The
<em>dev_read_direction</em> method will be executed by the <em>execute</em> method
of the TemplCommandInOut class. The <em>direct_cmd_allowed</em> method will
be executed by the <em>is_allowed</em> method of the TemplCommandInOut class.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">DevLong</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">dev_read_direction</span><span class="punctuation">(</span><span class="name">DevLong</span> <span class="name">axis</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">axis</span> <span class="operator">&lt;</span> <span class="literal number integer">0</span> <span class="operator">||</span> <span class="name">axis</span> <span class="operator">&gt;</span> <span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">)</span>
<span class="ln"> 4 </span>     <span class="punctuation">{</span>
<span class="ln"> 5 </span>         <span class="name">WARNING_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Steppermotor::dev_read_direction(): axis out of range !&quot;</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>         <span class="name">WARNING_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>         <span class="name">TangoSys_OMemStream</span> <span class="name">o</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>         <span class="name">o</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Axis number &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">axis</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; out of range&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">ends</span><span class="punctuation">;</span>
<span class="ln">10 </span>         <span class="name">throw_exception</span><span class="punctuation">(</span><span class="literal string">&quot;StepperMotor_OutOfRange&quot;</span><span class="punctuation">,</span>
<span class="ln">11 </span>                         <span class="name">o</span><span class="punctuation">.</span><span class="name">str</span><span class="punctuation">(),</span>
<span class="ln">12 </span>                         <span class="literal string">&quot;StepperMotor::dev_read_direction&quot;</span><span class="punctuation">);</span>
<span class="ln">13 </span>      <span class="punctuation">}</span>
<span class="ln">14 </span>
<span class="ln">15 </span>      <span class="keyword">return</span> <span class="name">direction</span><span class="punctuation">[</span><span class="name">axis</span><span class="punctuation">];</span>
<span class="ln">16 </span>  <span class="punctuation">}</span>
<span class="ln">17 </span>
<span class="ln">18 </span>
<span class="ln">19 </span>  <span class="keyword type">bool</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">direct_cmd_allowed</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">Any</span> <span class="operator">&amp;</span><span class="name">in_data</span><span class="punctuation">)</span>
<span class="ln">20 </span>  <span class="punctuation">{</span>
<span class="ln">21 </span>      <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In direct_cmd_allowed() method&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">22 </span>
<span class="ln">23 </span>      <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">24 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 1-16 : The <em>dev_read_direction</em> method</p>
<p>Line 5-12 : Throw exception to client if the received axis number is out
of range</p>
<p>Line 7 : A TangoSys_OMemStream is used as stream. The
TangoSys_OMemStream has been defined in improve portability across
platform. For Unix like operating system, it is a ostrtream type. For
operating system with a full implementation of the standard library, it
is a ostringstream type.</p>
<p>Line 19-24 : The <em>direct_cmd_allowed</em> method. The command input data
is passed to this method in case of it is needed to take the decision.
This data is still packed into the CORBA Any object.</p>
</div>
<div class="section" id="the-methods-used-for-the-position-attribute">
<h4>The methods used for the Position attribute<a class="headerlink" href="#the-methods-used-for-the-position-attribute" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">To enable reading of attributes, the StepperMotor class must re-define
two or three methods called <em>read_attr_hardware(),
read_&lt;Attribute_name&gt;()</em> and if necessary a method called</div>
<div class="line"><em>is_&lt;Attribute_name&gt;_allowed().</em> The aim of the first one is to
read the hardware. It will be called only once at the beginning of
each read_attribute CORBA call. The second method aim is to build the
exact data for the wanted attribute and to store this value into the
Attribute object. Special care has been taken in order to minimize the
number of data copy and allocation. The data passed to the Attribute
object as attribute value is passed using pointers. It must be
allocated by the method <a class="footnote-reference" href="#id66" id="id53">[5]</a> and the Attribute object will not free
this memory. Data members called attr_&lt;Attribute_name&gt;_read are
foreseen for this usage. The <em>read_attr_hardware()</em> method receives
a vector of long which are indexes into the main attributes vector of
the attributes to be read. The <em>read_Position()</em> method receives a
reference to the Attribute object. The third method
(<em>is_Position_allowed()</em>) aim is to allow or dis-allow, the
attribute reading. In some cases, some attributes can be read only if
some conditions are met. If this method returns true, the
<em>read_&lt;Attribute_name&gt;()</em> method will be called. Otherwise, an error
will be generated for the attribute. This method receives one argument
which is an emumeration describing the attribute request type (read or
write). In our example, the reading of the Position attribute is
allowed only if the device state is ON.</div>
</div>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">read_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In read_attr_hardware for &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">attr_list</span><span class="punctuation">.</span><span class="name">size</span><span class="punctuation">();</span>
<span class="ln"> 4 </span>     <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; attribute(s)&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>     <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">long</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="name">attr_list</span><span class="punctuation">.</span><span class="name">size</span><span class="punctuation">();</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 7 </span>     <span class="punctuation">{</span>
<span class="ln"> 8 </span>        <span class="name">string</span> <span class="name">attr_name</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>        <span class="name">attr_name</span> <span class="operator">=</span> <span class="name">dev_attr</span><span class="operator">-&gt;</span><span class="name">get_attr_by_ind</span><span class="punctuation">(</span><span class="name">attr_list</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]).</span><span class="name">get_name</span><span class="punctuation">();</span>
<span class="ln">10 </span>
<span class="ln">11 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">attr_name</span> <span class="operator">==</span> <span class="literal string">&quot;Position&quot;</span><span class="punctuation">)</span>
<span class="ln">12 </span>        <span class="punctuation">{</span>
<span class="ln">13 </span>           <span class="name">attr_Position_read</span> <span class="operator">=</span> <span class="operator">&amp;</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>
<span class="ln">14 </span>        <span class="punctuation">}</span>
<span class="ln">15 </span>        <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">attr_name</span> <span class="operator">==</span> <span class="literal string">&quot;Direction&quot;</span><span class="punctuation">)</span>
<span class="ln">16 </span>        <span class="punctuation">{</span>
<span class="ln">17 </span>           <span class="name">attr_Direction_read</span> <span class="operator">=</span> <span class="operator">&amp;</span><span class="punctuation">(</span><span class="name">direction</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>
<span class="ln">18 </span>        <span class="punctuation">}</span>
<span class="ln">19 </span>     <span class="punctuation">}</span>
<span class="ln">20 </span>  <span class="punctuation">}</span>
<span class="ln">21 </span>
<span class="ln">22 </span>  <span class="keyword type">void</span> <span class="name">read_Position</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">att</span><span class="punctuation">)</span>
<span class="ln">23 </span>  <span class="punctuation">{</span>
<span class="ln">24 </span>     <span class="name">att</span><span class="punctuation">.</span><span class="name">set_value</span><span class="punctuation">(</span><span class="name">attr_Position_read</span><span class="punctuation">);</span>
<span class="ln">25 </span>  <span class="punctuation">}</span>
<span class="ln">26 </span>
<span class="ln">27 </span>  <span class="keyword type">bool</span> <span class="name">is_Position_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">AttReqType</span> <span class="name">req</span><span class="punctuation">)</span>
<span class="ln">28 </span>  <span class="punctuation">{</span>
<span class="ln">29 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">req</span> <span class="operator">==</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">WRITE_REQ</span><span class="punctuation">)</span>
<span class="ln">30 </span>        <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln">31 </span>     <span class="keyword">else</span>
<span class="ln">32 </span>     <span class="punctuation">{</span>
<span class="ln">33 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">get_state</span><span class="punctuation">()</span> <span class="operator">==</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ON</span><span class="punctuation">)</span>
<span class="ln">34 </span>           <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">35 </span>        <span class="keyword">else</span>
<span class="ln">36 </span>           <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln">37 </span>     <span class="punctuation">}</span>
<span class="ln">38 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 6 : A loop on each attribute to be read</p>
<p>Line 9 : Get attribute name</p>
<p>Line 11 : Test on attribute name</p>
<p>Line 13 : Read hardware (pretty simple in our case)</p>
<p>Line 24 : Set attribute value in Attribute object using the
<em>set_value()</em> method. This method will also initializes the attribute
quality factor to Tango::ATTR_VALID if no alarm level are defined and
will set the attribute returned date. It is also possible to use a
method called <em>set_value_date_quality()</em> which allows the user to set
the attribute quality factor as well as the attribute date.</p>
<p>Line 33 : Test on device state</p>
</div>
<div class="section" id="the-methods-used-for-the-setposition-attribute">
<h4>The methods used for the SetPosition attribute<a class="headerlink" href="#the-methods-used-for-the-setposition-attribute" title="Permalink to this headline">¶</a></h4>
<p>To enable writing of attributes, the StepperMotor class must re-define
one or two methods called <em>write_&lt;Attribute_name&gt;()</em> and if necessary
a method called <em>is_&lt;Attribute_name&gt;_allowed().</em> The aim of the first
one is to write the hardware. The <em>write_Position()</em> method receives a
reference to the WAttribute object. The value to write is in this
WAttribute object. The third method (<em>is_Position_allowed()</em>) aim is
to allow or dis-allow, the attribute writing. In some cases, some
attributes can be write only if some conditions are met. If this method
returns true, the <em>write_&lt;Attribute_name&gt;()</em> method will be called.
Otherwise, an error will be generated for the attribute. This method
receives one argument which is an emumeration describing the attribute
request type (read or write). For read/write attribute, this method is
the same for reading and writing. The input argument value makes the
difference.</p>
<p>For our example, it is always possible to write the SetPosition
attribute. Therefore, the StepperMotor class only defines a
<em>write_SetPosition()</em> method.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">write_SetPosition</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">WAttribute</span> <span class="operator">&amp;</span><span class="name">att</span><span class="punctuation">)</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span>    <span class="name">att</span><span class="punctuation">.</span><span class="name">get_write_value</span><span class="punctuation">(</span><span class="name">sttr_SetPosition_write</span><span class="punctuation">);</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>    <span class="name">DEBUG_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Attribute SetPosition value = &quot;</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>    <span class="name">DEBUG_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="name">attr_SetPosition_write</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>    <span class="name">position</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">attr_SetPosition_write</span><span class="punctuation">;</span>
<span class="ln"> 9 </span> <span class="punctuation">}</span>
<span class="ln">10 </span>
<span class="ln">11 </span> <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">write_attr_hardware</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">long</span><span class="operator">&gt;</span> <span class="operator">&amp;</span><span class="name">attr_list</span><span class="punctuation">)</span>
<span class="ln">12 </span> <span class="punctuation">{</span>
<span class="ln">13 </span>
<span class="ln">14 </span> <span class="punctuation">}</span>
</pre>
<p>Line 3 : Retrieve new attribute value</p>
<p>Line 5-6 : Send some messages using Tango Logging system</p>
<p>Line 8 : Set the hardware (pretty simple in our case)</p>
<div class="line-block">
<div class="line">Line 11 - 14: The write_attr_hardware() method.</div>
<div class="line">In our case, we don’t have to do anything in the
<em>write_attr_hardware()</em> method. It is coded here just for
educational purpose. When its not needed, this method has a default
implementation in the Tango base class and it is not mandatory to
declare and defin it in your own Tango class</div>
</div>
</div>
<div class="section" id="retrieving-device-properties">
<h4>Retrieving device properties<a class="headerlink" href="#retrieving-device-properties" title="Permalink to this headline">¶</a></h4>
<p>Retrieving properties is fairly simple with the use of the database
object. Each Tango device is an aggregate with a DbDevice object (see
figure [Device pattern figure]). This has been grouped in a method called
<em>get_device_properties</em>(). The classes and methods of the Dbxxx
objects are described in the Tango API documentation.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">DocDs</span><span class="operator">::</span><span class="name">get_device_property</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">DbData</span>   <span class="name">data</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>     <span class="name">data</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="name">DbDatum</span><span class="punctuation">(</span><span class="literal string">&quot;Max&quot;</span><span class="punctuation">));</span>
<span class="ln"> 5 </span>     <span class="name">data</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="name">DbDatum</span><span class="punctuation">(</span><span class="literal string">&quot;Min&quot;</span><span class="punctuation">));</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>     <span class="name">get_db_device</span><span class="punctuation">()</span><span class="operator">-&gt;</span><span class="name">get_property</span><span class="punctuation">(</span><span class="name">data</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">data</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">is_empty</span><span class="punctuation">()</span><span class="operator">==</span><span class="name builtin">false</span><span class="punctuation">)</span>
<span class="ln">10 </span>        <span class="name">data</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span>  <span class="operator">&gt;&gt;</span>  <span class="name">max</span><span class="punctuation">;</span>
<span class="ln">11 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">data</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">].</span><span class="name">is_empty</span><span class="punctuation">()</span><span class="operator">==</span><span class="name builtin">false</span><span class="punctuation">)</span>
<span class="ln">12 </span>        <span class="name">data</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span>  <span class="operator">&gt;&gt;</span>  <span class="name">min</span><span class="punctuation">;</span>
<span class="ln">13 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 4-5 : Two DbDatum (one per property) are stored into a DbData
object</p>
<p>Line 7 : Call the database to retrieve properties value</p>
<p>Line 9-10 : If the Max property is defined in the database, extract its
value from the DbDatum object and store it in a device data member</p>
<p>Line 11-12 : If the Min property is defined in the database, extract its
value from the DbDatum object and store it in a device data member</p>
</div>
<div class="section" id="the-remaining-methods">
<h4>The remaining methods<a class="headerlink" href="#the-remaining-methods" title="Permalink to this headline">¶</a></h4>
<p>The remaining methods are the <em>dev_state, dev_status,
always_executed_hook</em>, <em>dev_read_position</em> and <em>read_Direction()</em>
methods. The <em>dev_state</em> method parameters are fixed. It does not
receive any input parameter and must return a Tango_DevState data type.
The <em>dev_status</em> parameters are also fixed. It does not receive any
input parameter and must return a Tango string. The
<em>always_executed_hook</em> receives nothing and return nothing. The
<em>dev_read_position</em> method input parameter is the motor number as a
long and the returned parameter is the motor position also as a long
data type. The <em>read_Direction()</em> method is the method for reading the
Direction attribute.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="name">DevLong</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">dev_read_position</span><span class="punctuation">(</span><span class="name">DevLong</span> <span class="name">axis</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>
<span class="ln"> 4 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">axis</span> <span class="operator">&lt;</span> <span class="literal number integer">0</span> <span class="operator">||</span> <span class="name">axis</span> <span class="operator">&gt;</span> <span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">)</span>
<span class="ln"> 5 </span>     <span class="punctuation">{</span>
<span class="ln"> 6 </span>          <span class="name">WARNING_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Steppermotor::dev_read_position(): axis out of range !&quot;</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>          <span class="name">WARNING_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>          <span class="name">TangoSys_OMemStream</span> <span class="name">o</span><span class="punctuation">;</span>
<span class="ln">10 </span>
<span class="ln">11 </span>          <span class="name">o</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Axis number &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">axis</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot; out of range&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">ends</span><span class="punctuation">;</span>
<span class="ln">12 </span>          <span class="name">throw_exception</span><span class="punctuation">(</span><span class="literal string">&quot;StepperMotor_OutOfRange&quot;</span><span class="punctuation">,</span>
<span class="ln">13 </span>                          <span class="name">o</span><span class="punctuation">.</span><span class="name">str</span><span class="punctuation">(),</span>
<span class="ln">14 </span>                          <span class="literal string">&quot;StepperMotor::dev_read_position&quot;</span><span class="punctuation">);</span>
<span class="ln">15 </span>     <span class="punctuation">}</span>
<span class="ln">16 </span>
<span class="ln">17 </span>     <span class="keyword">return</span> <span class="name">position</span><span class="punctuation">[</span><span class="name">axis</span><span class="punctuation">];</span>
<span class="ln">18 </span>  <span class="punctuation">}</span>
<span class="ln">19 </span>
<span class="ln">20 </span>  <span class="keyword type">void</span> <span class="name">always_executed_hook</span><span class="punctuation">()</span>
<span class="ln">21 </span>  <span class="punctuation">{</span>
<span class="ln">22 </span>     <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In the always_executed_hook method &lt;&lt; endl;</span>
<span class="ln">23 </span>  <span class="punctuation">}</span>
<span class="ln">24 </span>
<span class="ln">25 </span>  <span class="name">Tango_DevState</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">dev_state</span><span class="punctuation">()</span>
<span class="ln">26 </span>  <span class="punctuation">{</span>
<span class="ln">27 </span>     <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In StepperMotor state command&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">28 </span>     <span class="keyword">return</span> <span class="name">DeviceImpl</span><span class="operator">::</span><span class="name">dev_state</span><span class="punctuation">();</span>
<span class="ln">29 </span>  <span class="punctuation">}</span>
<span class="ln">30 </span>
<span class="ln">31 </span>  <span class="name">Tango_DevString</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">dev_status</span><span class="punctuation">()</span>
<span class="ln">32 </span>  <span class="punctuation">{</span>
<span class="ln">33 </span>     <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;In StepperMotor status command&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">34 </span>     <span class="keyword">return</span> <span class="name">DeviceImpl</span><span class="operator">::</span><span class="name">dev_status</span><span class="punctuation">();</span>
<span class="ln">35 </span>  <span class="punctuation">}</span>
<span class="ln">36 </span>
<span class="ln">37 </span>  <span class="keyword type">void</span> <span class="name">read_Direction</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="name">att</span><span class="punctuation">)</span>
<span class="ln">38 </span>  <span class="punctuation">{</span>
<span class="ln">39 </span>     <span class="name">att</span><span class="punctuation">.</span><span class="name">set_value</span><span class="punctuation">(</span><span class="name">attr_Direction_read</span><span class="punctuation">);</span>
<span class="ln">40 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 1-18 : The <em>dev_read_position</em> method</p>
<p>Line 6-14 : Throw exception to client if the received axis number is out
of range</p>
<p>Line 9 : A TangoSys_OMemStream is used as stream. The
TangoSys_OMemStream has been defined in improve portability across
platform. For Unix like operating system, it is a ostrtream type. For
operating system with a full implementation of the standard library, it
is a ostringstream type.</p>
<p>Line 20-23 : The <em>always_executed_hook</em> method. It does nothing. It
has been included here only as pedagogic usage.</p>
<p>Line 25-29 : The <em>dev_state</em> method. It does exactly what the default
<em>dev_state</em> does. It has been included here only as pedagogic usage</p>
<p>Line 31-35 : The <em>dev_status</em> method. It does exactly what the default
<em>dev_statu</em>s does. It has been included here only as pedagogic usage</p>
<p>Line 37-40 : The <em>read_Direction</em> method. Simply set the Attribute
object internal value</p>
</div>
</div>
</div>
<div class="section" id="device-server-under-windows">
<h2>Device server under Windows<a class="headerlink" href="#device-server-under-windows" title="Permalink to this headline">¶</a></h2>
<p>Two kind of programs are available under Windows. These kinds of
programs are called console application or Windows application. A
console application is started from a MS-DOS window and is very similar
to classical UNIX program. A Windows application is most of the time not
started from a MS-DOS window and is generally a graphical application
without standard input/output. Writing a device server in a console
application is straight forward following the rules described in the
previous sub-chapters. Writing a device server in a Windows application
needs some changes detailed in the following sub-chapters.</p>
<div class="section" id="the-tango-device-server-graphical-interface">
<h3>The Tango device server graphical interface<a class="headerlink" href="#the-tango-device-server-graphical-interface" title="Permalink to this headline">¶</a></h3>
<p>Within the Windows operating system, most of the running application has
a window user interface. This is also true for the Windows Tango device
server. Using or not this interface is up to the device server
programmer. The choice is done with an argument to the <em>server_init()</em>
method of the Tango::Util class. This interface is pretty simple and is
based on three windows which are :</p>
<ul class="simple">
<li>The device server main window</li>
<li>The device server console window</li>
<li>The device server help window</li>
</ul>
<div class="section" id="the-device-server-main-window">
<h4>The device server main window<a class="headerlink" href="#the-device-server-main-window" title="Permalink to this headline">¶</a></h4>
<p>This window looks like :</p>
<div class="figure align-center" id="id73">
<span id="id54"></span><img alt="Tango device server main window" src="../../_images/main.bmp" />
<p class="caption"><span class="caption-text">Figure 6.7: Tango device server main window</span></p>
</div>
<p>Four menus are available in this window. The File menu allows the user
to exit the device server. The View menu allows you to display/hide the
device server console window. The Debug menu allows the user to change
the server output verbose level. All the outputs goes to the console
window even if it is hidden. The Help menu displays the help window. The
device server name is displayed in the window title. The text displayed
at the bottom of the window has a default value (the one displayed in
this window dump) but may be changed by the device server programmer
using the <em>set_main_window_text()</em> method of the Tango::Util class.
If used, this method must be called prior to the call of the
<em>server_init()</em> method. Refer to   <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id55">[TangoRefMan]</a>  for
a complete description of this method.</p>
</div>
<div class="section" id="the-console-window">
<h4>The console window<a class="headerlink" href="#the-console-window" title="Permalink to this headline">¶</a></h4>
<p>This window looks like :</p>
<p><a class="reference internal" href="../../_images/cons.bmp"><img alt="image15" src="../../_images/cons.bmp" style="width: 14.00000cm;" /></a></p>
<p>It simply displays all the logging** message when a console target is
used in the device server.</p>
</div>
<div class="section" id="the-help-window">
<h4>The help window<a class="headerlink" href="#the-help-window" title="Permalink to this headline">¶</a></h4>
<p>This window looks like :</p>
<p><a class="reference internal" href="../../_images/help.bmp"><img alt="image16" src="../../_images/help.bmp" style="width: 9.00000cm;" /></a></p>
<p>This window displays</p>
<ul class="simple">
<li>The device server name</li>
<li>The Tango library release</li>
<li>The Tango IDL definition release</li>
<li>The device server release. The device server programmer may set this
release number using the <em>set_server_version()</em> method of the
Tango::Util class. If used, this must be done prior to the call of
the <em>server_init()</em> method. If the <em>set_server_version()</em> method
is not used, x.y is displays as version number. Refer to
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id56">[TangoRefMan]</a>  for a complete description of this
method.</li>
</ul>
</div>
</div>
<div class="section" id="mfc-device-server">
<h3>MFC device server<a class="headerlink" href="#mfc-device-server" title="Permalink to this headline">¶</a></h3>
<p>There is no <em>main</em> function within a classical MFC program. Most of the
time, your application is represented by one instance of a C++ class
which inherits from the MFC CWinApp class. This CWinApp class has
several methods that you may overload in your application class. For a
device server to run correctly, you must overload two methods of the
CWinApp class. These methods are the <em>InitInstance()</em> and
<em>ExitInstance()</em> methods. The rule of these methods is obvious following
their names.</p>
<p><strong>Remember that if the Tango device server graphical user interface is
used, you must link your device server with the Tango windows resource
file</strong>. This is done by adding the Tango resource file to the Project
Settings/Link/Input/Object, library modules window in VC++.</p>
<div class="section" id="the-initinstance-method">
<h4>The InitInstance method<a class="headerlink" href="#the-initinstance-method" title="Permalink to this headline">¶</a></h4>
<p>The code to be added here is the equivalent of the code written in a
classical <em>main()</em> function. Don’t forget to add the <em>tango.h</em> file in
the list of included files.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="name">BOOL</span> <span class="name">FluidsApp</span><span class="operator">::</span><span class="name">InitInstance</span><span class="punctuation">()</span>
<span class="ln"> 2 </span> <span class="punctuation">{</span>
<span class="ln"> 3 </span>    <span class="name">AfxEnableControlContainer</span><span class="punctuation">();</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span> <span class="comment single">// Standard initialization
</span><span class="ln"> 6 </span><span class="comment single"></span> <span class="comment single">// If you are not using these features and wish to reduce the size
</span><span class="ln"> 7 </span><span class="comment single"></span> <span class="comment single">//  of your final executable, you should remove from the following
</span><span class="ln"> 8 </span><span class="comment single"></span> <span class="comment single">//  the specific initialization routines you do not need.
</span><span class="ln"> 9 </span><span class="comment single"></span>
<span class="ln">10 </span>  <span class="comment preproc">#ifdef _AFXDLL
</span><span class="ln">11 </span><span class="comment preproc"></span>    <span class="name">Enable3dControls</span><span class="punctuation">();</span>          <span class="comment single">// Call this when using MFC in a shared DLL
</span><span class="ln">12 </span><span class="comment single"></span>  <span class="comment preproc">#else
</span><span class="ln">13 </span><span class="comment preproc"></span>    <span class="name">Enable3dControlsStatic</span><span class="punctuation">();</span>    <span class="comment single">// Call this when linking to MFC statically
</span><span class="ln">14 </span><span class="comment single"></span>  <span class="comment preproc">#endif
</span><span class="ln">15 </span><span class="comment preproc"></span>    <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span><span class="punctuation">;</span>
<span class="ln">16 </span>    <span class="keyword">try</span>
<span class="ln">17 </span>    <span class="punctuation">{</span>
<span class="ln">18 </span>
<span class="ln">19 </span>        <span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="name">m_hInstance</span><span class="punctuation">,</span><span class="name">m_nCmdShow</span><span class="punctuation">);</span>
<span class="ln">20 </span>
<span class="ln">21 </span>        <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_init</span><span class="punctuation">(</span><span class="name builtin">true</span><span class="punctuation">);</span>
<span class="ln">22 </span>
<span class="ln">23 </span>        <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_run</span><span class="punctuation">();</span>
<span class="ln">24 </span>
<span class="ln">25 </span>    <span class="punctuation">}</span>
<span class="ln">26 </span>    <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">27 </span>    <span class="punctuation">{</span>
<span class="ln">28 </span>        <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="literal string">&quot;Memory error&quot;</span><span class="punctuation">,</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">29 </span>        <span class="keyword">return</span><span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">30 </span>    <span class="punctuation">}</span>
<span class="ln">31 </span>    <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevFailed</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">32 </span>    <span class="punctuation">{</span>
<span class="ln">33 </span>        <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,,</span><span class="name">e</span><span class="punctuation">.</span><span class="name">errors</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">desc</span><span class="punctuation">.</span><span class="name">in</span><span class="punctuation">(),</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">34 </span>        <span class="keyword">return</span><span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">35 </span>    <span class="punctuation">}</span>
<span class="ln">36 </span>    <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">Exception</span> <span class="operator">&amp;</span><span class="punctuation">)</span>
<span class="ln">37 </span>    <span class="punctuation">{</span>
<span class="ln">38 </span>        <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="literal string">&quot;Exception CORBA&quot;</span><span class="punctuation">,</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">39 </span>        <span class="keyword">return</span><span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">40 </span>    <span class="punctuation">}</span>
<span class="ln">41 </span>
<span class="ln">42 </span>    <span class="name">m_pMainWnd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">CWnd</span><span class="punctuation">;</span>
<span class="ln">43 </span>    <span class="name">m_pMainWnd</span><span class="operator">-&gt;</span><span class="name">Attach</span><span class="punctuation">(</span><span class="name">tg</span><span class="operator">-&gt;</span><span class="name">get_ds_main_window</span><span class="punctuation">());</span>
<span class="ln">44 </span>
<span class="ln">45 </span>    <span class="keyword">return</span> <span class="name">TRUE</span><span class="punctuation">;</span>
<span class="ln">46 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 19 : Initialise Tango system. This method also analises the
argument used in command line.</p>
<p>Line 21 : Create Tango classes requesting the Tango Windows graphical
interface to be used</p>
<p>Line 23 : Start Network listener. Note that under NT, this call returns
in the contrary of UNIX like operating system.</p>
<p>Line 26-30 : Display a message box in case of memory allocation error
and leave method with a return value set to false in order to stop the
process</p>
<p>Line 31-35 : Display a message box in case of error during server
initialization phase.</p>
<p>Line 36-40 : Display a message box in case of error other than memory
allocation. Leave method with a return value set to false in order to
stop the process.</p>
<p>Line 37-38 : Create a MFC main window and attach the Tango graphical
interface main window to this MFC window.</p>
</div>
<div class="section" id="the-exitinstance-method">
<h4>The ExitInstance method<a class="headerlink" href="#the-exitinstance-method" title="Permalink to this headline">¶</a></h4>
<p>This method is called when the application is stopped. For Tango device
server, its rule is to destroy the Tango::Util singleton if this one has
been correctly constructed.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">int</span> <span class="name">FluidsApp</span><span class="operator">::</span><span class="name">ExitInstance</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="keyword type">bool</span> <span class="name">del</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>     <span class="keyword">try</span>
<span class="ln"> 6 </span>     <span class="punctuation">{</span>
<span class="ln"> 7 </span>         <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">();</span>
<span class="ln"> 8 </span>     <span class="punctuation">}</span>
<span class="ln"> 9 </span>     <span class="keyword">catch</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevFailed</span><span class="punctuation">)</span>
<span class="ln">10 </span>     <span class="punctuation">{</span>
<span class="ln">11 </span>         <span class="name">del</span> <span class="operator">=</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln">12 </span>     <span class="punctuation">}</span>
<span class="ln">13 </span>
<span class="ln">14 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">del</span> <span class="operator">==</span> <span class="name builtin">true</span><span class="punctuation">)</span>
<span class="ln">15 </span>         <span class="keyword">delete</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">());</span>
<span class="ln">16 </span>
<span class="ln">17 </span>     <span class="keyword">return</span> <span class="name">CWinApp</span><span class="operator">::</span><span class="name">ExitInstance</span><span class="punctuation">();</span>
<span class="ln">18 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 7 : Try to retrieve the Tango::Util singleton. If this one has not
been constructed correctly, this call will throw an exception.</p>
<p>Line 9-12 : Catch the exception in case of incomplete Tango::Util
singleton construction</p>
<p>Line 14-15 : Delete the Tango::Util singleton. This will unregister the
Tango device server from the Tango database.</p>
<p>Line 17 : Execute the <em>ExitInstance</em> method of the CWinApp class.</p>
<p>If you don’t want to use the Tango device server graphical interface, do
not pass any parameter to the <em>server_init()</em> method and instead of the
code display in lines 37 and 38 in the previous example of the
<em>InitInstance()</em> method, use your own code to initialize your own
application.</p>
</div>
<div class="section" id="example-of-how-to-build-a-windows-device-server-mfc-based">
<h4>Example of how to build a Windows device server MFC based<a class="headerlink" href="#example-of-how-to-build-a-windows-device-server-mfc-based" title="Permalink to this headline">¶</a></h4>
<p>This sub-chapter gives an example of what it is needed to do to build a
MFC Windows device server. Rather than being a list of actions to
strictly follow, this is some general rules of how using VC++ to build a
Tango device server using MFC.</p>
<ol class="arabic simple">
<li>Create your device server using Pogo. For a class named MyMotor, the
following files will be needed : <em>class_factory.cpp</em>,
<em>MyMotorClass.h</em>, <em>MyMotorClass.cpp</em>, <em>MyMotor.h</em> and <em>MyMotor.cpp.</em></li>
<li>On a Windows computer running VC++, create a new project of type “MFC
app Wizard (exe)” using static MFC libs. Ask for a dialog based
project without ActiveX controls.</li>
<li>Copy the five files generated by Pogo to the Windows computer and add
them to your project</li>
<li>Remove the dialog window files (xxxDlg.cpp and xxxDlg.h), the
Resource include file and the resource script file from your project</li>
<li>Add #include &lt;stdafx.h&gt; as first line of the include files list in
<em>class_factory.cpp</em>, <em>MyMotorClass.cpp</em> and <em>MyMotor.cpp</em> file. Also
add your own directory and the Tango include directory to the project
pre-compiler include directories list.</li>
<li>Enable RTTI in your project settings (see chapter [Compiling NT])</li>
<li>Change your application class:<ol class="arabic">
<li>Add the definition of an <em>ExitInstance</em> method in the declaration
file. (xxx.h file)</li>
<li>Remove the include of the dialog window file in the xxx.cpp file
and add an include of the Tango master include files (tango.h)</li>
<li>Replace the <em>InitInstance</em>() method as described in previous
sub-chapter. (xx.cpp file)</li>
<li>Add an <em>ExitInstance()</em> method as described in previous
sub-chapter (xxx.cpp file)</li>
</ol>
</li>
<li>Add all the libraries needed to compile a Tango device server (see
chapter [Compiling NT]) and the Tango resource file to the linker
Object/Libraries modules.</li>
</ol>
</div>
</div>
<div class="section" id="win32-application">
<h3>Win32 application<a class="headerlink" href="#win32-application" title="Permalink to this headline">¶</a></h3>
<p>Even if it is more natural to use the C++ structure of the MFC class to
write a Tango device server, it is possible to write a device server as
a Win32 application. Instead of having a <em>main()</em> function as the
application entry point, the operating system, provides a <em>WinMain()</em>
function as the application entry point. Some code must be added to this
<em>WinMain</em> function in order to support Tango device server. Don’t forget
to add the <em>tango</em>.<em>h</em> file in the list of included files. If you are
using the project files generated by Pogo, don’t forget to change the
linker SUBSYSTEM option to Windows (Under Linker/System in the project
properties window).</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">int</span> <span class="name">APIENTRY</span> <span class="name function">WinMain</span><span class="punctuation">(</span><span class="name">HINSTANCE</span> <span class="name">hInstance</span><span class="punctuation">,</span>
<span class="ln"> 2 </span>                       <span class="name">HINSTANCE</span> <span class="name">hPrevInstance</span><span class="punctuation">,</span>
<span class="ln"> 3 </span>                       <span class="name">LPSTR</span>     <span class="name">lpCmdLine</span><span class="punctuation">,</span>
<span class="ln"> 4 </span>                       <span class="keyword type">int</span>       <span class="name">nCmdShow</span><span class="punctuation">)</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>     <span class="name">MSG</span> <span class="name">msg</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span><span class="punctuation">;</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>     <span class="keyword">try</span>
<span class="ln">10 </span>     <span class="punctuation">{</span>
<span class="ln">11 </span>         <span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="name">hInstance</span><span class="punctuation">,</span><span class="name">nCmdShow</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>         <span class="name">string</span> <span class="name">txt</span><span class="punctuation">;</span>
<span class="ln">14 </span>         <span class="name">txt</span> <span class="operator">=</span> <span class="literal string">&quot;Blabla first line</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">;</span>
<span class="ln">15 </span>         <span class="name">txt</span> <span class="operator">=</span> <span class="name">txt</span> <span class="operator">+</span> <span class="literal string">&quot;Blabla second line</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">;</span>
<span class="ln">16 </span>         <span class="name">txt</span> <span class="operator">=</span> <span class="name">txt</span> <span class="operator">+</span> <span class="literal string">&quot;Blabla third line</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">;</span>
<span class="ln">17 </span>         <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">set_main_window_text</span><span class="punctuation">(</span><span class="name">txt</span><span class="punctuation">);</span>
<span class="ln">18 </span>         <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">set_server_version</span><span class="punctuation">(</span><span class="literal string">&quot;2.2&quot;</span><span class="punctuation">);</span>
<span class="ln">19 </span>
<span class="ln">20 </span>         <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_init</span><span class="punctuation">(</span><span class="name builtin">true</span><span class="punctuation">);</span>
<span class="ln">21 </span>
<span class="ln">22 </span>         <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_run</span><span class="punctuation">();</span>
<span class="ln">23 </span>
<span class="ln">24 </span>     <span class="punctuation">}</span>
<span class="ln">25 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">26 </span>     <span class="punctuation">{</span>
<span class="ln">27 </span>         <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="literal string">&quot;Memory error&quot;</span><span class="punctuation">,</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">28 </span>         <span class="keyword">return</span> <span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">29 </span>     <span class="punctuation">}</span>
<span class="ln">30 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevFailed</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">31 </span>     <span class="punctuation">{</span>
<span class="ln">32 </span>         <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="name">e</span><span class="punctuation">.</span><span class="name">errors</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">desc</span><span class="punctuation">.</span><span class="name">in</span><span class="punctuation">(),</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">33 </span>         <span class="keyword">return</span> <span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">34 </span>     <span class="punctuation">}</span>
<span class="ln">35 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">Exception</span> <span class="operator">&amp;</span><span class="punctuation">)</span>
<span class="ln">36 </span>     <span class="punctuation">{</span>
<span class="ln">37 </span>         <span class="name">MessageBox</span><span class="punctuation">((</span><span class="name">HWND</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="literal string">&quot;Exception CORBA&quot;</span><span class="punctuation">,</span><span class="literal string">&quot;Command line&quot;</span><span class="punctuation">,</span><span class="name">MB_ICONSTOP</span><span class="punctuation">);</span>
<span class="ln">38 </span>         <span class="keyword">return</span><span class="punctuation">(</span><span class="name">FALSE</span><span class="punctuation">);</span>
<span class="ln">39 </span>     <span class="punctuation">}</span>
<span class="ln">40 </span>
<span class="ln">41 </span>     <span class="keyword">while</span> <span class="punctuation">(</span><span class="name">GetMessage</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">msg</span><span class="punctuation">,</span> <span class="name builtin">NULL</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">))</span>
<span class="ln">42 </span>     <span class="punctuation">{</span>
<span class="ln">43 </span>         <span class="name">TranslateMessage</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">msg</span><span class="punctuation">);</span>
<span class="ln">44 </span>         <span class="name">DispatchMessage</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">msg</span><span class="punctuation">);</span>
<span class="ln">45 </span>     <span class="punctuation">}</span>
<span class="ln">46 </span>
<span class="ln">47 </span>     <span class="keyword">delete</span> <span class="name">tg</span><span class="punctuation">;</span>
<span class="ln">48 </span>
<span class="ln">49 </span>     <span class="keyword">return</span> <span class="name">msg</span><span class="punctuation">.</span><span class="name">wParam</span><span class="punctuation">;</span>
<span class="ln">50 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 11 : Create the Tango::Util singleton</p>
<p>Line 13-18 : Set parameters for the graphical interface</p>
<p>Line 20 : Initialize Tango device server requesting the display of the
graphical interface</p>
<p>Line 22 : Run the device server</p>
<p>Line 25-39 : Display a message box for all the kinds of error during
Tango device server initialization phase and exit WinMain function.</p>
<p>Line 41-45 : The Windows message loop</p>
<p>Line 47 : Delete the Tango::Util singleton. This class destructor
unregisters the device server from the Tango database.</p>
<p><strong>Remember that if the Tango device server graphical user interface is
used, you must add the Tango windows resource file</strong> <strong>to your
project</strong>.</p>
<p>If you don’t want to use the tango device server graphical user
interface, do not use any parameter in the call of the <em>server_init()</em>
method and do not link your device server with the Tango Windows
resource file.</p>
</div>
<div class="section" id="device-server-as-service">
<h3>Device server as service<a class="headerlink" href="#device-server-as-service" title="Permalink to this headline">¶</a></h3>
<p>With Windows, if you want to have processes which survive to logoff
sequence and/or are automatically started during computer startup
sequence, you have to write them as service. It is possible to write
Tango device server as service. You need to</p>
<ol class="arabic simple">
<li>Write a class which inherits from a pre-written Tango class called
NTService. This class must have a <em>start</em> method.</li>
<li>Write a main function following a predefined skeleton.</li>
</ol>
<div class="section" id="the-service-class">
<h4>The service class<a class="headerlink" href="#the-service-class" title="Permalink to this headline">¶</a></h4>
<p>It must inherits from the <em>NTService</em> class and defines a <em>start</em>
method. The NTService class must be constructed with one argument which
is the device server executable name. The <em>start</em> method has three
arguments which are the number of arguments passed to the method, the
argument list and a reference to an object used to log info in the NT
event system. The first two args must be passed to the Tango::Util::init
method and the last one is used to log error or info messages. The class
definition file looks like</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;ntservice.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword">class</span> <span class="name class">MYService</span><span class="operator">:</span> <span class="keyword">public</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">NTService</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>  <span class="keyword">public</span><span class="operator">:</span>
<span class="ln"> 7 </span>     <span class="name">MYService</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>     <span class="keyword type">void</span> <span class="name function">start</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">**</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">NTEventLogger</span> <span class="operator">*</span><span class="punctuation">);</span>
<span class="ln">10 </span>  <span class="punctuation">};</span>
</pre>
<p>Line 1-2 : Some include files</p>
<p>Line 4 : The MYService class inherits from <em>Tango::NTService</em> class</p>
<p>Line 7 : Constructor with one parameter</p>
<div class="line-block">
<div class="line">Line 9 : The <em>start()</em> method</div>
<div class="line">The class source code looks like</div>
</div>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;myservice.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="name">std</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>  <span class="name">MYService</span><span class="operator">::</span><span class="name">MYService</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="operator">*</span><span class="name">exec_name</span><span class="punctuation">)</span><span class="operator">:</span><span class="name">NTService</span><span class="punctuation">(</span><span class="name">exec_name</span><span class="punctuation">)</span>
<span class="ln"> 7 </span>  <span class="punctuation">{</span>
<span class="ln"> 8 </span>  <span class="punctuation">}</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>  <span class="keyword type">void</span> <span class="name">MYService</span><span class="operator">::</span><span class="name">start</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">**</span><span class="name">argv</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">NTEventLogger</span> <span class="operator">*</span><span class="name">logger</span><span class="punctuation">)</span>
<span class="ln">11 </span>  <span class="punctuation">{</span>
<span class="ln">12 </span>     <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span><span class="punctuation">;</span>
<span class="ln">13 </span>     <span class="keyword">try</span>
<span class="ln">14 </span>     <span class="punctuation">{</span>
<span class="ln">15 </span>        <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">_service</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">16 </span>
<span class="ln">17 </span>        <span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">init</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">);</span>
<span class="ln">18 </span>
<span class="ln">19 </span>        <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_init</span><span class="punctuation">();</span>
<span class="ln">20 </span>
<span class="ln">21 </span>        <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">server_run</span><span class="punctuation">();</span>
<span class="ln">22 </span>     <span class="punctuation">}</span>
<span class="ln">23 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">bad_alloc</span><span class="punctuation">)</span>
<span class="ln">24 </span>     <span class="punctuation">{</span>
<span class="ln">25 </span>        <span class="name">logger</span><span class="operator">-&gt;</span><span class="name">error</span><span class="punctuation">(</span><span class="literal string">&quot;Can't allocate memory to store device object&quot;</span><span class="punctuation">);</span>
<span class="ln">26 </span>     <span class="punctuation">}</span>
<span class="ln">27 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DevFailed</span> <span class="operator">&amp;</span><span class="name">e</span><span class="punctuation">)</span>
<span class="ln">28 </span>     <span class="punctuation">{</span>
<span class="ln">29 </span>        <span class="name">logger</span><span class="operator">-&gt;</span><span class="name">error</span><span class="punctuation">(</span><span class="name">e</span><span class="punctuation">.</span><span class="name">errors</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">desc</span><span class="punctuation">.</span><span class="name">in</span><span class="punctuation">());</span>
<span class="ln">30 </span>     <span class="punctuation">}</span>
<span class="ln">31 </span>     <span class="keyword">catch</span> <span class="punctuation">(</span><span class="name">CORBA</span><span class="operator">::</span><span class="name">Exception</span> <span class="operator">&amp;</span><span class="punctuation">)</span>
<span class="ln">32 </span>     <span class="punctuation">{</span>
<span class="ln">33 </span>        <span class="name">logger</span><span class="operator">-&gt;</span><span class="name">error</span><span class="punctuation">(</span><span class="literal string">&quot;CORBA Exception&quot;</span><span class="punctuation">);</span>
<span class="ln">34 </span>     <span class="punctuation">}</span>
<span class="ln">35 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 6-8 : The MYService class constructor code.</p>
<p>Line 15 : Set to true the <em>_service</em> static variable of the
<em>Tango::Util</em> class.</p>
<p>Line 17-21 : Classical Tango device server startup code</p>
<p>Line 23-34 : Exception management. Please, note that within a service.
it is not possible to print data on a console. This method receives a
reference to a logger object. This object sends all its output to the
Windows event system. It is used to send messages when an exception has
occurred.</p>
</div>
<div class="section" id="the-main-function">
<h4>The main function<a class="headerlink" href="#the-main-function" title="Permalink to this headline">¶</a></h4>
<p>The main function is used to create one instance of the class describing
the service, to check the service option and to run the service. The
code looks like :</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;tango.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 2 </span><span class="comment preproc"></span>  <span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;MYService.h&gt;</span><span class="comment preproc">
</span><span class="ln"> 3 </span><span class="comment preproc"></span>
<span class="ln"> 4 </span>  <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="name">std</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>  <span class="keyword type">int</span> <span class="name function">main</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">*</span><span class="name">argv</span><span class="punctuation">[])</span>
<span class="ln"> 8 </span>  <span class="punctuation">{</span>
<span class="ln"> 9 </span>     <span class="name">MYService</span> <span class="name">service</span><span class="punctuation">(</span><span class="name">argv</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>
<span class="ln">10 </span>
<span class="ln">11 </span>     <span class="keyword type">int</span> <span class="name">ret</span><span class="punctuation">;</span>
<span class="ln">12 </span>     <span class="keyword">if</span> <span class="punctuation">((</span><span class="name">ret</span> <span class="operator">=</span> <span class="name">service</span><span class="punctuation">.</span><span class="name">options</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">))</span> <span class="operator">&lt;=</span> <span class="literal number integer">0</span><span class="punctuation">)</span>
<span class="ln">13 </span>         <span class="keyword">return</span> <span class="name">ret</span><span class="punctuation">;</span>
<span class="ln">14 </span>
<span class="ln">15 </span>     <span class="name">service</span><span class="punctuation">.</span><span class="name">run</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">);</span>
<span class="ln">16 </span>
<span class="ln">17 </span>     <span class="keyword">return</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">18 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 9 : Create one instance of the MYService class with the executable
name as parameter</p>
<p>Line 12 : Check service option with the <em>options()</em> method inherited
from the NTService class.</p>
<p>Line 15 : Run the service. The <em>run()</em> method is inherited from the
NTService class. This method will after some NT initialization sequence
execute the user <em>start()</em> method.</p>
</div>
<div class="section" id="service-options-and-messages">
<h4>Service options and messages<a class="headerlink" href="#service-options-and-messages" title="Permalink to this headline">¶</a></h4>
<p>When a Tango device server is written as a Windows service, it supports
several new options. These option are linked to Windows service usage.</p>
<p>Before it can be used, a service must be installed. A name and a title
is associated to each service. For Tango device server used as service,
the service name is build from the executable name followed by the
underscore character and the instance name. For example, a device server
service executable file named “opc” and started with “fluids” as
instance name, will be named “opc_fluids”. The title string is built
from the service executable name followed by the sentence “Tango device
server” and the instance name between parenthesis. In the previous
example, the service title will be “opc Tango device server (fluids)”.
Once a service is installed, you can configure it with the “Services”
application of the control panel. Services title are displayed by this
application and allow the user to select one specific service. Once a
service is selected, it is possible to start/stop it and to configure
its startup type as manual (with the Services application) or as
automatic. When the automatic mode is chosen, the service starts when
the computer is started. In this case, the service executable code must
resides on the computer local disk.</p>
<p>Tango device server logs message in the Windows event system when the
service is started or stopped. You can see these messages with the
“Event Viewer” application (Start-&gt;Programs-&gt;Administrative tools-&gt;Event
Viewer) and choose the Application events.</p>
<p>The new options are -i, -s, -u, -h and -d.</p>
<ul class="simple">
<li>-i : Install the service</li>
<li>-s : Install the service and choose the automatic startup mode</li>
<li>-u : Un-install the service</li>
<li>-dbg : Run in console mode to debug service. The service must have
been installed prior to used it. The classical -v device server
option can be used with the -d option.</li>
</ul>
<p>On the command line, all these options must be used after the device
server instance name (“opc fluids -i” to install the service, “opc
fluids -u” to un-install the service, “opc fluids -v -d” to debug the
service)</p>
</div>
<div class="section" id="tango-device-server-using-mfc-as-windows-service">
<h4>Tango device server using MFC as Windows service<a class="headerlink" href="#tango-device-server-using-mfc-as-windows-service" title="Permalink to this headline">¶</a></h4>
<p>If your Tango device server uses MFC and must be written as a Windows NT
service, follow these rules :</p>
<ul class="simple">
<li>Don’t forget to add the <em>stdafx.h</em> file as the first file included in
all the source files making the project.</li>
<li>Comment out the definition of VC_EXTRALEAN in the <em>stdafx.h</em> file.</li>
<li>Change the pre-processor definitions, replace _WINDOWS by _CONSOLE</li>
<li>Add the /SUBSYSTEM:CONSOLE option in the linker options window of the
project settings.</li>
<li>Add a call to initialize the MFC (<em>AfxWinInit()</em>) in the service main
function</li>
</ul>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">int</span> <span class="name function">main</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span><span class="keyword type">char</span> <span class="operator">*</span><span class="name">argv</span><span class="punctuation">[])</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>     <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">AfxWinInit</span><span class="punctuation">(</span><span class="operator">::</span><span class="name">GetModuleHandle</span><span class="punctuation">(</span><span class="name builtin">NULL</span><span class="punctuation">),</span><span class="name builtin">NULL</span><span class="punctuation">,</span><span class="operator">::</span><span class="name">GetCommandLine</span><span class="punctuation">(),</span><span class="literal number integer">0</span><span class="punctuation">))</span>
<span class="ln"> 4 </span>     <span class="punctuation">{</span>
<span class="ln"> 5 </span>        <span class="name">cerr</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Can't initialise MFC !&quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>        <span class="keyword">return</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>     <span class="punctuation">}</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>     <span class="name">service</span> <span class="name">serv</span><span class="punctuation">(</span><span class="name">argv</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>
<span class="ln">10 </span>
<span class="ln">11 </span>     <span class="keyword type">int</span> <span class="name">ret</span><span class="punctuation">;</span>
<span class="ln">12 </span>     <span class="keyword">if</span> <span class="punctuation">((</span><span class="name">ret</span> <span class="operator">=</span> <span class="name">serv</span><span class="punctuation">.</span><span class="name">options</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">))</span> <span class="operator">&lt;=</span> <span class="literal number integer">0</span><span class="punctuation">)</span>
<span class="ln">13 </span>          <span class="keyword">return</span> <span class="name">ret</span><span class="punctuation">;</span>
<span class="ln">14 </span>
<span class="ln">15 </span>     <span class="name">serv</span><span class="punctuation">.</span><span class="name">run</span><span class="punctuation">(</span><span class="name">argc</span><span class="punctuation">,</span><span class="name">argv</span><span class="punctuation">);</span>
<span class="ln">16 </span>
<span class="ln">17 </span>     <span class="keyword">return</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">18 </span>  <span class="punctuation">}</span>
</pre>
<p>Line 3 : The MFC classes are initialized with the <em>AfxWinInit()</em>
function call.</p>
</div>
</div>
</div>
<div class="section" id="compiling-linking-and-executing-a-tango-device-server-process">
<h2>Compiling, linking and executing a TANGO device server process<a class="headerlink" href="#compiling-linking-and-executing-a-tango-device-server-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="compiling-and-linking-a-c-device-server">
<span id="compiling-device-server"></span><h3>Compiling and linking a C++ device server<a class="headerlink" href="#compiling-and-linking-a-c-device-server" title="Permalink to this headline">¶</a></h3>
<div class="section" id="on-unix-like-operating-system">
<h4>On UNIX like operating system<a class="headerlink" href="#on-unix-like-operating-system" title="Permalink to this headline">¶</a></h4>
<div class="section" id="supported-development-tools">
<h5>Supported development tools<a class="headerlink" href="#supported-development-tools" title="Permalink to this headline">¶</a></h5>
<p>The supported compiler for Linux is <strong>gcc</strong> release 3.3 and above.
Please, note that to debug a Tango device server running under Linux,
<strong>gdb</strong> release 7 and above is needed in order to correctly handle
threads.</p>
</div>
<div class="section" id="compiling">
<h5>Compiling<a class="headerlink" href="#compiling" title="Permalink to this headline">¶</a></h5>
<p>TANGO for C++ uses omniORB (release 4) <a class="reference internal" href="../../reference/bibliography.html#omniorb" id="id57">[omniORB]</a> as underlying CORBA Object
Request Broker <a class="reference internal" href="../../reference/bibliography.html#omg" id="id58">[OMG]</a> and starting with Tango 8,
the ZMQ library <a class="reference internal" href="../../reference/bibliography.html#zmq" id="id59">[ZMQ]</a>. To compile a TANGO device server, your include search
path must be set to :</p>
<ul class="simple">
<li>The omniORB include directory</li>
<li>The ZMQ include directory</li>
<li>The Tango include directory</li>
<li>Your development directory</li>
</ul>
</div>
<div class="section" id="linking">
<h5>Linking<a class="headerlink" href="#linking" title="Permalink to this headline">¶</a></h5>
<p>To build a running device server process, you need to link your code
with several libraries. Nine of them are always the same whatever the
operating system used is. These nine libraries are:</p>
<ul class="simple">
<li>The Tango libraries (called <strong>libtango</strong> and <strong>liblog4tango</strong>)</li>
<li>Three omniORB package libraries (called <strong>libomniORB4</strong>,
<strong>libomniDynamic4</strong> and <strong>libCOS4)</strong></li>
<li>The omniORB threading library (called <strong>libomnithread</strong>)</li>
<li>The ZMQ library (callled <strong>libzmq</strong>)</li>
</ul>
<p>On top of that, you need additional libraries depending on the operating
system :</p>
<ul class="simple">
<li>For Linux, add the posix thread library (<strong>libpthread</strong>)</li>
</ul>
<p>The following table summarizes the necessary options to compile a Tango
C++ device server. Please, note that starting with Tango 8 and for gcc
release 4.3 and later, some C++11 code has been used. This requires the
compiler option -std=c++0x. Obviously, the options -I and -L must be
updated to reflect your file system organization.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operating system</th>
<th class="head">Compiling option</th>
<th class="head">Linking option</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Linux gcc</td>
<td>-D_REENTRANT -std=c++0x -I..</td>
<td>-L.. -ltango -llog4tango
-lomniORB4 -lomniDynamic4 -lCOS4 -lomnithread -lzmq -lpthread</td>
</tr>
</tbody>
</table>
<p>The following is an example of a Makefile for Linux. Obviously, all the
paths are set to the ESRF file system structure.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span> <span class="comment preproc">#
</span><span class="ln"> 2 </span><span class="comment preproc"></span> <span class="comment preproc"># Makefile to generate a Tango server
</span><span class="ln"> 3 </span><span class="comment preproc"></span> <span class="comment preproc">#
</span><span class="ln"> 4 </span><span class="comment preproc"></span>
<span class="ln"> 5 </span> <span class="name">CC</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">++</span>
<span class="ln"> 6 </span> <span class="name">BIN_DIR</span> <span class="operator">=</span> <span class="name">ubuntu1104</span>
<span class="ln"> 7 </span> <span class="name">TANGO_HOME</span> <span class="operator">=</span> <span class="operator">/</span><span class="name">segfs</span><span class="operator">/</span><span class="name">tango</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span> <span class="name">INCLUDE_DIRS</span> <span class="operator">=</span> <span class="operator">-</span><span class="name">I</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">TANGO_HOME</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">include</span><span class="operator">/</span><span class="error">$</span><span class="punctuation">(</span><span class="name">BIN_DIR</span><span class="punctuation">)</span> <span class="operator">-</span><span class="name">I</span> <span class="punctuation">.</span>
<span class="ln">10 </span>
<span class="ln">11 </span>
<span class="ln">12 </span> <span class="name">LIB_DIRS</span> <span class="operator">=</span> <span class="operator">-</span><span class="name">L</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">TANGO_HOME</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">lib</span><span class="operator">/</span><span class="error">$</span><span class="punctuation">(</span><span class="name">BIN_DIR</span><span class="punctuation">)</span>
<span class="ln">13 </span>
<span class="ln">14 </span>
<span class="ln">15 </span> <span class="name">CXXFLAGS</span> <span class="operator">=</span> <span class="operator">-</span><span class="name">D_REENTRANT</span> <span class="operator">-</span><span class="name">std</span><span class="operator">=</span><span class="name">c</span><span class="operator">++</span><span class="literal number integer">0</span><span class="name">x</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">INCLUDE_DIRS</span><span class="punctuation">)</span>
<span class="ln">16 </span> <span class="name">LFLAGS</span> <span class="operator">=</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">LIB_DIRS</span><span class="punctuation">)</span> <span class="operator">-</span><span class="name">ltango</span> \
<span class="ln">17 </span>                      <span class="operator">-</span><span class="name">llog4tango</span> \
<span class="ln">18 </span>                      <span class="operator">-</span><span class="name">lomniORB4</span> \
<span class="ln">19 </span>                      <span class="operator">-</span><span class="name">lomniDynamic4</span> \
<span class="ln">20 </span>                      <span class="operator">-</span><span class="name">lCOS4</span> \
<span class="ln">21 </span>                      <span class="operator">-</span><span class="name">lomnithread</span> \
<span class="ln">22 </span>                      <span class="operator">-</span><span class="name">lzmq</span> \
<span class="ln">23 </span>                      <span class="operator">-</span><span class="name">lpthread</span>
<span class="ln">24 </span>
<span class="ln">25 </span>
<span class="ln">26 </span> <span class="name">SVC_OBJS</span> <span class="operator">=</span> <span class="name">main</span><span class="punctuation">.</span><span class="name">o</span> \
<span class="ln">27 </span>            <span class="name">ClassFactory</span><span class="punctuation">.</span><span class="name">o</span> \
<span class="ln">28 </span>            <span class="name">SteppermotorClass</span><span class="punctuation">.</span><span class="name">o</span> \
<span class="ln">29 </span>            <span class="name">Steppermotor</span><span class="punctuation">.</span><span class="name">o</span> \
<span class="ln">30 </span>            <span class="name">SteppermotorStateMachine</span><span class="punctuation">.</span><span class="name">o</span>
<span class="ln">31 </span>
<span class="ln">32 </span>
<span class="ln">33 </span> <span class="punctuation">.</span><span class="name label">SUFFIXES</span><span class="punctuation">:</span> <span class="punctuation">.</span><span class="name">o</span> <span class="punctuation">.</span><span class="name">cpp</span>
<span class="ln">34 </span> <span class="punctuation">.</span><span class="name">cpp</span><span class="punctuation">.</span><span class="name label">o</span><span class="punctuation">:</span>
<span class="ln">35 </span>     <span class="error">$</span><span class="punctuation">(</span><span class="name">CC</span><span class="punctuation">)</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">CXXFLAGS</span><span class="punctuation">)</span> <span class="operator">-</span><span class="name">c</span> <span class="error">$</span><span class="operator">&lt;</span>
<span class="ln">36 </span>
<span class="ln">37 </span>
<span class="ln">38 </span> <span class="name label">all</span><span class="punctuation">:</span> <span class="name">StepperMotor</span>
<span class="ln">39 </span>
<span class="ln">40 </span> <span class="name label">StepperMotor</span><span class="punctuation">:</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">SVC_OBJS</span><span class="punctuation">)</span>
<span class="ln">41 </span>     <span class="error">$</span><span class="punctuation">(</span><span class="name">CC</span><span class="punctuation">)</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">SVC_OBJS</span><span class="punctuation">)</span> <span class="operator">-</span><span class="name">o</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">BIN_DIR</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">StepperMotor</span> <span class="error">$</span><span class="punctuation">(</span><span class="name">LFLAGS</span><span class="punctuation">)</span>
<span class="ln">42 </span>
<span class="ln">43 </span> <span class="name label">clean</span><span class="punctuation">:</span>
<span class="ln">44 </span>     <span class="name">rm</span> <span class="operator">-</span><span class="name">f</span> <span class="operator">*</span><span class="punctuation">.</span><span class="name">o</span> <span class="name">core</span>
</pre>
<p>Line 5-7 : Define Makefile macros</p>
<p>Line 9-10 : Set the include file search path</p>
<p>Line 12 : Set the linker library search path</p>
<p>Line 15 : The compiler option setting</p>
<p>Line 16-23 : The linker option setting</p>
<p>Line 26-30 : All the object files needed to build the executable</p>
<p>Line 33-35 : Define rules to generate object files</p>
<p>Line 38 : Define a “all” dependency</p>
<p>Line 40-41 : How to generate the StepperMotor device server executable</p>
<p>Line 43-44 : Define a “clean” dependency</p>
</div>
</div>
<div class="section" id="on-windows-using-visual-studio">
<h4>On Windows using Visual Studio<a class="headerlink" href="#on-windows-using-visual-studio" title="Permalink to this headline">¶</a></h4>
<p>Supported Windows compiler for Tango is Visual Studio 2008 (VC 9),
Visual Studio 2010 (VC10) and Visual Studio 2013 (VC12). Most problems
in building a Windows device server revolve around the /M compiler
switch family. This switch family controls which run-time library names
are embedded in the object files, and consequently which libraries are
used during linking. Attempt to mix and match compiler settings and
libraries can cause link error and even if successful, may produce
undefined run-time behavior.</p>
<p>Selecting the correct /M switch in Visual Studio is done through a
dialog box. To open this dialog box, click on the “Project” menu (once
the correct project is selected in the Solution Explorer window) and
select the “Properties” option. To change the compiler switch open the
“C/C++” tree and select “Code Generation”. The following options are
supported.</p>
<ul class="simple">
<li>Multithreaded = /MT</li>
<li>Multithreaded DLL = /MD</li>
<li>Debug Multithreaded = /MTd</li>
<li>Debug Multithreaded DLL = /MDd</li>
</ul>
<p>Compiling a file with a value of the /M switch family will impose at
link phase the use of libraries also compiled with the same value of the
/M switch family. If you compiled your source code with the /MT option
(Multithreaded), you must link it with libraries also compiled with the
/MT option.</p>
<p>On both 32 or 64 bits computer, omniORB and TANGO relies on the
preprocessor identifier <strong>WIN32</strong> being defined in order to configure
itself. If you build an application using static libraries (option /MT
or /MTd), you must add <strong>_WINSTATIC</strong> to the list of the preprocessor
identifiers. If you build an application using DLL (option /MD or /MDd),
you must add <strong>LOG4TANGO_HAS_DLL</strong> and <strong>TANGO_HAS_DLL</strong> to the list
of preprocessor identifiers.</p>
<p>To build a running device server process, you need to link your code
with several libraries on top of the Windows libraries. These libraries
are:</p>
<ul>
<li><p class="first">The Tango libraries (called <strong>tango.lib</strong> and <strong>log4tango.lib</strong> or
<strong>tangod.lib</strong> and <strong>log4tangod.lib</strong> for debug mode)</p>
</li>
<li><div class="first line-block">
<div class="line">The omniORB package libraries (see next table)</div>
</div>
</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Compile mode</th>
<th class="head">Libraries</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Debug Multithreaded</td>
<td>omniORB4d.lib, omniDynamic4d.lib, omnithreadd.lib
and COS4d.lib</td>
</tr>
<tr class="row-odd"><td>Multithreaded</td>
<td>omniORB4.lib, omniDynamic4.lib, omnithread.lib and
COS4.lib</td>
</tr>
<tr class="row-even"><td>Debug Multithreaded DLL</td>
<td>omniORB420_rtd.lib, omniDynamic420_rtd.lib,
omnithread40_rtd.lib, and COS420_rtd.lib</td>
</tr>
<tr class="row-odd"><td>Multithreaded DLL</td>
<td>omniORB420_rt.lib, omniDynamic420_rt.lib,
omnithread40_rt.lib and COS420_rt.lib</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>The ZMQ library (<strong>zmq.lib</strong> or <strong>zmqd.lib</strong> for debug mode)</li>
<li>Windows network libraries (<strong>mswsock.lib</strong> and <strong>ws2_32.lib</strong>)</li>
<li>Windows graphic library (<strong>comctl32.lib</strong>)</li>
</ul>
<p>To add these libraries in Visual Studio, open the project property pages
dialog box and open the “Link” tree. Select “Input” and add these
library names to the list of library in the “Additional Dependencies”
box.</p>
<p>The “Win32 Debug” or “Win32 Release” configuration that you change
within the Configuration Manager window changes the /M switch compiler.
For instance, if you select a “Win32 Debug” configuration in a non-DLL
project, use the omniORB4d.lib, omniDynamic4d.lib and omnithreadd.lib
libraries plus the tangod.lib, log4tangod.lib and zmqd.lib libraries. If
you select the “Win32 Release” configuration, use the omniORB4.lib,
omniDynamic4.lib and omnithread.lib libraries plus the tango.lib,
log4tango.lib and zmq.lib libraries.</p>
<p><strong>WARNING</strong>: In some cases, the Microsoft Visual Studio wizard used
during project creation generates one include file called <em>Stdafx.h</em>. If
this file itself includes windows.h file, you have to add the
preprocessor macro _WIN32_WINNT and set it to 0x0500.</p>
</div>
</div>
<div class="section" id="running-a-c-device-server">
<h3>Running a C++ device server<a class="headerlink" href="#running-a-c-device-server" title="Permalink to this headline">¶</a></h3>
<p>To run a C++ Tango device server, you must set an environment variable.
This environment variable is called <strong>TANGO_HOST</strong> and has a fixed
syntax which is</p>
<p>TANGO_HOST=&lt;host&gt;:&lt;port&gt;</p>
<p>The host field is the host name where the TANGO database device server
is running. The port field is the port number on which this server is
listening. For instance, a valid syntax is TANGO_HOST=dumela:10000. For
UNIX like operating system, setting environment variable is possible
with the <em>export</em> or <em>setenv</em> command depending on the shell used. For
Windows, setting environment variable is possible with the “Environment”
tab of the “System” application in the control panel.</p>
<p>If you need to start a Tango device server on a pre-defined port (For
Tango database device server or device server without database usage),
you must use one of the underlying ORB option <em>endPoint</em> like</p>
<p>myserver myinstance_name -ORBendPoint giop:tcp::&lt;port number&gt;</p>
</div>
</div>
<div class="section" id="advanced-programming-techniques">
<h2>Advanced programming techniques<a class="headerlink" href="#advanced-programming-techniques" title="Permalink to this headline">¶</a></h2>
<p>The basic techniques for implementing device server pattern are required
by each device server programmer. In certain situations, it is however
necessary to do things out of the ordinary. This chapter will look into
programming techniques which permit the device server serve more than
simply the network.</p>
<div class="section" id="receiving-signal">
<h3>Receiving signal<a class="headerlink" href="#receiving-signal" title="Permalink to this headline">¶</a></h3>
<p>It is <strong>UNSAFE</strong> to use any CORBA call in a signal handler. It is also
UNSAFE to use some system calls in a signal handler. Tango device server
solved this problem by using threads. A specific thread is started to
handle signals. Therefore, every Tango device server is automatically a
threaded process. This allows the programmer to write the code which
must be executed when a signal is received as ordinary code. All device
server threads masks all signals except the specific signal thread which
is permanently waiting for signal. If a signal is sent to a device
server process, only the signal thread will receive it because it is the
single thread which does not mask signals.</p>
<p>Nevertheless, signal management is not trivial and some care have to be
taken. The signal management differs from operating system to operating
system. It is not recommended that you install your own signal routine
using any of the signal routines provided by the operating system calls
or library.</p>
<div class="section" id="using-signal">
<h4>Using signal<a class="headerlink" href="#using-signal" title="Permalink to this headline">¶</a></h4>
<p>It is possible for C++ device server to receive signals from drivers or
other processes. The TDSOM supports receiving signal at two levels: the
device level and the class level. Supporting signal at the device level
means that it is possible to specify interest into receiving signal on a
device basis. This feature is supported via three methods defined in the
DeviceImpl class. These methods are called <em>register_signal</em>,
<em>unregister_signal</em> and s<em>ignal_handler</em>.</p>
<p>The <strong>*register_signal*</strong> method has one parameter which is the signal
number. This method informs the device server signal system that the
device want to be informed when the signal passed as parameter is
received by the process. There is a special case for Linux as explained
in the previous sub-chapter. It is possible to register a signal to be
executed in the a signal handler context (with all its restrictions).
This is done with a second parameter to this <em>register_signal</em> method.
This second parameter is simply a boolean data. If it is true, the
signal_handler will be executed in a signal handler context in the
device server main thread. A default value (false) has been defined for
this parameter.</p>
<p>The <strong>*unregister_signal*</strong> method also have an input parameter which
is the signal number. This method removes the device from the list of
object which should be warned when the signal is received by the
process.</p>
<p>The <strong>*signal_handler*</strong> method is the method which is triggered when a
signal is received if the corresponding <em>register_signal</em> has been
executed. This method is defined as virtual and can be redefined by the
user. It has one input argument which is the signal number.</p>
<p>The same three methods also exist in the DeviceClass class. Their action
and their usage are similar to the DeviceImpl class methods. Installing
a signal at the class level does not mean that all the device belonging
to this class will receive the signal. This only means that the
<em>signal_handler</em> method of the DeviceClass instance will be executed.
This is useful if an action has to be executed once for a class of
devices when a signal is received.</p>
<p>The following code is an example with our stepper motor device server
configured via the database to serve three motors. These motors have the
following names : id04/motor/01, id04/motor/02 and id04/motor/03. The
signal SIGALRM (alarm signal) must be propagated only to the motor
number 2 (id04/motor/02)</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">init_device</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="name">cout</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;StepperMotor::StepperMotor() create motor &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">dev_name</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>      <span class="keyword type">long</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln"> 6 </span>
<span class="ln"> 7 </span>      <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">i</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">&lt;</span> <span class="name">AGSM_MAX_MOTORS</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 8 </span>      <span class="punctuation">{</span>
<span class="ln"> 9 </span>          <span class="name">axis</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">10 </span>          <span class="name">position</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">11 </span>          <span class="name">direction</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">12 </span>      <span class="punctuation">}</span>
<span class="ln">13 </span>
<span class="ln">14 </span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">dev_name</span> <span class="operator">==</span> <span class="literal string">&quot;id04/motor/02&quot;</span><span class="punctuation">)</span>
<span class="ln">15 </span>          <span class="name">register_signal</span><span class="punctuation">(</span><span class="name">SIGALRM</span><span class="punctuation">);</span>
<span class="ln">16 </span>  <span class="punctuation">}</span>
<span class="ln">17 </span>
<span class="ln">18 </span>  <span class="name">StepperMotor</span><span class="operator">::~</span><span class="name">StepperMotor</span><span class="punctuation">()</span>
<span class="ln">19 </span>  <span class="punctuation">{</span>
<span class="ln">20 </span>      <span class="name">unregister_signal</span><span class="punctuation">(</span><span class="name">SIGALRM</span><span class="punctuation">);</span>
<span class="ln">21 </span>  <span class="punctuation">}</span>
<span class="ln">22 </span>
<span class="ln">23 </span>  <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">signal_handler</span><span class="punctuation">(</span><span class="keyword type">long</span> <span class="name">signo</span><span class="punctuation">)</span>
<span class="ln">24 </span>  <span class="punctuation">{</span>
<span class="ln">25 </span>      <span class="name">INFO_STREAM</span> <span class="operator">&lt;&lt;</span> <span class="literal string">&quot;Inside signal handler for signal &quot;</span> <span class="operator">&lt;&lt;</span> <span class="name">signo</span> <span class="operator">&lt;&lt;</span> <span class="name">endl</span><span class="punctuation">;</span>
<span class="ln">26 </span>
<span class="ln">27 </span>  <span class="comment single">//  Do what you want here
</span><span class="ln">28 </span><span class="comment single"></span>
<span class="ln">29 </span>  <span class="punctuation">}</span>
</pre>
<p>The <em>init_device</em> method is modified.</p>
<p>Line 14-15 : The device name is checked and if it is the correct name,
the device is registered in the list of device wanted to receive the
SIGALARM signal.</p>
<p>The destructor is also modified</p>
<p>Line 20 : Unregister the device from the list of devices which should
receives the SIGALRM signal. Note that unregister a signal for a device
which has not previously registered its interest for this signal does
nothing.</p>
<p>The <em>signal_handler</em> method is redefined</p>
<p>Line 25 : Print signal number</p>
<p>Line 27 : Do what you have to do when the signal SIGALRM is received.</p>
<p>If all devices must be warned when the device server process receives
the signal SIGALRM, removes line 14 in the <em>init_device</em> method.</p>
</div>
<div class="section" id="exiting-a-device-server-gracefully">
<h4>Exiting a device server gracefully<a class="headerlink" href="#exiting-a-device-server-gracefully" title="Permalink to this headline">¶</a></h4>
<p>A device server has to exit gracefully by unregistering itself from the
database. The necessary action to gracefully exit are automatically
executed on reception of the following signal :</p>
<ul class="simple">
<li>SIGINT, SIGTERM and SIGQUIT for device server running on Linux</li>
<li>SIGINT, SIGTERM, SIGABRT and SIGBREAK for device server running on
Windows</li>
</ul>
<p>This does not prevents device server to also register interest at device
or class levels for those signals. The user installed <em>signal_handler</em>
method will first be called before the graceful exit.</p>
</div>
</div>
<div class="section" id="inheriting">
<h3>Inheriting<a class="headerlink" href="#inheriting" title="Permalink to this headline">¶</a></h3>
<p>This sub-chapter details how it is possible to inherit from an existing
device pattern implementation. As the device pattern includes more than
a single class, inheriting from an existing device pattern needs some
explanations.</p>
<p>Let us suppose that the existing device pattern implementation is for
devices of class A. This means that classes A and AClass already exists
plus classes for all commands offered by device of class A. One new
device pattern implementation for device of class B must be written with
all the features offered by class A plus some new one. This is easily
done with the inheritance. Writing a device pattern implementation for
device of class B which inherits from device of class A means :</p>
<ul class="simple">
<li>Write the BClass class</li>
<li>Write the B class</li>
<li>Write B class specific commands</li>
<li>Eventually redefine A class commands</li>
</ul>
<p>The miscellaneous code fragments given below detail only what has to be
updated to support device pattern inheritance</p>
<div class="section" id="writing-the-bclass">
<h4>Writing the BClass<a class="headerlink" href="#writing-the-bclass" title="Permalink to this headline">¶</a></h4>
<p>As you can guess, BClass has to inherit from AClass. The
<em>command_factory</em> method must also be adapted.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword">namespace</span> <span class="name">B</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>
<span class="ln"> 4 </span>  <span class="keyword">class</span> <span class="name class">BClass</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name">A</span><span class="operator">::</span><span class="name">AClass</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>  <span class="punctuation">.....</span>
<span class="ln"> 7 </span>  <span class="punctuation">}</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>  <span class="name">BClass</span><span class="operator">::</span><span class="name">command_factory</span><span class="punctuation">()</span>
<span class="ln">10 </span>  <span class="punctuation">{</span>
<span class="ln">11 </span>      <span class="name">A</span><span class="operator">::</span><span class="name">AClass</span><span class="operator">::</span><span class="name">command_factory</span><span class="punctuation">();</span>
<span class="ln">12 </span>
<span class="ln">13 </span>      <span class="name">command_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(....);</span>
<span class="ln">14 </span>  <span class="punctuation">}</span>
<span class="ln">15 </span>
<span class="ln">16 </span>  <span class="punctuation">}</span> <span class="comment multiline">/* End of B namespace */</span>
</pre>
<p>Line 1 : Open the B namespace</p>
<p>Line 4 : BClass inherits from AClass which is defined in the A
namespace.</p>
<p>Line 11 : Only the <em>command_factory</em> method of the BClass will be
called at start-up. To create the AClass commands, the
<em>command_factory</em> method of the AClass must also be executed. This is
the reason of the line</p>
<p>Line 13 : Create BClass commands</p>
</div>
<div class="section" id="writing-the-b-class">
<h4>Writing the B class<a class="headerlink" href="#writing-the-b-class" title="Permalink to this headline">¶</a></h4>
<p>As you can guess, B has to inherits from A.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword">namespace</span> <span class="name">B</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>
<span class="ln"> 4 </span>  <span class="keyword">class</span> <span class="name class">B</span> <span class="operator">:</span> <span class="keyword">public</span> <span class="name label">A</span><span class="punctuation">:</span><span class="name">A</span>
<span class="ln"> 5 </span>  <span class="punctuation">{</span>
<span class="ln"> 6 </span>     <span class="punctuation">.....</span>
<span class="ln"> 7 </span>  <span class="punctuation">};</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>  <span class="name">B</span><span class="operator">::</span><span class="name">B</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceClass</span> <span class="operator">*</span><span class="name">cl</span><span class="punctuation">,</span><span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">)</span><span class="operator">:</span><span class="name">A</span><span class="operator">::</span><span class="name">A</span><span class="punctuation">(</span><span class="name">cl</span><span class="punctuation">,</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln">10 </span>  <span class="punctuation">{</span>
<span class="ln">11 </span>     <span class="punctuation">....</span>
<span class="ln">12 </span>     <span class="name">init_device</span><span class="punctuation">();</span>
<span class="ln">13 </span>  <span class="punctuation">}</span>
<span class="ln">14 </span>
<span class="ln">15 </span>  <span class="keyword type">void</span> <span class="name">B</span><span class="operator">::</span><span class="name">init_device</span><span class="punctuation">()</span>
<span class="ln">16 </span>  <span class="punctuation">{</span>
<span class="ln">17 </span>     <span class="punctuation">....</span>
<span class="ln">18 </span>  <span class="punctuation">}</span>
<span class="ln">19 </span>
<span class="ln">20 </span>  <span class="punctuation">}</span> <span class="comment multiline">/* End of B namespace */</span>
</pre>
<p>Line 1 : Open the B namespace.</p>
<p>Line 4 : B inherits from A which is defined in the A namespace</p>
<p>Line 9 : The B constructor calls the right A constructor</p>
</div>
<div class="section" id="writing-b-class-specific-command">
<h4>Writing B class specific command<a class="headerlink" href="#writing-b-class-specific-command" title="Permalink to this headline">¶</a></h4>
<p>Noting special here. Write these classes as usual</p>
</div>
<div class="section" id="redefining-a-class-command">
<h4>Redefining A class command<a class="headerlink" href="#redefining-a-class-command" title="Permalink to this headline">¶</a></h4>
<p>It is possible to redefine a command which already exist in class A
<strong>only if the command is created</strong> <strong>using the inheritance model</strong> (but
keeping its input and output argument types). The method which really
execute the class A command is a method implemented in the A class. This
method must be defined as <strong>virtual.</strong> In class B, you can redefine the
method executing the command and implement it following the needs of the
B class.</p>
</div>
</div>
<div class="section" id="using-another-device-pattern-implementation-within-the-same-server">
<h3>Using another device pattern implementation within the same server<a class="headerlink" href="#using-another-device-pattern-implementation-within-the-same-server" title="Permalink to this headline">¶</a></h3>
<p>It is often necessary that inside the same device server, a method
executing a command needs a command of another class to be executed. For
instance, a device pattern implementation for a device driven by a
serial line class can use the command offered by a serial line class
embedded within the same device server process. To execute one of the
command (or any other CORBA operations/attributes) of the serial line
class, just call it as a normal client will do by using one instance of
the DeviceProxy class<em>.</em> The ORB will recognize that all the devices
are inside the same process and will execute calls as a local calls. To
create the DeviceProxy class instance, the only thing you need to know
is the name of the device you gave to the serial line device. Retrieving
this could be easily done by a Tango device property. The DeviceProxy
class is fully described in Tango Application Programming Interface
(API) reference WEB pages</p>
</div>
<div class="section" id="device-pipe">
<h3>Device pipe<a class="headerlink" href="#device-pipe" title="Permalink to this headline">¶</a></h3>
<p>What a Tango device pipe is has been defined in the Chapter 3 about
device server model. How you read or write a pipe in a client software
is documented in chapter 4 about the Tango API. In this section, we
describe how you can read/write into/from a device pipe on the server
side (In a Tango class with pipe).</p>
<div class="section" id="client-reading-a-pipe">
<h4>Client reading a pipe<a class="headerlink" href="#client-reading-a-pipe" title="Permalink to this headline">¶</a></h4>
<p>When a client reads a pipe, the following methods are executed in the
Tango class:</p>
<ol class="arabic simple">
<li>The <em>always_executed_hook()</em> method.</li>
<li>A method called <em>is_&lt;pipe_name&gt;_allowed()</em>. The rule of this
method is to allow (or disallow) the next method to be executed. It
is usefull for device with some pipes which can be read only in some
precise conditions. It has one parameter which is the request type
(read or write)</li>
<li>A method called <em>read_&lt;pipe_name&gt;()</em>. The aim of this method is to
store the pipe data in the pipe object. It has one parameter which is
a reference to the Pipe object to be read.</li>
</ol>
<p>The figure <a class="reference internal" href="#id60">6.8</a> is a drawing of these method calls
sequencing for our class StepperMotor with one pipe named DynData.</p>
<div class="figure align-center" id="id74">
<span id="id60"></span><img alt="Read pipe sequencing" src="../../_images/r_pipe.png" />
<p class="caption"><span class="caption-text">Figure 6.8: Read pipe sequencing</span></p>
</div>
<p>The class DynDataPipe is a simple class which follow the same skeleton
from one Tango class to another. Therefore, this class is generated by
the Tango code generator Pogo and the Tango class developper does not
have to modify it. The method <em>is_DynData_allowed()</em> is relatively
simple and in most cases the default code generated by Pogo is enough.
The method <em>read_DynData()</em> is the method on which the Tango class
developper has to concentrate on. The following code is one example of
these two methods.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">bool</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">is_DynData_allowed</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">PipeReqType</span> <span class="name">req</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">get_state</span><span class="punctuation">()</span> <span class="operator">==</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">ON</span><span class="punctuation">)</span>
<span class="ln"> 4 </span>          <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 5 </span>      <span class="keyword">else</span>
<span class="ln"> 6 </span>          <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 7 </span>  <span class="punctuation">}</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>  <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">read_DynData</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Pipe</span> <span class="operator">&amp;</span><span class="name">pipe</span><span class="punctuation">)</span>
<span class="ln">10 </span>  <span class="punctuation">{</span>
<span class="ln">11 </span>      <span class="name">nb_call</span><span class="operator">++</span><span class="punctuation">;</span>
<span class="ln">12 </span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">nb_call</span> <span class="operator">%</span> <span class="literal number integer">2</span> <span class="operator">==</span> <span class="literal number integer">0</span><span class="punctuation">)</span>
<span class="ln">13 </span>      <span class="punctuation">{</span>
<span class="ln">14 </span>          <span class="name">pipe</span><span class="punctuation">.</span><span class="name">set_root_blob_name</span><span class="punctuation">(</span><span class="literal string">&quot;BlobCaseEven&quot;</span><span class="punctuation">);</span>
<span class="ln">15 </span>
<span class="ln">16 </span>          <span class="name">vector</span><span class="operator">&lt;</span><span class="name">string</span><span class="operator">&gt;</span> <span class="name">de_names</span> <span class="punctuation">{</span><span class="literal string">&quot;EvenFirstDE&quot;</span><span class="punctuation">,</span><span class="literal string">&quot;EvenSecondDE&quot;</span><span class="punctuation">};</span>
<span class="ln">17 </span>          <span class="name">pipe</span><span class="punctuation">.</span><span class="name">set_data_elt_names</span><span class="punctuation">(</span><span class="name">de_names</span><span class="punctuation">);</span>
<span class="ln">18 </span>
<span class="ln">19 </span>          <span class="name">dl</span> <span class="operator">=</span> <span class="literal number integer">666</span><span class="punctuation">;</span>
<span class="ln">20 </span>          <span class="name">v_db</span><span class="punctuation">.</span><span class="name">clear</span><span class="punctuation">();</span>
<span class="ln">21 </span>          <span class="name">v_db</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal number float">1.11</span><span class="punctuation">);</span>
<span class="ln">22 </span>          <span class="name">v_db</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal number float">2.22</span><span class="punctuation">);</span>
<span class="ln">23 </span>
<span class="ln">24 </span>          <span class="name">pipe</span> <span class="operator">&lt;&lt;</span> <span class="name">dl</span> <span class="operator">&lt;&lt;</span> <span class="name">v_db</span><span class="punctuation">;</span>
<span class="ln">25 </span>      <span class="punctuation">}</span>
<span class="ln">26 </span>      <span class="keyword">else</span>
<span class="ln">27 </span>      <span class="punctuation">{</span>
<span class="ln">28 </span>          <span class="name">pipe</span><span class="punctuation">.</span><span class="name">set_root_blob_name</span><span class="punctuation">(</span><span class="literal string">&quot;BlobCaseOdd&quot;</span><span class="punctuation">);</span>
<span class="ln">29 </span>
<span class="ln">30 </span>          <span class="name">vector</span><span class="operator">&lt;</span><span class="name">string</span><span class="operator">&gt;</span> <span class="name">de_names</span> <span class="punctuation">{</span><span class="literal string">&quot;OddFirstDE&quot;</span><span class="punctuation">};</span>
<span class="ln">31 </span>          <span class="name">pipe</span><span class="punctuation">.</span><span class="name">set_data_elt_names</span><span class="punctuation">(</span><span class="name">de_names</span><span class="punctuation">);</span>
<span class="ln">32 </span>
<span class="ln">33 </span>          <span class="name">v_str</span><span class="punctuation">.</span><span class="name">clear</span><span class="punctuation">();</span>
<span class="ln">34 </span>          <span class="name">v_str</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;Hola&quot;</span><span class="punctuation">);</span>
<span class="ln">35 </span>          <span class="name">v_str</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;Salut&quot;</span><span class="punctuation">);</span>
<span class="ln">36 </span>          <span class="name">v_str</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="literal string">&quot;Hi&quot;</span><span class="punctuation">);</span>
<span class="ln">37 </span>
<span class="ln">38 </span>          <span class="name">pipe</span> <span class="operator">&lt;&lt;</span> <span class="name">v_str</span><span class="punctuation">;</span>
<span class="ln">39 </span>      <span class="punctuation">}</span>
<span class="ln">40 </span>  <span class="punctuation">}</span>
</pre>
<p>The <em>is_DynData_allowed</em> method is defined between lines 1 and 7. It
is allowed to read or write the pipe only is the device state is ON.
Note that the input parameter req is not used. The parameter allows the
user to know the type of request. The data type PipeReqType is one
enumeration with two possible values which are READ_REQ and WRITE_REQ.</p>
<p>The <em>read_DynData</em> method is defined between lines 9 and 40. If the
number of times this method has been called is even, the pipe contains
two data elements. The first one is named EvenFirstDE and its data is a
long. The second one is named EvenSecondDE and its data is an array of
double. If the number of call is odd, the pipe contains only one data
element. Its name is OddFirstDe and its data is an array of strings.
Data are inserted into the pipe at lines 24 and 38. The variables
nb_call, dl, v_db and v_str are device data member and therefore
declare in the .h file. Refer to pipe section in chapter 3 and to the
API reference documentation (in Tango WEB pages) to learn more on how
you can insert data into a pipe and to know how data are organized
within a pipe.</p>
</div>
<div class="section" id="client-writing-a-pipe">
<h4>Client writing a pipe<a class="headerlink" href="#client-writing-a-pipe" title="Permalink to this headline">¶</a></h4>
<p>When a client writes a pipe, the following methods are executed in the
Tango class:</p>
<ol class="arabic simple">
<li>The <em>always_executed_hook()</em> method.</li>
<li>A method called <em>is_&lt;pipe_name&gt;_allowed()</em>. The rule of this
method is to allow (or disallow) the next method to be executed. It
is usefull for device with some pipes which can be read only in some
precise conditions. It has one parameter which is the request type
(read or write)</li>
<li>A method called <em>write_&lt;pipe_name&gt;()</em>. It has one parameter which
is a reference to the WPipe object to be written. The aim of this
method is to get the data to be written from the WPipe oject and to
write them into the corresponding Tango class objects.</li>
</ol>
<p>The figure <a class="reference internal" href="#id61">6.9</a> is a drawing of these method calls
sequencing for our class StepperMotor with one pipe named DynData.</p>
<div class="figure align-center" id="id75">
<span id="id61"></span><img alt="Write pipe sequencing" src="../../_images/w_pipe.png" />
<p class="caption"><span class="caption-text">Figure 6.9: Write pipe sequencing</span></p>
</div>
<p>The class DynDataPipe is a simple class which follow the same skeleton
from one Tango class to another. Therefore, this class is generated by
the Tango code generator Pogo and the Tango class developper does not
have to modify it. The method <em>is_DynData_allowed()</em> is relatively
simple and in most cases the default code generated by Pogo is enough.
The method <em>write_DynData()</em> is the method on which the Tango class
developper has to concentrate on. The following code is one example of
the <em>write_DynData()</em> method.</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span>  <span class="keyword type">void</span> <span class="name">StepperMotor</span><span class="operator">::</span><span class="name">write_DynData</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">WPipe</span> <span class="operator">&amp;</span><span class="name">w_pipe</span><span class="punctuation">)</span>
<span class="ln">2 </span>  <span class="punctuation">{</span>
<span class="ln">3 </span>     <span class="name">string</span> <span class="name">str</span><span class="punctuation">;</span>
<span class="ln">4 </span>     <span class="name">vector</span><span class="operator">&lt;</span><span class="keyword type">float</span><span class="operator">&gt;</span> <span class="name">v_fl</span><span class="punctuation">;</span>
<span class="ln">5 </span>
<span class="ln">6 </span>     <span class="name">w_pipe</span> <span class="operator">&gt;&gt;</span> <span class="name">str</span> <span class="operator">&gt;&gt;</span> <span class="name">v_fl</span><span class="punctuation">;</span>
<span class="ln">7 </span>     <span class="punctuation">.....</span>
<span class="ln">8 </span>  <span class="punctuation">}</span>
</pre>
<p>In this example, we know that the pipe will always contain a srting
followed by one array of float. On top of that, we are not niterested by
the</p>
<p>data element names. Data are extracted from the pipe at line 6 and are
available for further use starting at line 7. If the content of the pipe
is not a string followed by one array of float, the data extraction line
(6) will throw one exception which will be reported to the client who
has tried to write the pipe. Refer to pipe section in chapter 3 and to
the API reference documentation (in Tango WEB pages) to learn more on
how you can insert data into a pipe and to know how data are organized
within a pipe.</p>
<table class="docutils footnote" frame="void" id="id62" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[1]</a></td><td>The default is_allowed method behavior is to always allows the
command</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id63" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[2]</a></td><td>URL stands for <strong>U</strong>niform <strong>R</strong>esource <strong>L</strong>ocator</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id64" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id39">[3]</a></td><td>The StepperMotor class inherits from the DeviceImpl class and
therefore is a DeviceImpl</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id65" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id52">[4]</a></td><td>The StepperMotorClass inherits from the DeviceClass and therefore is
a DeviceClass</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id66" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id53">[5]</a></td><td>It can also be data declared as object data members or memory
declared as static</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="attribute-alarms.html" class="btn btn-neutral float-right" title="Attribute alarms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="device-server-model.html" class="btn btn-neutral" title="The TANGO device server model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Tango Community, Creative Commons Attribution 4.0 International (CC BY 4.0).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'9.2.5',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>