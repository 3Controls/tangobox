

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Device polling &mdash; Tango Controls 9.2.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Tango Controls 9.2.5 documentation" href="../../index.html"/>
        <link rel="up" title="Device Servers" href="index.html"/>
        <link rel="next" title="Generating events in a device server" href="generating-events.html"/>
        <link rel="prev" title="Forwarded attribute" href="forwarded-attribute.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../contents.html" class="icon icon-home"> Tango Controls
          

          
            
            <img src="../../_static/logo_tangocontrols_white.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                9.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to Tango Controls documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general-guidelines/index.html">General guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../corba.html">10 things you should know about CORBA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-api/index.html">Tango Client</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Device Servers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">Introduction to device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="ds-guideline/index.html">TANGO Device Server Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-server-model.html">The TANGO device server model</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-server-writing.html">Writing a TANGO device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="attribute-alarms.html">Attribute alarms</a></li>
<li class="toctree-l3"><a class="reference internal" href="enumerated-attribute.html">Enumerated attribute</a></li>
<li class="toctree-l3"><a class="reference internal" href="memorized-attribute.html">Memorized attribute</a></li>
<li class="toctree-l3"><a class="reference internal" href="forwarded-attribute.html">Forwarded attribute</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Device polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="generating-events.html">Generating events in a device server</a></li>
<li class="toctree-l3"><a class="reference internal" href="java/index.html">Tango Device in Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="python/index.html">PyTango - a Python binding to Tango</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debugging-and-testing/index.html">Debugging and Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpp-api/index.html">Tango Core C++ Classes Reference Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools-and-extensions/index.html">Tools and Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-howtos/index.html">Tutorials and How-Tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">Tango Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Device Servers</a> &raquo;</li>
        
      <li>Device polling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/development/device-api/device-polling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="device-polling">
<span id="id1"></span><h1>Device polling<a class="headerlink" href="#device-polling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Each tango device server automatically have a separate polling thread
pool. Polling a device means periodically executing command on a device
(or reading device attribute) and storing the results (or the thrown
exception) in a polling buffer. The aim of this polling is threefold :</p>
<ul class="simple">
<li>Speed-up response time for slow device</li>
<li>Get a first-level history of device command output or attribute value</li>
<li>Be the data source for the Tango event system</li>
</ul>
<p>Speeding-up response time is achieved because the command_inout or
read_attribute CORBA operation is able to get its data from the polling
buffer or from the a real access to the device. For “slow” device,
getting the data from the buffer is much faster than accessing the
device. Returning a first-level command output history (or attribute
value history) to a client is possible due to the polling buffer which
is managed as a circular buffer. The history is the contents of this
circular buffer. Obviously, the history depth is limited to the depth of
the circular buffer. The polling is also the data source for the event
system because detecting an event means being able to regularly read the
data, memorize it and declaring that it is an event after some
comparison with older values.</p>
<p>Starting with Tango 9, the default polling algorithm has been modifed.
However, it is still possible to use the polling as it was in Tango
releases prior to release 9. See chaper on polling configuration to get
details on this.</p>
</div>
<div class="section" id="configuring-the-polling-system">
<h2>Configuring the polling system<a class="headerlink" href="#configuring-the-polling-system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuring-what-has-to-be-polled-and-how">
<h3>Configuring what has to be polled and how<a class="headerlink" href="#configuring-what-has-to-be-polled-and-how" title="Permalink to this headline">¶</a></h3>
<p>It is possible to configure the polling in order to poll :</p>
<ul class="simple">
<li>Any command which does not need input parameter</li>
<li>Any attribute</li>
</ul>
<p>Configuring the polling is done by sending command to the device server
administration device automatically implemented in every device server
process. Seven commands are dedicated to this feature. These commands
are</p>
<dl class="docutils">
<dt><strong>AddObjPolling</strong></dt>
<dd>It add a new object (command or attribute) to the list of object(s)
to be polled. It is also with this command that the polling period
is specified.</dd>
<dt><strong>RemObjPolling</strong></dt>
<dd>To remove one object (command or attribute) from the polled
object(s) list</dd>
<dt><strong>UpdObjPollingPeriod</strong></dt>
<dd>Change one object polling period</dd>
<dt><strong>StartPolling</strong></dt>
<dd>Starts polling for the whole process</dd>
<dt><strong>StopPolling</strong></dt>
<dd>Stops polling for the whole process</dd>
<dt><strong>PolledDevice</strong></dt>
<dd>Allow a client to know which device are polled</dd>
<dt><strong>DevPollStatus</strong></dt>
<dd>Allow a client to precisely knows the polling status for a device</dd>
</dl>
<p>All the necessary parameters for the polling configuration are stored in
the Tango database. Therefore, the polling configuration is not lost
after a device server process stop and restart (or after a device server
process crash!!).</p>
<p>It is also possible to automatically poll a command (or an attribute)
without sending command to the device server administration device. This
request some coding (a method call) in the device server software during
the command or attribute creation. In this case, for every devices
supporting this command or this attribute, polling configuration will be
automatically updated in the database and the polling will start
automatically at each device server process startup. It is possible to
stop this behavior on a device basis by sending a RemObjPolling command
to the device server administration device. The following piece of code
shows how the source code should be written.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="keyword type">void</span> <span class="name">DevTestClass</span><span class="operator">::</span><span class="name">command_factory</span><span class="punctuation">()</span>
<span class="ln"> 2 </span>  <span class="punctuation">{</span>
<span class="ln"> 3 </span>  <span class="punctuation">...</span>
<span class="ln"> 4 </span>      <span class="name">command_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">IOStartPoll</span><span class="punctuation">(</span><span class="literal string">&quot;IOStartPoll&quot;</span><span class="punctuation">,</span>
<span class="ln"> 5 </span>                                              <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_VOID</span><span class="punctuation">,</span>
<span class="ln"> 6 </span>                                              <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_LONG</span><span class="punctuation">,</span>
<span class="ln"> 7 </span>                                              <span class="literal string">&quot;Void&quot;</span><span class="punctuation">,</span>
<span class="ln"> 8 </span>                                              <span class="literal string">&quot;Constant number&quot;</span><span class="punctuation">));</span>
<span class="ln"> 9 </span>      <span class="name">command_list</span><span class="punctuation">.</span><span class="name">back</span><span class="punctuation">()</span><span class="operator">-&gt;</span><span class="name">set_polling_period</span><span class="punctuation">(</span><span class="literal number integer">400</span><span class="punctuation">);</span>
<span class="ln">10 </span>  <span class="punctuation">...</span>
<span class="ln">11 </span>  <span class="punctuation">}</span>
<span class="ln">12 </span>
<span class="ln">13 </span>
<span class="ln">14 </span>  <span class="keyword type">void</span> <span class="name">DevTestClass</span><span class="operator">::</span><span class="name">attribute_factory</span><span class="punctuation">(</span><span class="name">vector</span><span class="operator">&lt;</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span> <span class="operator">*&gt;</span> <span class="operator">&amp;</span><span class="name">att_list</span><span class="punctuation">)</span>
<span class="ln">15 </span>  <span class="punctuation">{</span>
<span class="ln">16 </span>  <span class="punctuation">...</span>
<span class="ln">17 </span>      <span class="name">att_list</span><span class="punctuation">.</span><span class="name">push_back</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Attr</span><span class="punctuation">(</span><span class="literal string">&quot;String_attr&quot;</span><span class="punctuation">,</span>
<span class="ln">18 </span>                                          <span class="name">Tango</span><span class="operator">::</span><span class="name">DEV_STRING</span><span class="punctuation">,</span>
<span class="ln">19 </span>                                          <span class="name">Tango</span><span class="operator">::</span><span class="name">READ</span><span class="punctuation">));</span>
<span class="ln">20 </span>      <span class="name">att_list</span><span class="punctuation">.</span><span class="name">back</span><span class="punctuation">()</span><span class="operator">-&gt;</span><span class="name">set_polling_period</span><span class="punctuation">(</span><span class="literal number integer">250</span><span class="punctuation">);</span>
<span class="ln">21 </span>  <span class="punctuation">...</span>
<span class="ln">22 </span>  <span class="punctuation">}</span>
</pre>
<p>A polling period of 400 mS is set for the command called “IOStartPoll”
at line 10 with the <em>set_polling_period</em> method of the Command class.
Therefore, for a device of this class, the polling thread will start
polling its IOStartPoll command at process start-up except if a
RemObjPolling indicating this device and the IOStartPoll command has
already been received by the device server administration device. This
is exactly the same behavior for attribute. The polling period for
attribute called “String_attr” is defined at line 20.</p>
<p>Configuring the polling means defining device attribute/command polling
period. The polling period has to be chosen with care. If reading an
attribute needs 200 mS, there is no point to poll this attribute with a
polling period equal or even below 200 mS. You should also take into
account that some free time has to be foreseen for external request(s)
on the device. On average, for one attribute needing X mS as reading
time, define a polling period which is equal to 1.4 X (280 mS for our
example of one attribute needing 200 mS as reading time). In case the
polling tuning is given to external user, Tango provides a way to define
polling period minimun threshold. This is done using device properties.
These properties are named <em>min_poll_period</em>, <em>cmd_min_poll_period</em>
and <em>attr_min_poll_period</em>. The property min_poll_period (mS)
defined a minimun polling period for the device. The property
cmd_min_poll_period allows the definition of a minimun polling period
for a specific device command. The property attr_min_poll_period
allows the definition of a minimun polling period for one device
attribute. In case these properties are defined, it is not possible to
poll the device command/attribute with a polling period below those
defined by these properties. See Appendix A on device parameter to get a
precise syntax description for these properties.</p>
<p>The Jive (<a class="reference internal" href="../../tools-and-extensions/jive/index.html#jive-manual"><span class="std std-ref">Jive</span></a>) tool also allows a graphical device
polling configuration.</p>
</div>
<div class="section" id="configuring-the-polling-threads-pool">
<h3>Configuring the polling threads pool<a class="headerlink" href="#configuring-the-polling-threads-pool" title="Permalink to this headline">¶</a></h3>
<p>Starting with Tango release 7, a Tango device server process may have
several polling threads managed as a pool. For instance, this could be
usefull in case of devices within the same device server process but
accessed by different hardware channel when one of the channel is not
responding (Thus generating long timeout and de-synchronising the
polling thread). By default, the polling threads pool size is set to 1
and all the polled object(s) are managed by the same thread (idem
polling system in Tango releases older than release 7) . The
configuration of the polling thread pool is done using two properties
associated to the device server administration device. These properties
are named:</p>
<ul class="simple">
<li><em>polling_threads_pool_size</em> defining the maximun number of threads
that you can have in the pool</li>
<li><em>polling_threads_pool_conf</em> defining which threads in the pool
manages which device</li>
</ul>
<p>The granularity of the polling threads pool tuning is the device. You
cannot ask the polling threads pool to have thread number 1 in charge of
attribute <em>att1</em> of device <em>dev1</em> and thread number 2 to be in charge of
<em>att2</em> of the same device <em>dev1</em>.</p>
<p>When you require a new object (command or attribute) to be polled, two
main cases may arrive:</p>
<ol class="arabic simple">
<li>Some polled object(s) belonging to the device are already polled by
one of the polling threads in the pool: There is no new thread
created. The object is simply added to the list of objects to be
polled for the existing thread</li>
<li>There is no thread already created for the device. We have two
sub-cases:<ol class="arabic">
<li>The number of polling threads is less than the
polling_threads_pool_size: A new thread is created and started
to poll the object (command or attribute)</li>
<li>The number of polling threads is already equal to the
polling_threads_pool_size: The software search for the thread
with the smallest number of polled objects and add the new polled
object to this thread</li>
</ol>
</li>
</ol>
<p>Each time the polling threads pool configuration is changed, it is
written in the database using the polling_threads_pool_conf property.
If the behaviour previously described does not fulfill your needs, it is
possible to update the polling_threads_pool_conf property in a
graphical way using the Tango Astor (<a class="reference external" href="http://www.esrf.eu/computing/cs/tango/tango_doc/tools_doc/astor_doc/index.html">ASTOR home page</a>) tool
or manually using the Jive tool <a class="reference internal" href="../../reference/bibliography.html#jive" id="id2">[Jive]</a>. These
changes will be taken into account at the next device server process
start-up. At start-up, the polling threads pool will allways be
configured as required by the polling_threads_pool_conf property. The
syntax used for this property is described in the Reference part of the
<cite>Appendix &lt;A-reference.rst&gt;</cite>. The following window dump is the Astor
tool window which allows polling threads pool management.</p>
<p><img alt="image18" src="../../_images/ThreadsManagement.png" /></p>
<p>In this example, the polling threads pool size to set to 9 but only 4
polling threads are running. Thread 1 is in charge of all polled objects
related to device pv/thread-pool/test-1 and pv/thread-pool/test-2.
Thread 2 is in charge of all polled objects related to device
pv/thread-pool/test-3. Thread 3 is in charge of all polled objects
related to device pv/thread-pool/test-5 anf finally, thread 4 is in
charge of all polled objects for devices pv/thread-pool/test-4,
pv/thread-pool/test-6 and pv/thread-pool/test-7.</p>
<p>It’s also possible to define the polling threads pool size
programmatically in the main function of a device server process using
the <em>Util::set_polling_threads_pool_size()</em> method before the call
to the <em>Util::server_init()</em> method</p>
</div>
<div class="section" id="choosing-polling-algorithm">
<h3>Choosing polling algorithm<a class="headerlink" href="#choosing-polling-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Starting with Tango 9, you can choose between two different polling
algorithm:</p>
<ul class="simple">
<li>The polling as it was in Tango since it has been introduced. This
means:<ul>
<li>For one device, always poll attribute one at a time even if the
polling period is the same (use of read_attribute instead of
read_attributes)</li>
<li>Do not allow the polling thread to be late: If it is the case
(because at the end of polling object 1, the time is greater than
the polling date of object 2), discard polling object and inform
event user by sending one event with error (Polling thread is late
and discard….)</li>
</ul>
</li>
<li>New polling algorithm introduced in Tango 9 as the default one. This
means:<ul>
<li>For one device, poll all attributes with the same polling period
using a single device call (read_attributes)</li>
<li>Allow the polling thread to be late but only if number of late
objects decreases.</li>
</ul>
</li>
</ul>
<p>The advantages of new polling algorithm are</p>
<ol class="arabic simple">
<li>In case of several attributes polled on the same device at the same
period a lower device occupation time by the polling thread (due to a
single read_attributes() call instead of several single
read_attribute() calls)</li>
<li>Less “Polling thread late” errors in the event system in case of
device with non constant response time</li>
</ol>
<p>The drawback is</p>
<ol class="arabic simple">
<li>The loss of attribute individual timing data reported in the polling
thread status</li>
</ol>
<p>It is still possible to return to pre-release 9 polling algorithm. To do
so, you can use the device server process administration device
<em>polling_before_9</em> property by setting it to true. It is also possible
to choose this pre-release 9 algorithm in device server process code in
the main function of the process using the
<em>Util::set_polling_before_9()</em> method.</p>
</div>
</div>
<div class="section" id="reading-data-from-the-polling-buffer">
<h2>Reading data from the polling buffer<a class="headerlink" href="#reading-data-from-the-polling-buffer" title="Permalink to this headline">¶</a></h2>
<p>For a polled command or a polled attribute, a client has three
possibilities to get command result or attribute value (or the thrown
exception) :</p>
<ul class="simple">
<li>From the device itself</li>
<li>From the polling buffer</li>
<li>From the polling buffer first and from the device if data in the
polling buffer are invalid or if the polling is badly configured.</li>
</ul>
<p>The choice is done during the command_inout CORBA operation by
positioning one of the operation parameter. When reading data from the
polling buffer, several error cases are possible</p>
<ul class="simple">
<li>The data in the buffer are not valid any more. Every time data are
requested from the polling buffer, a check is done between the client
request date and the date when the data were stored in the buffer. An
exception is thrown if the delta is greater than the polling period
multiplied by a “too old” factor. This factor has a default value and
is up-datable via a device property. This is detailed in the
reference part of this manual.</li>
<li>The polling is correctly configured but there is no data yet in the
polling buffer.</li>
</ul>
</div>
<div class="section" id="retrieving-command-attribute-result-history">
<h2>Retrieving command/attribute result history<a class="headerlink" href="#retrieving-command-attribute-result-history" title="Permalink to this headline">¶</a></h2>
<p>The polling thread stores the command result or attribute value in
circular buffers. It is possible to retrieve an history of the command
result (or attribute value) from these polling buffers. Obviously the
history is limited by the depth of the circular buffer. For commands, a
CORBA operation called <em>command_inout_history_2</em> allows this
retrieval. The client specifies the command name and the record number
he want to retrieve. For each record, the call returns the date when the
command was executed, the command result or the exception stack in case
of the command failed when it was executed by the polling thread. In
such a case, the exception stack is sent as a structure member and not
as an exception. The same thing is available for attribute. The CORBA
operation name is <em>read_attribute_history_2.</em> For these two calls,
there is no check done between the call date and the record date in
contrary of the call to retrieve the last command result (or attribute
value).</p>
</div>
<div class="section" id="externally-triggered-polling">
<h2>Externally triggered polling<a class="headerlink" href="#externally-triggered-polling" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, rather than polling a command or an attribute regulary with a
fixed period, it is more interesting to manually decides when the
polling must occurs. The Tango polling system also supports this kind of
usage. This is called <em>externally triggered polling</em>. To define one
attribute (or command) as externally triggered, simply set its polling
period to 0. This can be done with the device server administration
device AddObjPolling or UpdObjPollingPeriod command. Once in this mode,
the attribute (or command) polling is triggered with the
<em>trigger_cmd_polling()</em> method (or <em>trigger_attr_polling()</em> method)
of the Util class. The following piece of code shows how this method
could be used for one externally triggered command.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="punctuation">.....</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span>  <span class="name">string</span> <span class="name">ext_polled_cmd</span><span class="punctuation">(</span><span class="literal string">&quot;MyCmd&quot;</span><span class="punctuation">);</span>
<span class="ln"> 4 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">device</span> <span class="operator">=</span> <span class="punctuation">.....;</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">();</span>
<span class="ln"> 7 </span>
<span class="ln"> 8 </span>  <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">trigger_cmd_polling</span><span class="punctuation">(</span><span class="name">device</span><span class="punctuation">,</span><span class="name">ext_polled_cmd</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>  <span class="punctuation">.....</span>
</pre>
<p>line 3 : The externally polled command name</p>
<p>line 4 : The device object</p>
<p>line 8 : Trigger polling of command MyCmd</p>
</div>
<div class="section" id="filling-polling-buffer">
<h2>Filling polling buffer<a class="headerlink" href="#filling-polling-buffer" title="Permalink to this headline">¶</a></h2>
<p>Some hardware to be interfaced already returned an array of pair value,
timestamp. In order to be read with the <em>command_inout_history</em> or
<em>read_attribute_history</em> calls, this array has to be transferred in
the attribute or command polling buffer. This is possible only for
attribute or command configured in the externally triggered polling
mode. Once in externally triggered polling mode, the attribute (or
command) polling buffer is filled with the
<em>fill_cmd_polling_buffer()</em> method (or
<em>fill_attr_polling_buffer()</em> method) of the Util class. For command,
the user uses a template class called <em>TimedCmdData</em> for each element of
the command history. Each element is stored in a stack in one instance
of a template class called <em>CmdHistoryStack.</em> This object is one of the
argument of the fill_cmd_polling_buffer() method. Obviously, the
stack depth cannot be larger than the polling buffer depth. See
[sub:The-device-polling-prop] to learn how the polling buffer depth is
defined. The same way is used for attribute with the <em>TimedAttrData</em> and
<em>AttrHistoryStack</em> template classes. These classes are documented in
<a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id3">[TangoRefMan]</a> . The following piece of code fills the
polling buffer for a command called MyCmd which is already in externally
triggered mode. It returns a DevVarLongArray data type with three
elements. This example is not really something you will find in a real
hardware interface. It is only to demonstrate the
fill_cmd_polling_buffer() method usage. Error management has also
been removed.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="punctuation">....</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">DevVarLongArray</span> <span class="name">dvla_array</span><span class="punctuation">[</span><span class="literal number integer">4</span><span class="punctuation">];</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>  <span class="keyword">for</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">i</span> <span class="operator">&lt;</span> <span class="literal number integer">4</span><span class="punctuation">;</span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 6 </span>  <span class="punctuation">{</span>
<span class="ln"> 7 </span>      <span class="name">dvla_array</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">].</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>      <span class="name">dvla_array</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">][</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">10</span> <span class="operator">+</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln"> 9 </span>      <span class="name">dvla_array</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">][</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">11</span> <span class="operator">+</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln">10 </span>      <span class="name">dvla_array</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">][</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">12</span> <span class="operator">+</span> <span class="name">i</span><span class="punctuation">;</span>
<span class="ln">11 </span>  <span class="punctuation">}</span>
<span class="ln">12 </span>
<span class="ln">13 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">CmdHistoryStack</span><span class="operator">&lt;</span><span class="name">DevVarLongArray</span><span class="operator">&gt;</span> <span class="name">chs</span><span class="punctuation">;</span>
<span class="ln">14 </span>  <span class="name">chs</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">);</span>
<span class="ln">15 </span>
<span class="ln">16 </span>  <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">k</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">k</span> <span class="operator">&lt;</span> <span class="literal number integer">4</span><span class="punctuation">;</span><span class="name">k</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln">17 </span>  <span class="punctuation">{</span>
<span class="ln">18 </span>      <span class="keyword type">time_t</span> <span class="name">when</span> <span class="operator">=</span> <span class="name">time</span><span class="punctuation">(</span><span class="name builtin">NULL</span><span class="punctuation">);</span>
<span class="ln">19 </span>
<span class="ln">20 </span>      <span class="name">Tango</span><span class="operator">::</span><span class="name">TimedCmdData</span><span class="operator">&lt;</span><span class="name">DevVarLongArray</span><span class="operator">&gt;</span> <span class="name">tcd</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name">dvla_array</span><span class="punctuation">[</span><span class="name">k</span><span class="punctuation">],</span><span class="name">when</span><span class="punctuation">);</span>
<span class="ln">21 </span>      <span class="name">chs</span><span class="punctuation">.</span><span class="name">push</span><span class="punctuation">(</span><span class="name">tcd</span><span class="punctuation">);</span>
<span class="ln">22 </span>  <span class="punctuation">}</span>
<span class="ln">23 </span>
<span class="ln">24 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">();</span>
<span class="ln">25 </span>  <span class="name">string</span> <span class="name function">cmd_name</span><span class="punctuation">(</span><span class="literal string">&quot;MyCmd&quot;</span><span class="punctuation">);</span>
<span class="ln">26 </span>  <span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span> <span class="operator">=</span> <span class="punctuation">....;</span>
<span class="ln">27 </span>
<span class="ln">28 </span>  <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">fill_cmd_polling_buffer</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">cmd_name</span><span class="punctuation">,</span><span class="name">chs</span><span class="punctuation">);</span>
<span class="ln">29 </span>
<span class="ln">30 </span>  <span class="punctuation">.....</span>
</pre>
<p>Line 3-11 : Simulate data coming from hardware</p>
<p>Line 13-14 : Create one instance of the CmdHistoryStack class and
reserve space for one history of 4 elements</p>
<p>Line 16-17 : A loop on each history element</p>
<p>Line 18 : Get date (hardware simulation)</p>
<p>Line 20 : Create one instance of the TimedCmdData class with data and
date</p>
<p>Line 21 : Store this command history element in the history stack. The
element order will be the insertion order whatever the element date is.</p>
<p>Line 28 : Fill command polling buffer</p>
<p>After one execution of this code, a command_inout_history() call will
return one history with 4 elements. The first array element of the
oldest history record will have the value 10. The first array element of
the newest history record will have the value 13. A command_inout()
call with the data source parameter set to CACHE will return the newest
history record (ie an array with values 13,14 and 15). A
command_inout() call with the data source parameter set to DEVICE will
return what is coded is the command method. If you execute this code a
second time, a command_inout_history() call will return an history of
8 elements.</p>
<p>The next example fills the polling buffer for an attribute called MyAttr
which is already in externally triggered mode. It is a scalar attribute
of the DevString data type. This example is not really something you
will find in a real hardware interface. It is only to demonstrate the
fill_attr_polling_buffer() method usage with memory management issue.
Error management has also been removed.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>  <span class="punctuation">....</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span>  <span class="name">AttrHistoryStack</span><span class="operator">&lt;</span><span class="name">DevString</span><span class="operator">&gt;</span> <span class="name">ahs</span><span class="punctuation">;</span>
<span class="ln"> 4 </span>  <span class="name">ahs</span><span class="punctuation">.</span><span class="name">length</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">);</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>  <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">k</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span><span class="name">k</span> <span class="operator">&lt;</span> <span class="literal number integer">3</span><span class="punctuation">;</span><span class="name">k</span><span class="operator">++</span><span class="punctuation">)</span>
<span class="ln"> 7 </span>  <span class="punctuation">{</span>
<span class="ln"> 8 </span>      <span class="keyword type">time_t</span> <span class="name">when</span> <span class="operator">=</span> <span class="name">time</span><span class="punctuation">(</span><span class="name builtin">NULL</span><span class="punctuation">);</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>      <span class="name">DevString</span> <span class="operator">*</span><span class="name">ptr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name">DevString</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">];</span>
<span class="ln">11 </span>      <span class="name">ptr</span> <span class="operator">=</span> <span class="name">CORBA</span><span class="operator">::</span><span class="name">string_dup</span><span class="punctuation">(</span><span class="literal string">&quot;Attr history data&quot;</span><span class="punctuation">);</span>
<span class="ln">12 </span>
<span class="ln">13 </span>      <span class="name">TimedAttrData</span><span class="operator">&lt;</span><span class="name">DevString</span><span class="operator">&gt;</span> <span class="name">tad</span><span class="punctuation">(</span><span class="name">ptr</span><span class="punctuation">,</span><span class="name">Tango</span><span class="operator">::</span><span class="name">ATTR_VALID</span><span class="punctuation">,</span><span class="name builtin">true</span><span class="punctuation">,</span><span class="name">when</span><span class="punctuation">);</span>
<span class="ln">14 </span>      <span class="name">ahs</span><span class="punctuation">.</span><span class="name">push</span><span class="punctuation">(</span><span class="name">tad</span><span class="punctuation">);</span>
<span class="ln">15 </span>  <span class="punctuation">}</span>
<span class="ln">16 </span>
<span class="ln">17 </span>  <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span> <span class="operator">*</span><span class="name">tg</span> <span class="operator">=</span> <span class="name">Tango</span><span class="operator">::</span><span class="name">Util</span><span class="operator">::</span><span class="name">instance</span><span class="punctuation">();</span>
<span class="ln">18 </span>  <span class="name">string</span> <span class="name function">attr_name</span><span class="punctuation">(</span><span class="literal string">&quot;MyAttr&quot;</span><span class="punctuation">);</span>
<span class="ln">19 </span>  <span class="name">DeviceImpl</span> <span class="operator">*</span><span class="name">dev</span> <span class="operator">=</span> <span class="punctuation">....;</span>
<span class="ln">20 </span>
<span class="ln">21 </span>  <span class="name">tg</span><span class="operator">-&gt;</span><span class="name">fill_attr_polling_buffer</span><span class="punctuation">(</span><span class="name">dev</span><span class="punctuation">,</span><span class="name">attr_name</span><span class="punctuation">,</span><span class="name">ahs</span><span class="punctuation">);</span>
<span class="ln">22 </span>
<span class="ln">23 </span>  <span class="punctuation">.....</span>
</pre>
<p>Line 3-4 : Create one instance of the AttrHistoryStack class and reserve
space for an history with 3 elements</p>
<p>Line 6-7 : A loop on each history element</p>
<p>Line 8 : Get date (hardware simulation)</p>
<p>Line 10-11 : Create a string. Note that the DevString object is created
on the heap</p>
<p>Line 13 : Create one instance of the TimedAttrData class with data and
date requesting the memory to be released.</p>
<p>Line 14 : Store this attribute history element in the history stack. The
element order will be the insertion order whatever the element date is.</p>
<p>Line 21 : Fill command polling buffer</p>
<p>It is not necessary to return the memory allocated at line 10. The
<em>fill_attr_polling_buffer()</em> method will do it for you.</p>
</div>
<div class="section" id="setting-and-tuning-the-polling-in-a-tango-class">
<h2>Setting and tuning the polling in a Tango class<a class="headerlink" href="#setting-and-tuning-the-polling-in-a-tango-class" title="Permalink to this headline">¶</a></h2>
<p>Even if the polling is normally set and tuned with external tool like
Jive, it is possible to set it directly into the code of a Tango class.
A set of methods belonging to the <em>DeviceImpl</em> class allows the user to
deal with polling. These methods are:</p>
<ul class="simple">
<li><em>is_attribute_polled()</em> and <em>is_command_polled()</em> to check if one
command/attribute is polled</li>
<li><em>get_attribute_poll_period()</em> and <em>get_command_poll_period()</em>
to get polled object polling period</li>
<li><em>poll_attribute()</em> and <em>poll_command()</em> to poll command or
attribute</li>
<li><em>stop_poll_attribute()</em> and <em>stop_poll_command()</em> to stop polling
a command or an attribute</li>
</ul>
<p>The following code snippet is just an exmaple of how these methods could
be used. They are documented in <a class="reference internal" href="../../reference/bibliography.html#tangorefman" id="id4">[TangoRefMan]</a>.</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span>      <span class="keyword type">void</span> <span class="name">MyClass</span><span class="operator">::</span><span class="name">read_attr</span><span class="punctuation">(</span><span class="name">Tango</span><span class="operator">::</span><span class="name">Attribute</span> <span class="operator">&amp;</span><span class="name">attr</span><span class="punctuation">)</span>
<span class="ln"> 2 </span>      <span class="punctuation">{</span>
<span class="ln"> 3 </span>          <span class="punctuation">...</span>
<span class="ln"> 4 </span>          <span class="punctuation">...</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>          <span class="name">string</span> <span class="name">att_name</span><span class="punctuation">(</span><span class="literal string">&quot;SomeAttribute&quot;</span><span class="punctuation">);</span>
<span class="ln"> 7 </span>          <span class="name">string</span> <span class="name function">another_att_name</span><span class="punctuation">(</span><span class="literal string">&quot;AnotherAttribute&quot;</span><span class="punctuation">);</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span>          <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">is_attribute_polled</span><span class="punctuation">(</span><span class="name">att_name</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="name builtin">true</span><span class="punctuation">)</span>
<span class="ln">10 </span>              <span class="name">stop_poll_attribute</span><span class="punctuation">(</span><span class="name">att_name</span><span class="punctuation">);</span>
<span class="ln">11 </span>          <span class="keyword">else</span>
<span class="ln">12 </span>              <span class="name function">poll_attribute</span><span class="punctuation">(</span><span class="name">another_att_name</span><span class="punctuation">,</span><span class="literal number integer">500</span><span class="punctuation">);</span>
<span class="ln">13 </span>
<span class="ln">14 </span>          <span class="punctuation">....</span>
<span class="ln">15 </span>          <span class="punctuation">....</span>
<span class="ln">16 </span>
<span class="ln">17 </span>      <span class="punctuation">}</span>
<span class="ln">18 </span>
<span class="ln">19 </span>  <span class="punctuation">]</span>
</pre>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="generating-events.html" class="btn btn-neutral float-right" title="Generating events in a device server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="forwarded-attribute.html" class="btn btn-neutral" title="Forwarded attribute" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Tango Community, Creative Commons Attribution 4.0 International (CC BY 4.0).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'9.2.5',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>